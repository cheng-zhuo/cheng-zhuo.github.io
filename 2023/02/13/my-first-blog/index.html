<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>my-first-blog | Hexo</title><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="&amp;———————————————————————*&amp;事务代码&#x2F;TRANSACTION CODE     :ZPP005*&amp;程序名称&#x2F;PROGRAM NAME         :ZPPRP005*&amp;程序描述&#x2F;PROGRAM DES.         :*&amp;申请人&#x2F;APPLICANT              :*&amp;amp">
<meta property="og:type" content="article">
<meta property="og:title" content="my-first-blog">
<meta property="og:url" content="http://example.com/2023/02/13/my-first-blog/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="&amp;———————————————————————*&amp;事务代码&#x2F;TRANSACTION CODE     :ZPP005*&amp;程序名称&#x2F;PROGRAM NAME         :ZPPRP005*&amp;程序描述&#x2F;PROGRAM DES.         :*&amp;申请人&#x2F;APPLICANT              :*&amp;amp">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-02-13T05:58:08.000Z">
<meta property="article:modified_time" content="2023-02-13T06:00:53.039Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/02/13/my-first-blog/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'my-first-blog',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2023-02-13 14:00:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">my-first-blog</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-02-13T05:58:08.000Z" title="Created 2023-02-13 13:58:08">2023-02-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-13T06:00:53.039Z" title="Updated 2023-02-13 14:00:53">2023-02-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="my-first-blog"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><em>&amp;———————————————————————</em><br>*&amp;事务代码&#x2F;TRANSACTION CODE     :ZPP005<br>*&amp;程序名称&#x2F;PROGRAM NAME         :ZPPRP005<br>*&amp;程序描述&#x2F;PROGRAM DES.         :<br>*&amp;申请人&#x2F;APPLICANT              :<br>*&amp;申请日期&#x2F;DATE OF APP          :<br>*&amp;开发单位&#x2F;DEVELOPMENT COMPANY  :<br>*&amp;作者&#x2F;AUTHOR                   :<br><em>&amp;———————————————————————</em><br><em>&amp;———————————————————————</em><br>*&amp;变更记录&#x2F;CHANGE RECORD<br>*&amp;DATE              DEVELOPER          REQNO       DESCRIPTIONS<br><em>&amp; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</em></p>
<p><em>&amp;———————————————————————</em></p>
<p>REPORT zpprp005.<br>TABLES:zta_sd002,mkal,zta_pp004,marc,zta_pp007,mara.<br>DATA:ok_code   TYPE sy-ucomm,<br>     zoperator TYPE char12.<br>DATA:stb TYPE TABLE OF stpox.<br>TYPES:BEGIN OF ty_hlb,<br>        matnr    TYPE mara-matnr,<br>        werks    TYPE marc-werks,<br>        matnrhlb TYPE mara-matnr,<br>        maktxhlb TYPE makt-maktx,<br>        zrq      TYPE d,<br>        zsl      TYPE zta_sd002-zxqsl,<br>      END OF ty_hlb.<br>DATA:gt_hlb TYPE TABLE OF ty_hlb,<br>     gs_hlb TYPE ty_hlb.</p>
<p>TYPES:BEGIN OF ty_hlbcol,<br>        werks    TYPE marc-werks,<br>        matnrhlb TYPE mara-matnr,<br>        zrq      TYPE d,<br>        zsl      TYPE zta_sd002-zxqsl,<br>      END OF ty_hlbcol.<br>DATA:gt_hlbcol TYPE TABLE OF ty_hlbcol,<br>     gs_hlbcol TYPE ty_hlbcol.<br>DATA:zhhdbh TYPE zta_pp001_header-zhhd.<br>*&amp;—EXCEL页签名称<br>DATA:zproduction_schedule   TYPE string VALUE ‘生产排产表’,<br>     zbom_list_table        TYPE string VALUE ‘BOM清单’,<br>     znuclear_material_list TYPE string VALUE ‘核料表’.<br>DATA:zadvance TYPE n LENGTH 2.<br>TYPES:BEGIN OF ty_col,<br>        number TYPE i,<br>        col    TYPE string,<br>      END OF ty_col.<br>DATA:gt_col TYPE TABLE OF ty_col,<br>     gs_col TYPE ty_col.<br>DATA:c_numeric_characters(11) TYPE c VALUE ‘1234567890 ‘.<br>TYPES: BEGIN OF ty_alv,<br>         aa TYPE c,<br>       END OF ty_alv.<br>DATA:ls_style TYPE lvc_s_styl,<br>     lt_style TYPE lvc_t_styl.<br>DATA:gt_alv TYPE TABLE OF ty_alv,<br>     gs_alv TYPE ty_alv.<br>DATA:zdatum_sunday   TYPE d,<br>     zdatum_sunday01 TYPE d,<br>     zdatum_first    TYPE d,<br>     zdatum          TYPE d,<br>     zdatum01        TYPE d,<br>     znum            TYPE i,<br>     wotnr           TYPE p,<br>     zname           TYPE char12,<br>     zzdys           TYPE char10,<br>     zzdys01         TYPE char15,<br>     zweek           TYPE scal-week,<br>     znumber         TYPE i.</p>
<p>DATA lt_new_table TYPE REF TO data .<br>DATA ls_new_line    TYPE REF TO data .<br>DATA lt_new_table_bom TYPE REF TO data .<br>DATA ls_new_line_bom    TYPE REF TO data .<br>RANGES: gt_dispo FOR t024d-dispo.<br>DATA lw_dispo LIKE LINE OF gt_dispo.</p>
<p>TYPES:BEGIN OF ty_stas,<br>        matnr TYPE mast-matnr,<br>        werks TYPE mast-werks,<br>        stlan TYPE mast-stlan,<br>        stlnr TYPE mast-stlnr,<br>        stlal TYPE mast-stlal,<br>        stlkn TYPE stas-stlkn,<br>        datuv TYPE stas-datuv,<br>        idnrk TYPE stpo-idnrk,<br>        menge TYPE stpo-menge,<br>      END OF ty_stas.<br>DATA:lt_stas TYPE TABLE OF ty_stas,<br>     ls_stas TYPE ty_stas.<br>DATA:lt_marc TYPE TABLE OF marc,<br>     ls_marc TYPE marc.<br>DATA:p_pv_fullpath TYPE string,<br>     pv_path       TYPE string,<br>     pv_name       TYPE string.<br>DATA:myexcel     TYPE ole2_object,<br>     mysheet     TYPE ole2_object,<br>     mysheet2    TYPE ole2_object,<br>     mysheetname TYPE ole2_object,<br>     mycell      TYPE ole2_object,<br>     mycell1     TYPE ole2_object,<br>     mycell2     TYPE ole2_object,<br>     myworkbook  TYPE ole2_object,<br>     myfont      TYPE ole2_object,<br>     myinterior  TYPE ole2_object,<br>     mypicture   TYPE ole2_object,<br>     myrange     TYPE ole2_object,<br>     myrange2    TYPE ole2_object,<br>     myrange1    TYPE ole2_object,<br>     myentcol    TYPE ole2_object,<br>     myborders   TYPE ole2_object,<br>     myformat    TYPE ole2_object,<br>     mycolumns   TYPE ole2_object,<br>     myrows      TYPE ole2_object,<br>     myprotect   TYPE ole2_object,<br>     mycontents  TYPE ole2_object,<br>     myscenarios TYPE ole2_object.<br>DATA:tab_appl_tab2 TYPE string.<br>TYPES:BEGIN OF ty_mast,<br>        matnr TYPE mast-matnr,<br>        werks TYPE mast-werks,<br>        stlan TYPE mast-stlan,<br>        stlnr TYPE mast-stlnr,<br>        stlal TYPE mast-stlal,<br>        bmeng TYPE stko-bmeng,<br>        datuv TYPE stko-datuv,<br>      END OF ty_mast.<br>DATA:lt_mast TYPE TABLE OF ty_mast,<br>     ls_mast TYPE ty_mast.</p>
<p>DATA: gt_outtab1 TYPE STANDARD TABLE OF alv_t_t2,<br>      gt_outtab2 TYPE STANDARD TABLE OF alv_t_t2,<br>      gt_outtab3 TYPE STANDARD TABLE OF alv_t_t2.</p>
<p>DATA: gr_table1 TYPE REF TO cl_gui_alv_grid,   “CL_SALV_TABLE,<br>      gr_table2 TYPE REF TO cl_gui_alv_grid,   “CL_SALV_TABLE,<br>      gr_table3 TYPE REF TO cl_gui_alv_grid.   “CL_SALV_TABLE.</p>
<p>DATA: container1 TYPE REF TO cl_gui_custom_container,<br>      container2 TYPE REF TO cl_gui_custom_container,<br>      container3 TYPE REF TO cl_gui_custom_container.</p>
<p>*&amp;定义ALV显示的字段列描述等属性<br>DATA: gs_layout   TYPE lvc_s_layo, “LAYOUT属性<br>      gs_layout03 TYPE lvc_s_layo,<br>      gt_fieldcat TYPE TABLE OF lvc_s_fcat, “字段目录列表<br>      gs_fieldcat TYPE lvc_s_fcat,<br>      p_cellcolor TYPE lvc_t_scol,<br>      gs_functxt  TYPE smp_dyntxt,<br>      ref_grid    TYPE REF TO cl_gui_alv_grid,<br>      gt_event    TYPE slis_t_event, “事件存储表<br>      gs_event    TYPE slis_alv_event,<br>      i_ddval     TYPE lvc_t_drop,<br>      wa_ddval    TYPE lvc_s_drop,<br>      zsumsl      TYPE zta_sd002-zxqsl,<br>      zsumweek    TYPE zta_sd002-zxqsl,<br>      zljcy       TYPE zta_sd002-zxqsl.</p>
<ul>
<li>DATENTYPISIERUNG FÜR GRID KLASSE<br>DATA: gt_fieldcatalog1   TYPE lvc_t_fcat,<br>gs_fieldcatalog1   TYPE lvc_s_fcat,<br>gt_fieldcatalog2   TYPE lvc_t_fcat,<br>gs_fieldcatalog2   TYPE lvc_s_fcat,<br>gt_fieldcatalog3   TYPE lvc_t_fcat,<br>gs_fieldcatalog3   TYPE lvc_s_fcat,<br>gt_fieldcatalog_01 TYPE lvc_t_fcat,<br>gs_fieldcatalog_01 TYPE lvc_s_fcat.</li>
</ul>
<p>FIELD-SYMBOLS:<ft_vb>       TYPE STANDARD TABLE,<br>              <fs_vb>,<br>              <ft>,<br>              <ft_bom>,<br>              <ft01>,<br>              <ft02>,<br>              <ft_hlb>,<br>              <fs_vb_excel>,<br>              <ft_ljcy>,<br>              <ft_jhwbl>.<br>FIELD-SYMBOLS:<ft_vb_hlb> TYPE STANDARD TABLE,<br>              <fs_vb_hlb>.<br>FIELD-SYMBOLS:<ft_vb_bom>     TYPE STANDARD TABLE,<br>              <fs_vb_bom>,<br>              <fs_bom_header> TYPE any.<br>DATA lt_new_table_hlb TYPE REF TO data .<br>DATA ls_new_line_hlb    TYPE REF TO data .<br>TYPES:BEGIN OF ty_plaf,<br>        matnr TYPE plaf-matnr,<br>        pwwrk TYPE plaf-pwwrk,<br>        verid TYPE plaf-verid,<br>        gsmng TYPE plaf-gsmng,</p>
<ul>
<li><pre><code>   PLNUM TYPE PLAF-PLNUM,
END OF ty_plaf.
</code></pre>
</li>
</ul>
<p>DATA:lt_plafcol TYPE TABLE OF ty_plaf,<br>     ls_plafcol TYPE ty_plaf.<br>TYPES:BEGIN OF ty_xqsl,<br>        matnr TYPE plaf-matnr,<br>        pwwrk TYPE plaf-pwwrk,<br>        verid TYPE plaf-verid,<br>        psttr TYPE plaf-psttr,<br>        gsmng TYPE plaf-gsmng,</p>
<ul>
<li><pre><code>   PLNUM TYPE PLAF-PLNUM,
END OF ty_xqsl.
</code></pre>
</li>
</ul>
<p>DATA:lt_xqslcol TYPE TABLE OF ty_xqsl,<br>     ls_xqslcol TYPE ty_xqsl.</p>
<p>TYPES:BEGIN OF ty_stpox,<br>        matnrcp  TYPE mara-matnr,<br>        werkscp  TYPE marc-werks,<br>        zstlalcp TYPE mkal-stlal,<br>        zstlancp TYPE mkal-stlan.<br>        INCLUDE STRUCTURE stpox.<br>TYPES:END OF ty_stpox.<br>DATA:gt_stpox TYPE TABLE OF  ty_stpox,<br>     gs_stpox TYPE  ty_stpox.</p>
<p>DATA:znum01col TYPE i,<br>     znum02col TYPE i,<br>     znum03col TYPE i.<br>DATA:znum01row TYPE i,<br>     znum02row TYPE i,<br>     znum03row TYPE i.<br>*&amp;SPWIZARD: FUNCTION CODES FOR TABSTRIP ‘TAB_APPL’<br>CONSTANTS: BEGIN OF c_tab_appl,<br>             tab1 LIKE sy-ucomm VALUE ‘TAB_APPL_FC1’,<br>             tab2 LIKE sy-ucomm VALUE ‘TAB_APPL_FC2’,<br>             tab3 LIKE sy-ucomm VALUE ‘TAB_APPL_FC3’,<br>           END OF c_tab_appl.<br>*&amp;SPWIZARD: DATA FOR TABSTRIP ‘TAB_APPL’<br>CONTROLS:  tab_appl TYPE TABSTRIP.<br>DATA: BEGIN OF g_tab_appl,<br>        subscreen   LIKE sy-dynnr,<br>        prog        LIKE sy-repid VALUE ‘BCALV_GRIDS_ON_TABSTRIPS’,<br>        pressed_tab LIKE sy-ucomm VALUE c_tab_appl-tab1,<br>      END OF g_tab_appl.</p>
<p>TYPES:BEGIN OF ty_excel,<br>        lines TYPE char4000,<br>      END OF ty_excel.<br>DATA:excel_tab01 TYPE TABLE OF ty_excel,<br>     excel_tab02 TYPE TABLE OF ty_excel,<br>     excel_tab03 TYPE TABLE OF ty_excel,<br>     tem_data    TYPE ty_excel.</p>
<ul>
<li>定义分隔符<br>DATA:ld_separator TYPE abap_char1.</li>
</ul>
<p>DATA: g_okcode TYPE syucomm.<br>DATA:lt_plaf TYPE TABLE OF plaf.<br>DATA:ls_plaf TYPE plaf.<br>DATA: lv_mdv01      LIKE mkal-mdv01.<br>*&amp;ALV列属性定义<br>DEFINE macro_add_fieldcat.<br>  CLEAR:gs_fieldcatalog1.<br>  gs_fieldcatalog1-fieldname   &#x3D; &amp;1.”字段名<br>  gs_fieldcatalog1-scrtext_s   &#x3D; &amp;2.”字段描述<br>  gs_fieldcatalog1-scrtext_m   &#x3D; &amp;2.”字段描述<br>  gs_fieldcatalog1-scrtext_l   &#x3D; &amp;2.”字段描述<br>  gs_fieldcatalog1-coltext     &#x3D; &amp;2.”字段描述<br>  gs_fieldcatalog1-ref_table   &#x3D; &amp;3.”参考表<br>  gs_fieldcatalog1-ref_field   &#x3D; &amp;4.”参考字段<br>  gs_fieldcatalog1-edit        &#x3D; &amp;5.”是否可编辑<br>  gs_fieldcatalog1-outputlen    &#x3D; &amp;6.”<br>  gs_fieldcatalog1-f4availabl  &#x3D; &amp;7.”自定义搜索帮助<br>  gs_fieldcatalog1-icon        &#x3D; &amp;8.”是否为图标<br>  gs_fieldcatalog1-qfieldname      &#x3D; &amp;9.”不输出</p>
<p>**&amp;其他个别属性指定<br>*IF &amp;1 &#x3D; ‘MATNR’.<br>**   GS_FIELDCAT-OUTPUTLEN &#x3D; 1000.<br>**   GS_FIELDCAT-NO_ZERO &#x3D; ‘X’.”输出隐藏前导0</p>
<ul>
<li>GS_FIELDCAT-DRDN_FIELD &#x3D; ‘DD_HANDLE1’.”下拉框<br>*ENDIF.<br>*IF GS_FIELDCATALOG1-FIELDNAME(2) &#x3D; ‘ZW’ OR GS_FIELDCATALOG1-FIELDNAME(1) &#x3D; ‘W’.</li>
<li>GS_FIELDCATALOG1-OUTPUTLEN &#x3D; 12.<br>*ENDIF.<br>IF &amp;1 &#x3D; ‘ZSTYLE’ OR &amp;1 &#x3D; ‘BOX’ OR &amp;1 &#x3D; ‘CELLCOLOR’.<br>   gs_fieldcatalog1-no_out &#x3D; ‘X’.”不输出<br>ENDIF.<br>APPEND gs_fieldcatalog1 TO gt_fieldcatalog1.<br>END-OF-DEFINITION.</li>
</ul>
<p><em>&amp;——————————————————————-</em><br>*&amp;选择屏幕<br><em>&amp;——————————————————————-</em><br>*&amp;选择字段<br>SELECTION-SCREEN: BEGIN OF BLOCK b2 WITH FRAME TITLE t4.<br>  SELECT-OPTIONS: s_werks FOR zta_sd002-werks NO-EXTENSION NO INTERVALS OBLIGATORY DEFAULT ‘1100’,”维护状态(隐藏多选，隐藏箭头)<br>                  s_zzdrq FOR sy-datum NO-EXTENSION NO INTERVALS OBLIGATORY DEFAULT sy-datum ,”制单日期<br>                  s_dispo FOR marc-dispo OBLIGATORY MODIF ID slm,<br>                  s_mdv01 FOR mkal-mdv01 MODIF ID slm,”生产线<br>                  s_matnr FOR mara-matnr MODIF ID slm,”物料<br>                  s_advan FOR zadvance NO-EXTENSION NO INTERVALS DEFAULT 4 MODIF ID slm,”提前天数<br>                  s_zuser FOR zta_pp007-zuser OBLIGATORY MODIF ID cmy.”操作人<br>*&amp;添加空行<br>  SELECTION-SCREEN SKIP.<br>  PARAMETERS:p_zlsjl TYPE c AS CHECKBOX USER-COMMAND cfd.”历史记录<br>SELECTION-SCREEN END OF BLOCK b2.<br><em>&amp;———————————————————————</em><br>*&amp;  类的定义<br><em>&amp;———————————————————————</em><br>CLASS lcl_event_receiver DEFINITION.<br>  PUBLIC SECTION.<br>*&amp;—声明添加按钮事件方法<br>    METHODS handle_toolbar<br>      FOR EVENT toolbar OF cl_gui_alv_grid<br>      IMPORTING e_object e_interactive.</p>
<p>*&amp;—声明点击按钮响应事件方法<br>    METHODS handle_command<br>      FOR EVENT user_command OF cl_gui_alv_grid<br>      IMPORTING e_ucomm.</p>
<p>*&amp;—数据改变事件<br>    METHODS : handle_data_changed_finished FOR EVENT data_changed_finished OF cl_gui_alv_grid IMPORTING e_modified et_good_cells.</p>
<p>ENDCLASS. “LCL_EVENT_RECEIVER DEFINITION<br><em>&amp;———————————————————————</em><br>*&amp; 类的实现                            *<br><em>&amp;———————————————————————</em><br>CLASS lcl_event_receiver IMPLEMENTATION.<br>  “ 实现添加按钮事件方法<br>  METHOD handle_toolbar.<br>    “不勾历史记录或今天的历史记录可以创建<br>    IF p_zlsjl &lt;&gt; ‘X’ OR ( p_zlsjl &#x3D; ‘X’ AND s_zzdrq-low &#x3D; sy-datum ).<br>      DATA: ls_toolbar TYPE stb_button.<br>      “按钮之间的间隔<br>      CLEAR: ls_toolbar.<br>      ls_toolbar-butn_type &#x3D; 3. “ 分隔符<br>      APPEND ls_toolbar TO e_object-&gt;mt_toolbar.<br>      “添加按钮<br>      CLEAR: ls_toolbar.<br>      ls_toolbar-function &#x3D; ‘ZBUT01’.    “ 功能码<br>      ls_toolbar-icon &#x3D; icon_okay.  “ 图标名称</p>
<ul>
<li>LS_TOOLBAR-QUICKINFO &#x3D; ‘显示’.   “ 图标的提示信息<br> ls_toolbar-butn_type &#x3D; 0.                               “ 0表示正常按钮<br> ls_toolbar-disabled &#x3D; ‘’.        “ X表示灰色，不可用<br> ls_toolbar-text &#x3D; ‘创建’.       “ 按钮上显示的文本<br> APPEND ls_toolbar TO e_object-&gt;mt_toolbar.<br>ENDIF.<br>  ENDMETHOD.                    “HANDLE_TOOLBAR</li>
</ul>
<p>*&amp;—实现USER-COMMAND 事件方法<br>  METHOD handle_command.<br>    DATA: lr_grid1    TYPE REF TO cl_gui_alv_grid,<br>          rs_selfield TYPE slis_selfield.<br>    DATA: lt_row TYPE lvc_t_row, “方法捕捉的行号<br>          ls_row TYPE lvc_s_row. “对应的行描述<br>    CASE e_ucomm.<br>      WHEN ‘ZBUT01’.<br>*提示对话框<br>        DATA: g_answer TYPE string.<br>        CALL FUNCTION ‘POPUP_TO_CONFIRM’<br>          EXPORTING<br>            text_question  &#x3D; ‘是否创建计划订单?’<br>          IMPORTING<br>            answer         &#x3D; g_answer<br>          EXCEPTIONS<br>            text_not_found &#x3D; 1<br>            OTHERS         &#x3D; 2.<br>        IF g_answer &lt;&gt; ‘1’.<br>          EXIT.<br>        ENDIF.<br>        “———————方法二利用METHOD获取行号————————————</p>
<ul>
<li><pre><code> &amp;---选中数据收集到内表
  CALL METHOD gr_table1-&gt;get_selected_rows
    IMPORTING
      et_index_rows = lt_row.
  PERFORM authotity_check.
  PERFORM frm_bapi.
  PERFORM frm_alv_refresh.&quot;ALV刷新
</code></pre>
</li>
<li><pre><code> WHEN &#39;ZSAVE&#39;.
</code></pre>
</li>
<li><pre><code>   PERFORM frm_zsave.
</code></pre>
  ENDCASE.<br>ENDMETHOD.                    “HANDLE_COMMAND</li>
</ul>
<p>*&amp;—数据改变事件<br>  METHOD handle_data_changed_finished. “数据更改触发事件<br>    IF g_tab_appl-subscreen &#x3D; ‘0101’.<br>      PERFORM frm_data_changed_finished USING e_modified et_good_cells.”搜索帮助可以触发，下拉列表不能触发<br>      PERFORM frm_alv_refresh.”ALV刷新<br>    ELSEIF g_tab_appl-subscreen &#x3D; ‘0102’.<br>      PERFORM frm_data_changed_finishedhlb USING e_modified et_good_cells.”搜索帮助可以触发，下拉列表不能触发<br>      PERFORM frm_alv_refreshhlb.”ALV刷新<br>    ENDIF.<br>  ENDMETHOD.                                              “HANDLE_F4<br>ENDCLASS. “LCL_EVENT_RECEIVER IMPLEMENTATION</p>
<p><em>&amp;—————————————————————–</em><br>*&amp;选择屏幕初始化<br><em>&amp;—————————————————————–</em><br>INITIALIZATION.<br>  t4 &#x3D; ‘选择条件’.<br><em>&amp;—————————————————————–</em><br>*&amp;选择屏幕展示前<br><em>&amp;—————————————————————–</em><br>AT SELECTION-SCREEN OUTPUT.<br>  PERFORM frm_sel_screen_pbo.</p>
<p>AT SELECTION-SCREEN.</p>
<p>AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_dispo-low.<br>  PERFORM frm_request_f4_dispo USING ‘S_DISPO-LOW’.</p>
<p>AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_dispo-high.<br>  PERFORM frm_request_f4_dispo USING ‘S_DISPO-HIGH’.</p>
<p><em>———————————————————————-</em></p>
<ul>
<li><p>START-OF-SELECTION                                                   *<br><em>———————————————————————-</em><br>START-OF-SELECTION.<br>IF s_zzdrq-low &lt; sy-datum AND p_zlsjl &lt;&gt; ‘X’.<br>*&amp;将鼠标聚集到指定字段上<br>  SET CURSOR FIELD ‘P_ZLSJL’.<br>  MESSAGE ‘请勾选历史记录!’ TYPE ‘S’ DISPLAY LIKE ‘E’.<br>  EXIT.<br>ENDIF.</p>
<p>PERFORM frm_check.</p>
</li>
</ul>
<p>*&amp;—动态设置ALV输出字段<br>  PERFORM frm_fieldcat.</p>
<p>  “核料表FIELDCAT<br>  PERFORM frm_fieldcat_hlb.</p>
<p>  “BOM清单FIELDCAT<br>  PERFORM frm_fieldcat_bom.</p>
<p>*&amp;—生产排产表<br>  IF p_zlsjl &#x3D; ‘X’.<br>*&amp;—取保存的历史记录<br>    PERFORM frm_get_data01.</p>
<p>*&amp;—获取BOM清单历史数据<br>    PERFORM frm_get_bom_list_history.</p>
<p>*&amp;—获取核料表历史数据<br>    PERFORM frm_get_hlb_history.<br>  ELSE.<br>*&amp;–获取数据<br>    PERFORM frm_get_data.</p>
<pre><code>&quot;获取核料表数据
PERFORM zhlb_get_data.
</code></pre>
<p>*&amp;—获取bom清单数据<br>    PERFORM get_data_bom.<br>  ENDIF.</p>
<p>*&amp;–ALV展示属性<br>  PERFORM frm_alv_type.<br>*&amp;—END—<br><em>———————————————————————-</em></p>
<ul>
<li><p>END-OF-SELECTION                                                     *<br><em>———————————————————————-</em><br>END-OF-SELECTION.</p>
<p>PERFORM display_grids.</p>
</li>
</ul>
<p><em>&amp;———————————————————————</em><br>*&amp;      FORM  DISPLAY_GRIDS<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li>–&gt;  P1        TEXT</li>
<li>&lt;–  P2        TEXT<br><em>———————————————————————-</em><br>FORM display_grids .<br>  PERFORM grid2_display.<br>  PERFORM display_grid3.</li>
</ul>
<p>  CALL SCREEN 100.<br>ENDFORM.                    “ DISPLAY_GRIDS</p>
<p>*&amp;SPWIZARD: OUTPUT MODULE FOR TS ‘TAB_APPL’. DO NOT CHANGE THIS LINE!<br>*&amp;SPWIZARD: SETS ACTIVE TAB<br>MODULE tab_appl_active_tab_set OUTPUT.</p>
<p>  tab_appl-activetab &#x3D; g_tab_appl-pressed_tab.<br>  CASE g_tab_appl-pressed_tab.<br>    WHEN c_tab_appl-tab1.<br>      g_tab_appl-subscreen &#x3D; ‘0101’.<br>    WHEN c_tab_appl-tab2.<br>      g_tab_appl-subscreen &#x3D; ‘0102’.<br>    WHEN c_tab_appl-tab3.<br>      g_tab_appl-subscreen &#x3D; ‘0103’.<br>    WHEN OTHERS.</p>
<ul>
<li><p>DO NOTHING.<br>ENDCASE.</p>
<p>DATA:excltab TYPE slis_t_extab.<br>“未勾选历史记录或查看今天的历史记录允许上载，展开BOM,保存<br>IF p_zlsjl &#x3D; ‘X’ AND s_zzdrq-low &lt; sy-datum .</p>
</li>
<li><p>&amp;—隐藏按钮<br>  REFRESH excltab.<br>  APPEND ‘ZSAVE’ TO excltab.”灰调或隐藏按钮<br>  APPEND ‘ZUPLOAD’ TO excltab.”灰调或隐藏按钮<br>  APPEND ‘ZBOM’ TO excltab.”灰调或隐藏按钮<br>ENDIF.<br>SET PF-STATUS ‘D0100’ EXCLUDING excltab.</p>
</li>
</ul>
<p>ENDMODULE.</p>
<p>*&amp;SPWIZARD: INPUT MODULE FOR TS ‘TAB_APPL’. DO NOT CHANGE THIS LINE!<br>*&amp;SPWIZARD: GETS ACTIVE TAB<br>MODULE tab_appl_active_tab_get INPUT.<br>  g_okcode &#x3D; sy-ucomm.<br>  CASE g_okcode.<br>    WHEN c_tab_appl-tab1.<br>      g_tab_appl-pressed_tab &#x3D; c_tab_appl-tab1.<br>    WHEN c_tab_appl-tab2.<br>      g_tab_appl-pressed_tab &#x3D; c_tab_appl-tab2.<br>    WHEN c_tab_appl-tab3.<br>      g_tab_appl-pressed_tab &#x3D; c_tab_appl-tab3.<br>    WHEN OTHERS.<br>*&amp;SPWIZARD:      DO NOTHING<br>  ENDCASE.<br>ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp;      MODULE  STATUS_0100  OUTPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE status_0100 OUTPUT.</p>
<p>  SET PF-STATUS ‘D0100’.<br>  SET TITLEBAR ‘GRIDS_ON_TABS’.</p>
<p>ENDMODULE.                 “ STATUS_0100  OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;      MODULE  USER_COMMAND_0100  INPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE user_command_0100 INPUT.</p>
<p>  PERFORM d0100_user_command CHANGING g_okcode.</p>
<p>ENDMODULE.                 “ USER_COMMAND_0100  INPUT<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  D0100_USER_COMMAND<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> &lt;--P_G_OKCODE  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM d0100_user_command  CHANGING c_okcode TYPE sy-ucomm.</p>
<p>  DATA: l_okcode TYPE sy-ucomm.</p>
<p>  l_okcode &#x3D; c_okcode.</p>
<p>  CASE l_okcode.</p>
<pre><code>WHEN &#39;BACK&#39;.
  PERFORM exit_program.
WHEN &#39;EXIT&#39;.
  PERFORM exit_program.
WHEN &#39;CANC&#39;.
  PERFORM exit_program.
</code></pre>
<p>*&amp;—下载EXCEL到本地<br>    WHEN ‘ZDOWNLOAD’.<br>      PERFORM frm_zdownload.<br>*&amp;—EXCEL数据上传到ALV<br>    WHEN ‘ZUPLOAD’.<br>      PERFORM frm_zupload.<br>*&amp;—手工运行，重新根据成品物料展开BOM<br>    WHEN ‘ZBOM’.<br>      DATA:answer      TYPE string.<br>      CLEAR:answer.<br>      CALL FUNCTION ‘POPUP_TO_CONFIRM’<br>        EXPORTING<br>          titlebar              &#x3D; ‘展开BOM’    “1:弹出标题</p>
<ul>
<li><pre><code>    diagnose_object       = &#39; &#39;
    text_question         = &#39;是否重新展开BOM&#39; &quot;2:弹出问题文本
    text_button_1         = &#39;是&#39;      &quot;3:选择按钮文本
    icon_button_1         = &#39; &#39;
    text_button_2         = &#39;否&#39;      &quot;4:选择按钮文本
    icon_button_2         = &#39; &#39;
    default_button        = &#39;1&#39;       &quot;6:默认选择按钮1
    display_cancel_button = &#39;&#39;       &quot;5:取消选择项
</code></pre>
</li>
<li><pre><code>    userdefined_f1_help   = &#39; &#39;
    start_column          = 25        &quot;7:弹出窗口的起始列
    start_row             = 6         &quot;8:弹出窗口的起始行
</code></pre>
</li>
<li><pre><code>    popup_type            =
</code></pre>
</li>
<li><pre><code>    iv_quickinfo_button_1 = &#39; &#39;
</code></pre>
</li>
<li><pre><code>    iv_quickinfo_button_2 = &#39; &#39;
  IMPORTING
    answer                = answer    &quot;9:返回选择
</code></pre>
</li>
<li>TABLES</li>
<li><pre><code>    parameter             =
  EXCEPTIONS
    text_not_found        = 1
    OTHERS                = 2.
IF answer = &#39;2&#39;.
  EXIT.
ENDIF.

PERFORM frm_zbom.
</code></pre>
</li>
</ul>
<p>*&amp;—将三张表的数据全部保存到历史记录表中<br>    WHEN ‘ZSAVE’.<br>      CALL SCREEN 9004 STARTING AT 70 3<br>                        ENDING AT 100 5.”指定弹出屏幕的位置<br>    WHEN OTHERS.<br>      EXIT.<br>  ENDCASE.</p>
<p>ENDFORM.                    “ D0100_USER_COMMAND<br><em>&amp;———————————————————————</em><br>*&amp;      MODULE  DISPLAY_GRID  OUTPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE display_grid1 OUTPUT.</p>
<p>  PERFORM grid1_display.</p>
<p>ENDMODULE.                 “ DISPLAY_GRID  OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  GRID1_DISPLAY<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><p>–&gt;  P1        TEXT</p>
</li>
<li><p>&lt;–  P2        TEXT<br><em>———————————————————————-</em><br>FORM grid1_display .<br>  DATA:pt_exclude TYPE ui_functions,<br>ls_exclude LIKE LINE OF pt_exclude.</p>
</li>
<li><p>CREATE CONTAINER OF TABSTRIP 1<br>IF container1 IS NOT BOUND.<br>  IF cl_salv_table&#x3D;&gt;is_offline( ) EQ if_salv_c_bool_sap&#x3D;&gt;false.<br>CREATE OBJECT container1<br>  EXPORTING<br>    container_name &#x3D; ‘CONTAINER1’.<br>  ENDIF.</p>
</li>
<li><p>CREATE GRID INSTANCE OF TABSTRIP 1<br>  CREATE OBJECT gr_table1<br>EXPORTING<br>  i_parent &#x3D; container1.<br>  IF sy-subrc &lt;&gt; 0.</p>
</li>
<li><p>MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO</p>
</li>
<li><pre><code>         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
</code></pre>
<p>  ENDIF.</p>
</li>
<li><p>SET HANDLE FOR LAYOUT VARIANTS<br>  DATA: ls_variant TYPE disvariant.<br>  ls_variant-report &#x3D; sy-repid.<br>  ls_variant-handle &#x3D; ‘001’.</p>
<p>  DATA: lv_event_receiver TYPE REF TO lcl_event_receiver.<br>  CREATE OBJECT lv_event_receiver.</p>
</li>
</ul>
<p>*&amp;—数据改变<br>    SET HANDLER lv_event_receiver-&gt;handle_data_changed_finished FOR gr_table1.<br>    SET HANDLER lv_event_receiver-&gt;handle_command FOR gr_table1.<br>    SET HANDLER lv_event_receiver-&gt;handle_toolbar FOR gr_table1.<br>    gs_layout-zebra      &#x3D; ‘X’.”斑马线<br>    gs_layout-cwidth_opt &#x3D; ‘X’.”自动适应列宽</p>
<p>*&amp;—隐藏按钮</p>
<ul>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_current_variant. “当前变式</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_save_variant.  “保存变式</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_average.       “平均值</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_load_variant.   “加载变式</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_minimum.        “最大数</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_maximum.         “最小数</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
</ul>
<pre><code>ls_exclude = cl_gui_alv_grid=&gt;mc_fc_maintain_variant. &quot;变式
APPEND ls_exclude TO pt_exclude.
</code></pre>
<ul>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_views.            “视图</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_graph.            “显示图形</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_sum.              “汇总</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_subtot.           “子项目汇总</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_filter.           “过滤</li>
<li>APPEND ls_exclude TO pt_exclude.<br> ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_sort_dsc.          “降序<br> APPEND ls_exclude TO pt_exclude.<br> ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_sort_asc.           “升序<br> APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_check.              “检查</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_detail.             “详细</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_refresh.            “刷新</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_paste_new_row. “粘贴新行</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_copy.          “复制</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_append_row.    “添加行</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_copy_row.      “复制行</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_insert_row.    “插入行</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_delete_row.    “删除行</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_move_row.</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_cut.           “剪切</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_paste.         “粘贴</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
<li>ls_exclude &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_fc_loc_undo.          “撤销</li>
<li>APPEND ls_exclude TO pt_exclude.</li>
</ul>
<pre><code>CALL METHOD gr_table1-&gt;set_table_for_first_display
  EXPORTING
    is_layout            = gs_layout
    is_variant           = ls_variant
    it_toolbar_excluding = pt_exclude &quot;隐藏的工具栏
    i_save               = &#39;A&#39;
  CHANGING
    it_fieldcatalog      = gt_fieldcatalog1
    it_outtab            = &lt;ft_vb&gt;.

&quot;回车事件
CALL METHOD gr_table1-&gt;register_edit_event
  EXPORTING
    i_event_id = cl_gui_alv_grid=&gt;mc_evt_enter
  EXCEPTIONS
    error      = 1
    OTHERS     = 2.
</code></pre>
<p>*&amp;—失去焦点触发<br>    CALL METHOD gr_table1-&gt;register_edit_event<br>      EXPORTING<br>        i_event_id &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_evt_modified<br>      EXCEPTIONS<br>        error      &#x3D; 1<br>        OTHERS     &#x3D; 2.<br>    IF sy-subrc &lt;&gt; 0.<br>      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno<br>      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.<br>    ENDIF.<br>  ELSE.<br>    CALL METHOD gr_table1-&gt;refresh_table_display.<br>  ENDIF.</p>
<p>ENDFORM.                    “ GRID1_DISPLAY<br><em>&amp;———————————————————————</em><br>*&amp;      MODULE  DISPLAY_GRID2  OUTPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE display_grid2 OUTPUT.</p>
<ul>
<li>PERFORM grid2_display.<br>ENDMODULE.                 “ DISPLAY_GRID2  OUTPUT</li>
</ul>
<p><em>&amp;———————————————————————</em><br>*&amp;      FORM  GRID2_DISPLAY<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><p>–&gt;  P1        TEXT</p>
</li>
<li><p>&lt;–  P2        TEXT<br><em>———————————————————————-</em><br>FORM grid2_display .</p>
</li>
<li><p>CLEAR:CONTAINER2,GR_TABLE2.<br>  IF container2 IS NOT BOUND.<br> IF cl_salv_table&#x3D;&gt;is_offline( ) EQ if_salv_c_bool_sap&#x3D;&gt;false.<br>   CREATE OBJECT container2<br> EXPORTING<br>   container_name &#x3D; ‘CONTAINER2’.<br> ENDIF.</p>
<p> CREATE OBJECT gr_table2<br>   EXPORTING<br> i_parent &#x3D; container2.</p>
</li>
<li><p>LAYOUT VARIANT OF TABSTRIP 2<br>  DATA: ls_variant TYPE disvariant.<br>  ls_variant-report &#x3D; sy-repid.<br>  ls_variant-handle &#x3D; ‘002’.</p>
<p>  DATA: lv_event_receiver TYPE REF TO lcl_event_receiver.<br>  CREATE OBJECT lv_event_receiver.</p>
</li>
</ul>
<p>*&amp;—数据改变<br>    SET HANDLER lv_event_receiver-&gt;handle_data_changed_finished FOR gr_table2.<br>    gs_layout-ctab_fname   &#x3D; ‘CELLCOLOR’.<br>    gs_layout-cwidth_opt   &#x3D; ‘X’.<br>    CALL METHOD gr_table2-&gt;set_table_for_first_display<br>      EXPORTING<br>        is_layout       &#x3D; gs_layout<br>        is_variant      &#x3D; ls_variant<br>        i_save          &#x3D; ‘A’<br>      CHANGING<br>        it_fieldcatalog &#x3D; gt_fieldcatalog_01<br>        it_outtab       &#x3D; <ft_vb_hlb>.</p>
<pre><code>&quot;回车事件
CALL METHOD gr_table2-&gt;register_edit_event
  EXPORTING
    i_event_id = cl_gui_alv_grid=&gt;mc_evt_enter
  EXCEPTIONS
    error      = 1
    OTHERS     = 2.
</code></pre>
<p>*&amp;—失去焦点触发<br>    CALL METHOD gr_table2-&gt;register_edit_event<br>      EXPORTING<br>        i_event_id &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_evt_modified<br>      EXCEPTIONS<br>        error      &#x3D; 1<br>        OTHERS     &#x3D; 2.<br>    IF sy-subrc &lt;&gt; 0.<br>      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno<br>      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.<br>    ENDIF.<br>  ELSE.<br>    CALL METHOD gr_table2-&gt;refresh_table_display.</p>
<ul>
<li>PERFORM FRM_ALV_REFRESHHLB.”ALV刷新</li>
</ul>
<p>  ENDIF.</p>
<p>ENDFORM.                    “ GRID2_DISPLAY<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  SET_COLUMNS_TECHNICAL<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> --&gt;P_LR_COLUMNS  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM set_columns_technical  USING   ir_columns TYPE REF TO cl_salv_columns.</p>
<p>  DATA: lr_column TYPE REF TO cl_salv_column.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘MANDT’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘FLOAT_FI’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘STRING_F’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘XSTRING’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘INT_FIEL’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘HEX_FIEL’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘DROPDOWN’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>  TRY.<br>      lr_column &#x3D; ir_columns-&gt;get_column( ‘TAB_INDEX’ ).<br>      lr_column-&gt;set_technical( if_salv_c_bool_sap&#x3D;&gt;true ).<br>    CATCH cx_salv_not_found.                            “#EC NO_HANDLER<br>  ENDTRY.</p>
<p>ENDFORM.                    “ SET_COLUMNS_TECHNICAL<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  EXIT_PROGRAM<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><p>–&gt;  P1        TEXT</p>
</li>
<li><p>&lt;–  P2        TEXT<br><em>———————————————————————-</em><br>FORM exit_program .</p>
</li>
<li><p>GRIDINSTANZEN ABBAUEN….</p>
<p>CLEAR g_okcode.</p>
<p>CALL METHOD container1-&gt;free.<br>IF container2 IS NOT INITIAL.<br>  CALL METHOD container2-&gt;free.<br>ENDIF.<br>IF container3 IS NOT INITIAL.<br>  CALL METHOD container3-&gt;free.<br>ENDIF.</p>
<p>FREE gr_table1.<br>IF gr_table2 IS NOT INITIAL.<br>  FREE gr_table2.<br>ENDIF.<br>IF gr_table3 IS NOT INITIAL.<br>  FREE gr_table3.<br>ENDIF.</p>
<p>SET SCREEN 0.<br>LEAVE SCREEN.</p>
</li>
</ul>
<p>ENDFORM.                    “ EXIT_PROGRAM<br><em>&amp;———————————————————————</em><br>*&amp;      MODULE  USER_COMMAND_EXIT  INPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE user_command_exit INPUT.</p>
<p>  g_okcode &#x3D; g_okcode.<br>  CLEAR g_okcode.</p>
<p>  CASE g_okcode.<br>    WHEN ‘BACK’.<br>      PERFORM exit_program.<br>    WHEN ‘EXIT’.<br>      PERFORM exit_program.<br>    WHEN ‘CANC’.<br>      PERFORM exit_program.<br>  ENDCASE.<br>  LEAVE PROGRAM.<br>ENDMODULE.                 “ USER_COMMAND_EXIT  INPUT<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_FIELDCAT<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_fieldcat .<br>  CLEAR:gt_fieldcatalog1,gs_fieldcatalog1,gt_fieldcatalog2,gs_fieldcatalog2,gt_fieldcatalog3,gs_fieldcatalog3.<br>  macro_add_fieldcat:<br>  ‘ICON’ ‘指示灯’ space space space 4 space ‘X’ space,<br>  ‘MSG’  ‘消息’ ‘BAPIRETURN1’ ‘MESSAGE’ space 10 space space space,<br>  ‘STLAL’ ‘备选’ ‘MKAL’ ‘STLAL’ ‘’ space 10 space ‘X’,<br>  ‘STLAN’ ‘用途’ ‘MKAL’ ‘STLAN’ ‘’ space 10 space ‘X’,<br>  ‘ZZDRQ’ ‘制单日期’ ‘ZTA_PP004’ ‘ZZDRQ’ ‘’ space 10 space space,<br>  ‘WERKS’ ‘工厂’ ‘MARC’ ‘WERKS’ space space space space space,<br>  ‘MATNR’ ‘物料编码’ ‘MARA’ ‘MATNR’ ‘’ 10 space space space,<br>  ‘MAKTX’ ‘物料描述’ ‘MAKT’ ‘MAKTX’ ‘’ 20 space space space,<br>  ‘DISPO’ ‘MRP控制者’ ‘MARC’ ‘DISPO’ ‘’ space space space space,<br>  ‘DSNAM’ ‘MRP控制者描述’ ‘T024D’ ‘DSNAM’ ‘’ space space space space,<br>  ‘VERID’ ‘生产版本’ ‘PLAF’ ‘VERID’ ‘’ 10 space space space,<br>  ‘TEXT1’ ‘生产版本描述’ ‘MKAL’ ‘TEXT1’ ‘’ 20 space space space,<br>  ‘MDV01’ ‘生产线’ ‘MKAL’ ‘MDV01’ ‘’ 10 space space space,<br>  ‘STKTX’ ‘BOM版本’ ‘STKO’ ‘STKTX’ ‘’ 20 space space space,</p>
<ul>
<li>‘ZBBFA’ ‘BOM版本方案’ ‘ZTA_SD001’ ‘ZBBFA’ ‘’ 20 space space space,<br>  ‘ZCBYXJ’ ‘成本优先级’ ‘ZTA_SD001’ ‘ZCBYXJ’ ‘’ 10 space space space,<br>  ‘ZSFKFH’ ‘是否可发货’ ‘ZTA_PP004’ ‘ZSFKFH’ ‘’ 10 space space space,<br>  ‘MTSTB’ ‘产品状态’ ‘STKO’ ‘ZCPZT’ ‘’ 10 space space space,<br>  ‘ZJHBZ’ ‘计划备注’ ‘ZTA_PP004’ ‘ZJHBZ’ ‘’ 10 space space space,</li>
<li>‘ZJZDRYQSL’ ‘截止当日逾期数量’ ‘ZTA_PP001_ITEMDE’ ‘ZBDMNG’ ‘X’ 10 SPACE SPACE ‘’,<br>  ‘ZJZDRYQSL’ ‘截止当日逾期数量’ ‘MAKT’ ‘MAKTX’ ‘’ 10 space space ‘’.</li>
</ul>
<p>*&amp;—获取当前日期周的周日<br>  CLEAR:zdatum_sunday,zdatum.<br>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING</p>
<ul>
<li><pre><code>WEEK   =
</code></pre>
</li>
<li><pre><code>MONDAY = ZDATUM_FIRST
sunday = zdatum_sunday.
</code></pre>
<p>CLEAR:znum.<br>znum &#x3D; zdatum_sunday - sy-datum + 7.<br>zdatum &#x3D; sy-datum.</p>
<p>DO znum TIMES.<br>  zdatum &#x3D; zdatum + 1.<br>  CLEAR:wotnr.<br>  “判断输入日期是周几<br>  CALL FUNCTION ‘DAY_IN_WEEK’<br>EXPORTING<br>  datum &#x3D; zdatum<br>IMPORTING<br>  wotnr &#x3D; wotnr.<br>  CASE wotnr.<br>WHEN 1.<br>  zname &#x3D; ‘周一’.<br>WHEN 2.<br>  zname &#x3D; ‘周二’.<br>WHEN 3.<br>  zname &#x3D; ‘周三’.<br>WHEN 4.<br>  zname &#x3D; ‘周四’.<br>WHEN 5.<br>  zname &#x3D; ‘周五’.<br>WHEN 6.<br>  zname &#x3D; ‘周六’.<br>WHEN 7.<br>  zname &#x3D; ‘周日’.<br>WHEN OTHERS.<br>  ENDCASE.</p>
<p>  zname &#x3D; zname &amp;&amp; ‘-‘ &amp;&amp; zdatum.<br>  zzdys &#x3D; ‘Z’ &amp;&amp; zdatum.<br>  macro_add_fieldcat:<br>  “‘ZTA_SD002’ ‘ZXQSL’<br>  zzdys zname ‘MAKT’ ‘MAKTX’ ‘’ 12 space ‘’ ‘’.<br>ENDDO.</p>
<p>zdatum &#x3D; zdatum - 13.”周一日期</p>
</li>
</ul>
<p>*&amp;—前两周加逾期数量的汇总列<br>  “查看日期在当前年度第几周<br>  CLEAR:zweek.<br>  CALL FUNCTION ‘DATE_GET_WEEK’<br>    EXPORTING<br>      date         &#x3D; zdatum<br>    IMPORTING<br>      week         &#x3D; zweek<br>    EXCEPTIONS<br>      date_invalid &#x3D; 1<br>      OTHERS       &#x3D; 2.</p>
<p>  zname &#x3D; ‘W’ &amp;&amp; zweek+4(2) &amp;&amp; ‘、’.</p>
<p>  zdatum &#x3D; zdatum + 7.”下周一<br>  CLEAR:zweek.<br>  CALL FUNCTION ‘DATE_GET_WEEK’<br>    EXPORTING<br>      date         &#x3D; zdatum<br>    IMPORTING<br>      week         &#x3D; zweek<br>    EXCEPTIONS<br>      date_invalid &#x3D; 1<br>      OTHERS       &#x3D; 2.<br>  zname &#x3D; zname &amp;&amp; zweek+4(2).</p>
<p>  zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>  macro_add_fieldcat:<br>  zzdys zname ‘MAKT’ ‘MAKTX’ ‘’ 12 space ‘’ ‘’.<br>  zdatum &#x3D; zdatum + 7.</p>
<p>  DO 3 TIMES.<br>*&amp;—查看日期在当前年度第几周<br>    CLEAR:zweek.<br>    CALL FUNCTION ‘DATE_GET_WEEK’<br>      EXPORTING<br>        date         &#x3D; zdatum<br>      IMPORTING<br>        week         &#x3D; zweek<br>      EXCEPTIONS<br>        date_invalid &#x3D; 1<br>        OTHERS       &#x3D; 2.<br>    IF sy-subrc &lt;&gt; 0.</p>
<ul>
<li><p>IMPLEMENT SUITABLE ERROR HANDLING HERE<br>  ENDIF.</p>
<p>  zname &#x3D; ‘W’ &amp;&amp; zweek+4(2) &amp;&amp; ‘-‘ &amp;&amp; zdatum.<br>  zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>  macro_add_fieldcat:<br>  zzdys zname ‘MAKT’ ‘MAKTX’ ‘’ 12 space ‘’ ‘’.<br>  zdatum &#x3D; zdatum + 7.<br>ENDDO.</p>
<p>macro_add_fieldcat:<br>  ‘ZJHZL’ ‘计划总量’ ‘MAKT’ ‘MAKTX’ ‘’ space space space ‘’,<br>  ‘ZYFPL’ ‘已分配量’ ‘MAKT’ ‘MAKTX’ ‘’ space space space ‘’,<br>  ‘ZLJCY’ ‘累计差异’ ‘MAKT’ ‘MAKTX’ ‘’ space space space ‘’,<br>  ‘ZSTYLE’ ‘’ ‘ZSTYLE’ ‘ZSTYLE’ ‘’ space space space space,<br> ‘CELLCOLOR’ ‘’ ‘ZCELLCOLOR’ ‘CELLCOLOR’ ‘’ space space space space.</p>
</li>
</ul>
<p>*&amp;—生成动态内表<br>  CALL METHOD cl_alv_table_create&#x3D;&gt;create_dynamic_table<br>    EXPORTING</p>
<ul>
<li><pre><code>I_STYLE_TABLE             =
it_fieldcatalog           = gt_fieldcatalog1   &quot;输入FIELDCATALOG 将返回一个动态内表
</code></pre>
</li>
<li><pre><code>I_LENGTH_IN_BYTE          =
</code></pre>
<p>  IMPORTING<br>ep_table                  &#x3D; lt_new_table  “获取返回的动态内表 (类)</p>
</li>
<li><pre><code>E_STYLE_FNAME             =
</code></pre>
<p>  EXCEPTIONS<br>generate_subpool_dir_full &#x3D; 1<br>OTHERS                    &#x3D; 2.<br>IF sy-subrc &lt;&gt; 0.<br>  EXIT.<br>ENDIF.</p>
<p>ASSIGN lt_new_table-&gt;* TO <ft_vb> .     “LT_NEW_TABLE 中的所有都被指向<FT_VB>（动态内表）<br>CREATE DATA ls_new_line LIKE LINE OF <ft_vb> .<br>ASSIGN ls_new_line-&gt;* TO <fs_vb> .      “LS_NEW_LINE 中的所有都被指向<FS_VB> （动态内表结构）</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_GET_DATA<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_get_data .<br>  SELECT mkal<del>matnr,<br>         mkal</del>werks,<br>         mkal<del>verid,<br>         mkal</del>text1,<br>         mkal<del>mdv01,<br>         mkal</del>stlan,<br>         mkal~stlal,</p>
<pre><code>     makt~maktx
FROM mkal
LEFT JOIN makt ON makt~matnr = mkal~matnr AND makt~spras = @sy-langu
INTO TABLE @DATA(lt_mkal)
WHERE mkal~werks IN @s_werks
AND   mkal~mdv01 IN @s_mdv01 AND mkal~mdv01 &lt;&gt; &#39;11004010&#39;
AND   mkal~stlan = &#39;1&#39;
AND   mkal~mksp = &#39;&#39;
AND   mkal~matnr IN @s_matnr.
</code></pre>
<p>  SORT:lt_mkal BY werks matnr verid.</p>
<p>  IF lt_mkal IS NOT INITIAL.<br>*&amp;—判断计划订单是否存在<br>    SELECT plnum,”计划订单<br>           matnr,<br>           pwwrk,<br>           verid,<br>           psttr,<br>           gsmng<br>     FROM plaf<br>     INTO TABLE @DATA(lt_plaf01)<br>     FOR ALL ENTRIES IN @lt_mkal<br>     WHERE matnr &#x3D; @lt_mkal-matnr<br>     AND   pwwrk &#x3D; @lt_mkal-werks.<br>    SORT:lt_plaf01 BY matnr pwwrk.</p>
<pre><code>SELECT plnum&quot;计划订单
       matnr
       pwwrk
       verid
       psttr
       gsmng
 FROM plaf
 INTO CORRESPONDING FIELDS OF TABLE lt_plaf
 FOR ALL ENTRIES IN lt_mkal
 WHERE matnr = lt_mkal-matnr
 AND   pwwrk = lt_mkal-werks
 AND   verid = lt_mkal-verid.
SORT:lt_plaf BY matnr pwwrk verid.

&quot;汇总生产版本下计划订单的数量
CLEAR:lt_plafcol,ls_plafcol.
LOOP AT lt_plaf INTO DATA(ls_plaf) WHERE psttr &lt;= sy-datum.
  MOVE-CORRESPONDING ls_plaf TO ls_plafcol.
  COLLECT ls_plafcol INTO lt_plafcol.
ENDLOOP.
&quot;汇总日期对应的数量
CLEAR:lt_xqslcol,ls_xqslcol.
LOOP AT lt_plaf INTO ls_plaf.
  MOVE-CORRESPONDING ls_plaf TO ls_xqslcol.
  COLLECT ls_xqslcol INTO lt_xqslcol.
ENDLOOP.

SELECT matnr,
       werks,
       stlan,
       stlnr,
       stlal
  FROM mast
  INTO TABLE @DATA(lt_mast)
  FOR ALL ENTRIES IN @lt_mkal
  WHERE matnr = @lt_mkal-matnr
  AND   werks = @lt_mkal-werks
  AND   stlan = @lt_mkal-stlan
  AND   stlal = @lt_mkal-stlal.
SORT:lt_mast BY matnr werks stlan stlal.

IF lt_mast IS NOT INITIAL.
  SELECT stlnr,
         stlal,
         stktx&quot;BOM版本
    FROM stko
    INTO TABLE @DATA(lt_stko)
    FOR ALL ENTRIES IN @lt_mast
    WHERE stlnr = @lt_mast-stlnr
    AND   stlal = @lt_mast-stlal.
  SORT:lt_stko BY stlnr stlal.
ENDIF.

SELECT matnr,
</code></pre>
<ul>
<li><pre><code>      STKTX,
     werks,
     kunnr,
     stlal,
     stlan,
</code></pre>
</li>
<li><pre><code>      zbbfa,
     zsfkfh,&quot;是否可发货
     zcbyxj&quot;成本优先级
FROM zta_sd001
INTO TABLE @DATA(lt_zta_sd001)
FOR ALL ENTRIES IN @lt_mkal
WHERE matnr = @lt_mkal-matnr
AND   werks = @lt_mkal-werks
AND   stlal = @lt_mkal-stlal
AND   stlan = @lt_mkal-stlan
AND   zdel  &lt;&gt; &#39;X&#39;.
</code></pre>
<p>  SORT:lt_zta_sd001 BY matnr werks stlal stlan.</p>
<p>  SELECT mast<del>matnr,<br>     mast</del>werks,<br>     mast<del>stlan,<br>     mast</del>stlnr,<br>     mast<del>stlal,<br>     stko</del>zcpzt”产品状态<br>FROM mast<br>INNER JOIN stko ON mast<del>stlnr &#x3D; stko</del>stlnr AND mast<del>stlal &#x3D; stko</del>stlal<br>INTO TABLE @DATA(lt_mast01)<br>FOR ALL ENTRIES IN @lt_mkal<br>WHERE mast<del>matnr &#x3D; @lt_mkal-matnr<br>AND   mast</del>werks &#x3D; @lt_mkal-werks<br>AND   mast~stlan &#x3D; ‘1’.<br>  SORT:lt_mast01 BY matnr werks stlal.</p>
</li>
</ul>
<p>*&amp;—MRP控制者<br>    SELECT marc<del>matnr,<br>           marc</del>werks,</p>
<pre><code>       marc~dispo
  FROM marc
  INTO TABLE @DATA(lt_marcdispo)
  FOR ALL ENTRIES IN @lt_mkal
  WHERE marc~matnr = @lt_mkal-matnr
  AND   marc~werks = @lt_mkal-werks
  AND   marc~sobsl &lt;&gt; &#39;50&#39;.&quot;排除虚拟半成品
SORT:lt_marcdispo BY matnr werks.

IF lt_marcdispo IS NOT INITIAL.
</code></pre>
<p>*&amp;—MRP控制者描述<br>      SELECT werks,<br>             dispo,</p>
<pre><code>         dsnam
    FROM t024d
    INTO TABLE @DATA(lt_t024d)
    FOR ALL ENTRIES IN @lt_marcdispo
    WHERE dispo = @lt_marcdispo-dispo
    AND werks = @lt_marcdispo-werks&quot;添加工厂的对应,Modify By Mr.GongRan--小站MRPMRP控制者描述取数问题
    &quot;AND   dispo IN @s_dispo.  由于现在加了dispo权限及一些特殊需求,要用自建的全局变量gt_dispo来替换s_dispo
    AND dispo IN @gt_dispo.
  SORT:lt_t024d BY dispo werks.
ENDIF.
</code></pre>
<p>  ENDIF.</p>
<p>  CLEAR:<ft_vb>.<br>  LOOP AT lt_mkal INTO DATA(ls_mkal).<br>    CLEAR:<fs_vb>.<br>    “获取去零的物料编码<br>    DATA(zmatnrnum) &#x3D; |{ ls_mkal-matnr ALPHA &#x3D; OUT }|.<br>*&amp;—计划订单中不存在则不展开BOM<br>    READ TABLE lt_plaf01 INTO DATA(ls_plaf01) WITH KEY matnr &#x3D; ls_mkal-matnr pwwrk &#x3D; ls_mkal-werks BINARY SEARCH.<br>    IF sy-subrc &lt;&gt;  0 .<br>      DELETE lt_mkal.<br>      CONTINUE.<br>    ENDIF.</p>
<p>*&amp;—MRP控制者<br>    ASSIGN COMPONENT ‘DISPO’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      READ TABLE lt_marcdispo INTO DATA(ls_marcdispo) WITH KEY matnr &#x3D; ls_mkal-matnr werks &#x3D; ls_mkal-werks BINARY SEARCH.<br>      IF sy-subrc &#x3D; 0.<br>        “IF ls_marcdispo-dispo IN s_dispo. 由于现在加了dispo权限及一些特殊需求,要用自建的全局变量gt_dispo来替换s_dispo<br>        IF ls_marcdispo-dispo IN gt_dispo.<br>          <ft> &#x3D; ls_marcdispo-dispo.</p>
<pre><code>      READ TABLE lt_t024d INTO DATA(ls_t024d) WITH KEY dispo = ls_marcdispo-dispo werks = ls_marcdispo-werks  BINARY SEARCH.
      IF sy-subrc = 0.
</code></pre>
<p>*&amp;—MRP控制者描述<br>            ASSIGN COMPONENT ‘DSNAM’ OF STRUCTURE <fs_vb> TO <ft>.<br>            IF sy-subrc &#x3D; 0.<br>              <ft> &#x3D; ls_t024d-dsnam.<br>            ENDIF.<br>          ENDIF.<br>        ELSE.<br>          CONTINUE.<br>        ENDIF.<br>      ELSE.<br>        CONTINUE.<br>      ENDIF.<br>    ENDIF.</p>
<p>*&amp;—备选<br>    ASSIGN COMPONENT ‘STLAL’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-stlal.<br>    ENDIF.</p>
<p>*&amp;—用途<br>    ASSIGN COMPONENT ‘STLAN’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-stlan.<br>    ENDIF.</p>
<p>*&amp;—制单日期<br>    ASSIGN COMPONENT ‘ZZDRQ’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; sy-datum.<br>    ENDIF.<br>*&amp;—工厂<br>    ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; s_werks-low.<br>    ENDIF.<br>*&amp;—物料编码<br>    ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-matnr.<br>    ENDIF.<br>*&amp;—物料描述<br>    ASSIGN COMPONENT ‘MAKTX’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-maktx.<br>    ENDIF.<br>*&amp;—生产版本<br>    ASSIGN COMPONENT ‘VERID’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-verid.<br>    ENDIF.<br>*&amp;—生产版本描述<br>    ASSIGN COMPONENT ‘TEXT1’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-text1.<br>    ENDIF.<br>*&amp;—生产线<br>    ASSIGN COMPONENT ‘MDV01’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; ls_mkal-mdv01.<br>    ENDIF.<br>*&amp;—BOM版本<br>    ASSIGN COMPONENT ‘STKTX’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      READ TABLE lt_mast INTO DATA(ls_mast) WITH KEY matnr &#x3D; ls_mkal-matnr werks &#x3D; ls_mkal-werks stlan &#x3D; ls_mkal-stlan stlal &#x3D; ls_mkal-stlal BINARY SEARCH.<br>      IF sy-subrc &#x3D; 0.<br>        READ TABLE lt_stko INTO DATA(ls_stko) WITH KEY stlnr &#x3D; ls_mast-stlnr stlal &#x3D; ls_mast-stlal BINARY SEARCH.<br>        IF sy-subrc &#x3D; 0.<br>          <ft> &#x3D; ls_stko-stktx.<br>        ENDIF.<br>      ENDIF.<br>    ENDIF.</p>
<pre><code>READ TABLE lt_zta_sd001 INTO DATA(ls_zta_sd001) WITH KEY matnr = ls_mkal-matnr werks = ls_mkal-werks stlal = ls_mkal-stlal stlan = ls_mkal-stlan BINARY SEARCH.
IF sy-subrc = 0.
</code></pre>
<p>*&amp;—成本优先级<br>      ASSIGN COMPONENT ‘ZCBYXJ’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_zta_sd001-zcbyxj.<br>      ENDIF.<br>*&amp;—是否可发货<br>      ASSIGN COMPONENT ‘ZSFKFH’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_zta_sd001-zsfkfh.<br>      ENDIF.</p>
<ul>
<li><pre><code> IF ls_zta_sd001-zbbfa CS &#39;SN 8开头&#39;.
</code></pre>
</li>
</ul>
<p>**&amp;—BOM版本方案</p>
<ul>
<li><pre><code> ASSIGN COMPONENT &#39;ZBBFA&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
</code></pre>
</li>
<li><pre><code> IF sy-subrc = 0.
</code></pre>
</li>
<li><pre><code>   &lt;ft&gt; = &#39;SN 8开头&#39;.
</code></pre>
</li>
<li><pre><code> ENDIF.
</code></pre>
</li>
<li><pre><code> ENDIF.
</code></pre>
  ENDIF.</li>
</ul>
<p>*&amp;—物料30开头的为成品物料，排除30物料发货标识不为Y和P的行项目<br>    IF zmatnrnum(2) &#x3D; ‘30’ AND ls_zta_sd001-zsfkfh &lt;&gt; ‘Y’ AND ls_zta_sd001-zsfkfh &lt;&gt; ‘P’.<br>      CONTINUE.<br>    ENDIF.<br>    CLEAR:ls_zta_sd001.</p>
<p>*&amp;—产品状态<br>    ASSIGN COMPONENT ‘MTSTB’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      READ TABLE lt_mast01 INTO DATA(ls_mast01) WITH KEY matnr &#x3D; ls_mkal-matnr werks &#x3D; ls_mkal-werks stlal &#x3D; ls_mkal-stlal  BINARY SEARCH.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_mast01-zcpzt.<br>      ENDIF.<br>    ENDIF.</p>
<pre><code>CLEAR:zsumweek,ls_plafcol.
READ TABLE lt_plafcol INTO ls_plafcol WITH KEY matnr = ls_mkal-matnr pwwrk = ls_mkal-werks verid = ls_mkal-verid BINARY SEARCH.
IF sy-subrc = 0.
</code></pre>
<p>*&amp;—截止当日逾期数量<br>      ASSIGN COMPONENT ‘ZJZDRYQSL’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_plafcol-gsmng.<br>        PERFORM frm_choose_dicimal CHANGING <ft> .”判断小数位是否显示<br>        zsumsl &#x3D; zsumsl + ls_plafcol-gsmng.<br>        zsumweek &#x3D; zsumweek + <ft>.<br>      ENDIF.<br>    ENDIF.</p>
<p>*&amp;—所有日期对应的数量<br>    zdatum &#x3D; sy-datum.<br>    DO znum TIMES.<br>      zdatum &#x3D; zdatum + 1.<br>      CLEAR:wotnr.<br>      “判断输入日期是周几<br>      CALL FUNCTION ‘DAY_IN_WEEK’<br>        EXPORTING<br>          datum &#x3D; zdatum<br>        IMPORTING<br>          wotnr &#x3D; wotnr.</p>
<pre><code>  CASE wotnr.
    WHEN 1.
      zname = &#39;周一&#39;.
    WHEN 2.
      zname = &#39;周二&#39;.
    WHEN 3.
      zname = &#39;周三&#39;.
    WHEN 4.
      zname = &#39;周四&#39;.
    WHEN 5.
      zname = &#39;周五&#39;.
    WHEN 6.
      zname = &#39;周六&#39;.
    WHEN 7.
      zname = &#39;周日&#39;.
    WHEN OTHERS.
  ENDCASE.
</code></pre>
<p>*&amp;—按天展示数量<br>      zzdys &#x3D; ‘Z’ &amp;&amp; zdatum.<br>      ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        CLEAR:<ft>.<br>        READ TABLE lt_xqslcol INTO ls_xqslcol WITH KEY matnr &#x3D; ls_mkal-matnr pwwrk &#x3D; ls_mkal-werks verid &#x3D; ls_mkal-verid psttr &#x3D; zdatum.<br>        IF sy-subrc &#x3D; 0.<br>          <ft> &#x3D; ls_xqslcol-gsmng.<br>          PERFORM frm_choose_dicimal CHANGING <ft> .”判断小数位是否显示<br>          zsumsl &#x3D; zsumsl + <ft>.<br>          zsumweek &#x3D; zsumweek + <ft>.<br>        ENDIF.<br>      ENDIF.<br>    ENDDO.</p>
<pre><code>zdatum = zdatum - 6.&quot;周一日期

CLEAR:znumber.
DO 4 TIMES.
</code></pre>
<p>*&amp;—查看日期在当前年度第几周<br>      znumber &#x3D; znumber + 1.</p>
<pre><code>  CLEAR:zweek.
  CALL FUNCTION &#39;DATE_GET_WEEK&#39;
    EXPORTING
      date         = zdatum
    IMPORTING
      week         = zweek
    EXCEPTIONS
      date_invalid = 1
      OTHERS       = 2.
  IF sy-subrc &lt;&gt; 0.
</code></pre>
<ul>
<li>IMPLEMENT SUITABLE ERROR HANDLING HERE<br>ENDIF.<br>zdatum_sunday &#x3D; zdatum + 6.<br><br>“下周汇总列不允许更改<br>IF znumber &#x3D; 1.<br><br>  zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>  ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>  IF sy-subrc &#x3D; 0.<br>    <ft> &#x3D; zsumweek.<br>    PERFORM frm_choose_dicimal CHANGING <ft> .”判断小数位是否显示<br>  ENDIF.</li>
</ul>
<p>*&amp;—设置单元格不可编辑<br>        CLEAR:lt_style.<br>        ls_style-fieldname &#x3D; zzdys.<br>        ls_style-style &#x3D; cl_gui_alv_grid&#x3D;&gt;mc_style_disabled.<br>        INSERT ls_style INTO TABLE lt_style.<br>        ASSIGN COMPONENT ‘ZSTYLE’ OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          <ft> &#x3D; lt_style.<br>        ENDIF.<br>      ELSE.</p>
<p>*&amp;—一周的数量汇总<br>        zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>        ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          LOOP AT lt_xqslcol INTO ls_xqslcol WHERE matnr &#x3D; ls_mkal-matnr<br>                                                AND pwwrk &#x3D; ls_mkal-werks<br>                                                AND verid &#x3D; ls_mkal-verid<br>                                                AND psttr &gt;&#x3D; zdatum<br>                                                AND psttr &lt;&#x3D; zdatum_sunday.<br>            <ft> &#x3D; <ft> + ls_xqslcol-gsmng.<br>          ENDLOOP.<br>          zsumsl &#x3D; zsumsl + <ft>.<br>        ENDIF.<br>        PERFORM frm_choose_dicimal CHANGING <ft> .”判断小数位是否显示</p>
<pre><code>  ENDIF.
  zdatum = zdatum + 7.
ENDDO.
</code></pre>
<p>*&amp;—计划总量<br>    ASSIGN COMPONENT ‘ZJHZL’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft> &#x3D; zsumsl.<br>      PERFORM frm_choose_dicimal CHANGING <ft> .”判断小数位是否显示<br>    ENDIF.<br>*&amp;—已分配量<br>    ASSIGN COMPONENT ‘ZYFPL’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.</p>
<ul>
<li><pre><code> &lt;FT&gt; = ZSUMSL - LS_PLAFCOL-GSMNG.&quot;减去逾期数量
&lt;ft&gt; = zsumsl.
PERFORM frm_choose_dicimal CHANGING &lt;ft&gt; .&quot;判断小数位是否显示
</code></pre>
<p>  ENDIF.<br>*&amp;—累计差异</p>
<p>  APPEND <fs_vb> TO <ft_vb>.<br>  CLEAR:zsumsl.<br>ENDLOOP.</p>
<p>DATA:w_it_field  TYPE abap_sortorder_tab,<br> w_str_field TYPE abap_sortorder.<br>w_str_field-name &#x3D; ‘DISPO’.<br>w_str_field-descending &#x3D; ‘’.<br>APPEND w_str_field TO w_it_field.<br>w_str_field-name &#x3D; ‘MATNR’.<br>w_str_field-descending &#x3D; ‘’.<br>APPEND w_str_field TO w_it_field.</p>
<p>SORT <ft_vb> BY (w_it_field).</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ALV_TYPE<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM frm_alv_type .<br>  CLEAR:gs_layout.<br>  gs_layout-zebra      &#x3D; ‘X’.”斑马线<br>  gs_layout-cwidth_opt &#x3D; ‘X’.”自动适应列宽<br>  gs_layout-stylefname   &#x3D; ‘ZSTYLE’.<br>  gs_layout-ctab_fname   &#x3D; ‘CELLCOLOR’.<br>  gs_layout-sel_mode   &#x3D; ‘A’.”选择模式<br>ENDFORM.<br>*&amp;———————————————————————*<br>*&amp; FORM FRM_DATA_CHANGED_FINISHED<br>*&amp;———————————————————————*<br>*&amp; TEXT<br>*&amp;———————————————————————*<br>*&amp;      –&gt; E_MODIFIED<br>*&amp;      –&gt; ET_GOOD_CELLS<br><em>&amp;———————————————————————</em><br>FORM frm_data_changed_finished  USING  e_modified TYPE char01<br>                                       et_good_cells TYPE lvc_t_modi.<br>  DATA: ls_lvc_s_modi TYPE lvc_s_modi,<br>        zsqsl         TYPE char25,<br>        zmatnr        TYPE mara-matnr.<br>  DATA wa_cellcolor TYPE lvc_s_scol . “ 单元格颜色结构</p>
<p>**—数据发生更改的标识<br>  IF e_modified &#x3D; ‘X’.<br>    CLEAR:zsumsl.</p>
<pre><code>READ TABLE et_good_cells INTO DATA(es_good_cells) INDEX 1.
IF sy-subrc = 0.
  &quot;修改的变量名称
  READ TABLE &lt;ft_vb&gt; INTO &lt;fs_vb&gt; INDEX es_good_cells-row_id.
  IF sy-subrc = 0.
    ASSIGN COMPONENT &#39;MATNR&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
    IF sy-subrc = 0.
      zmatnr = &lt;ft&gt;.
    ENDIF.
</code></pre>
<p>*&amp;—截止日期逾期数量<br>        CLEAR:zsumweek.<br>        ASSIGN COMPONENT ‘ZJZDRYQSL’ OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          zsumsl &#x3D; zsumsl + <ft>.<br>          zsumweek &#x3D; zsumweek + <ft>.<br>        ENDIF.</p>
<p>*&amp;—所有天的数量汇总<br>        zdatum &#x3D; sy-datum.<br>        DO znum TIMES.<br>          zdatum &#x3D; zdatum + 1.<br>*&amp;—按天展示数量<br>          zzdys &#x3D; ‘Z’ &amp;&amp; zdatum.<br>          ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>          IF sy-subrc &#x3D; 0.<br>            zsumsl &#x3D; zsumsl + <ft>.<br>            zsumweek &#x3D; zsumweek + <ft>.<br>          ENDIF.<br>        ENDDO.</p>
<pre><code>    zdatum = zdatum - 6.
</code></pre>
<p>*&amp;—更新下周汇总数据<br>        CLEAR:zweek.<br>        CALL FUNCTION ‘DATE_GET_WEEK’<br>          EXPORTING<br>            date         &#x3D; zdatum<br>          IMPORTING<br>            week         &#x3D; zweek<br>          EXCEPTIONS<br>            date_invalid &#x3D; 1<br>            OTHERS       &#x3D; 2.<br>*&amp;—一周的数量汇总<br>        zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>        ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          <ft> &#x3D; zsumweek.<br>        ENDIF.</p>
<p>*&amp;—剩余三周数量<br>        DO 3 TIMES.<br>          zdatum &#x3D; zdatum + 7.<br>*&amp;—查看日期在当前年度第几周<br>          CLEAR:zweek.<br>          CALL FUNCTION ‘DATE_GET_WEEK’<br>            EXPORTING<br>              date         &#x3D; zdatum<br>            IMPORTING<br>              week         &#x3D; zweek<br>            EXCEPTIONS<br>              date_invalid &#x3D; 1<br>              OTHERS       &#x3D; 2.<br>          IF sy-subrc &lt;&gt; 0.</p>
<ul>
<li>IMPLEMENT SUITABLE ERROR HANDLING HERE<br>    ENDIF.<br>    zdatum_sunday &#x3D; zdatum + 6.</li>
</ul>
<p>*&amp;—一周的数量汇总<br>          zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>          ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>          IF sy-subrc &#x3D; 0.<br>            zsumsl &#x3D; zsumsl + <ft>.<br>          ENDIF.<br>        ENDDO.</p>
<p>*&amp;—已分配量<br>        ASSIGN COMPONENT ‘ZYFPL’ OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          <ft> &#x3D; zsumsl.<br>        ENDIF.<br>        MODIFY <ft_vb> FROM <fs_vb> INDEX es_good_cells-row_id.<br>      ENDIF.</p>
<p>*&amp;—一个物料一个累计差异<br>      CLEAR:zsumsl.<br>      LOOP AT <ft_vb> INTO <fs_vb>.<br>        ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb> TO <ft>.<br>        IF sy-subrc &#x3D; 0.<br>          IF <ft> &#x3D; zmatnr.<br>            “重新计算这个物料所有行的差异<br>            ASSIGN COMPONENT ‘ZJHZL’ OF STRUCTURE <fs_vb> TO <ft01>.<br>            IF sy-subrc &#x3D; 0.<br>              ASSIGN COMPONENT ‘ZYFPL’ OF STRUCTURE <fs_vb> TO <ft02>.<br>              IF sy-subrc &#x3D; 0.<br>                zsumsl &#x3D; zsumsl + <ft02> - <ft01>.<br>                ASSIGN COMPONENT ‘ZLJCY’ OF STRUCTURE <fs_vb> TO <ft>.<br>                IF sy-subrc &#x3D; 0.<br>                  <ft> &#x3D; zsumsl.<br>                  IF <ft> &lt; 0.<br>*&amp;—单元格颜色设置<br>                    “字段名<br>                    CLEAR:p_cellcolor.<br>                    wa_cellcolor-fname &#x3D; ‘ZLJCY’.<br>                    “颜色代码<br>                    wa_cellcolor-color-col &#x3D; ‘6’.<br>                    wa_cellcolor-color-int &#x3D; ‘1’.<br>                    wa_cellcolor-color-inv &#x3D; ‘0’.<br>                    APPEND wa_cellcolor TO p_cellcolor.<br>                  ELSE.<br>                    DELETE p_cellcolor WHERE fname &#x3D; ‘ZLJCY’.<br>                  ENDIF.<br>                  ASSIGN COMPONENT ‘CELLCOLOR’ OF STRUCTURE <fs_vb> TO <ft>.<br>                  IF sy-subrc &#x3D; 0.<br>                    <ft> &#x3D; p_cellcolor.<br>                  ENDIF.<br>                  MODIFY <ft_vb> FROM <fs_vb>.<br>                ENDIF.<br>              ENDIF.<br>            ENDIF.<br>          ENDIF.<br>        ENDIF.<br>      ENDLOOP.</p>
<pre><code>ENDIF.
</code></pre>
<p>  ENDIF.</p>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ALV_REFRESH<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM frm_alv_refresh .<br>*&amp;—LAYOUT刷新<br>  CALL METHOD gr_table1-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.</p>
<ul>
<li>GS_LAYOUT-CWIDTH_OPT &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;set_frontend_layout<br> EXPORTING<br>   is_layout &#x3D; gs_layout.</li>
</ul>
<p>*&amp;—稳定刷新<br>  DATA:stbll TYPE lvc_s_stbl.<br>  stbll-row &#x3D; ‘X’.<br>  stbll-col &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_BAPI<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM frm_bapi .<br>  DATA:return        TYPE bapireturn1,<br>       plannedorder  TYPE bapi_pldord-pldord_num,<br>       ls_headerdata TYPE bapiplaf_i1.<br>  FIELD-SYMBOLS:<fs_matnr>,<fs_werks>,<fs_verid>.<br>  DATA:lt_data TYPE TABLE OF plaf,<br>       ls_data TYPE plaf.</p>
<p>*&amp;—将物料，生产版本转移到内表，方便获取计划订单<br>  CLEAR:lt_data.<br>  LOOP AT <ft_vb> INTO <fs_vb>.<br>    ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb> TO <fs_matnr>.<br>    IF sy-subrc &#x3D; 0.<br>      ls_data-matnr &#x3D; <fs_matnr>.<br>    ENDIF.<br>    ASSIGN COMPONENT ‘VERID’ OF STRUCTURE <fs_vb> TO <fs_verid>.<br>    IF sy-subrc &#x3D; 0.<br>      ls_data-verid &#x3D; <fs_verid>.<br>    ENDIF.<br>    APPEND ls_data TO lt_data.<br>    CLEAR:ls_data.<br>  ENDLOOP.</p>
<p>  IF lt_data IS NOT INITIAL.<br>*&amp;—获取已存在的计划订单<br>    SELECT *<br>     FROM plaf<br>     INTO TABLE @DATA(lt_plaf01)<br>      FOR ALL ENTRIES IN @lt_data<br>     WHERE matnr &#x3D; @lt_data-matnr<br>       AND pwwrk IN @s_werks<br>       AND verid &#x3D; @lt_data-verid.<br>    SORT:lt_plaf01 BY matnr pwwrk verid.</p>
<p>*&amp;—获取良率<br>    “第一步：获取物料清单<br>    SELECT mkal<del>matnr,<br>           mkal</del>werks,<br>           mkal~verid,</p>
<pre><code>       mkal~stlal,
       mast~stlnr
  FROM mkal
  INNER JOIN mast ON mast~matnr = mkal~matnr AND mast~werks = mkal~werks AND mast~stlan = mkal~stlan AND mast~stlal = mkal~stlal
  INTO TABLE @DATA(lt_stlnr)
  FOR ALL ENTRIES IN @lt_data
  WHERE mkal~matnr = @lt_data-matnr
  AND   mkal~werks IN @s_werks
  AND   mkal~verid = @lt_data-verid.
SORT:lt_stlnr BY matnr werks verid.

IF lt_stlnr IS NOT INITIAL.
  &quot;第二步:获取良率
  SELECT stlty,
         stlnr,
         stlal,
         stkoz,

         zbomll
    FROM stko
    INTO TABLE @DATA(lt_stko)
    FOR ALL ENTRIES IN @lt_stlnr
    WHERE stlnr = @lt_stlnr-stlnr
    AND   stlal = @lt_stlnr-stlal.
  SORT:lt_stko BY stlnr stlal.
ENDIF.
</code></pre>
<p>  ENDIF.</p>
<p>  LOOP AT <ft_vb> INTO <fs_vb>.<br>    ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb> TO <fs_matnr>.<br>    IF sy-subrc &#x3D; 0.<br>      ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb> TO <fs_werks>.<br>      IF sy-subrc &#x3D; 0.<br>        ASSIGN COMPONENT ‘VERID’ OF STRUCTURE <fs_vb> TO <fs_verid>.<br>        IF sy-subrc &#x3D; 0.<br>          zdatum &#x3D; sy-datum.</p>
<p>*&amp;—读取良率<br>          READ TABLE lt_stlnr INTO DATA(ls_stlnr) WITH KEY matnr &#x3D; <fs_matnr> werks &#x3D; <fs_werks> verid &#x3D; <fs_verid> BINARY SEARCH.<br>          IF sy-subrc &#x3D; 0.<br>            READ TABLE lt_stko INTO DATA(ls_stko) WITH KEY stlnr &#x3D; ls_stlnr-stlnr stlal &#x3D; ls_stlnr-stlal BINARY SEARCH.<br>            IF sy-subrc &#x3D; 0.<br>              DATA(zblmll) &#x3D; ls_stko-zbomll.<br>            ENDIF.<br>          ENDIF.<br>          “良率为0则默认为100<br>          IF zblmll &#x3D; 0.<br>            zblmll &#x3D; 100.<br>          ENDIF.</p>
<p>*&amp;—删除逾期的计划订单,创建今天的计划订单<br>          PERFORM frm_del_yqjhdd  TABLES lt_plaf01 USING <fs_matnr> <fs_werks> <fs_verid> zblmll.</p>
<pre><code>      ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
      IF sy-subrc = 0.
        IF &lt;ft&gt; = icon_red_light.
          CONTINUE.
        ELSE.
          DO znum TIMES.
            CLEAR:ls_headerdata.
            zdatum = zdatum + 1.
            zzdys = &#39;Z&#39; &amp;&amp; zdatum.
            &quot;删除该物料工厂生产版本下这个期间内的所有计划订单
            LOOP AT lt_plaf01 INTO DATA(ls_plaf) WHERE matnr = &lt;fs_matnr&gt;
                                                  AND pwwrk = &lt;fs_werks&gt;
                                                  AND verid = &lt;fs_verid&gt;
                                                  AND psttr = zdatum.
              plannedorder = ls_plaf-plnum.
              CLEAR:return.
              CALL FUNCTION &#39;BAPI_PLANNEDORDER_DELETE&#39;
                EXPORTING
                  plannedorder = plannedorder
                IMPORTING
                  return       = return.
              IF return-type = &#39;E&#39;.
                ASSIGN COMPONENT &#39;MSG&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                IF sy-subrc = 0.
                  &lt;ft&gt; = return-message.
                ENDIF.
                ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                IF sy-subrc = 0.
                  &lt;ft&gt; = icon_red_light.
                ENDIF.
                MODIFY &lt;ft_vb&gt; FROM &lt;fs_vb&gt;.
                ROLLBACK WORK.
                EXIT.
              ENDIF.
            ENDLOOP.

            ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
            IF sy-subrc = 0.
              IF &lt;ft&gt; = icon_red_light.
                &quot;删除有报错则整行不处理
                CONTINUE.
                &quot;删除成功则创建
              ELSE.
                CLEAR:return.
                ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                IF sy-subrc = 0.
                  &quot;数量为0不创建
                  IF &lt;ft&gt; = 0.
                    CONTINUE.
                  ENDIF.
                  CLEAR:lv_mdv01.
                  ls_headerdata-pldord_profile = &#39;LA&#39;.
                  SELECT SINGLE mdv01 INTO lv_mdv01 FROM mkal WHERE matnr = &lt;fs_matnr&gt; AND werks = &lt;fs_werks&gt; AND verid = &lt;fs_verid&gt;.
                  IF lv_mdv01 = &#39;11009999&#39;.
                    ls_headerdata-pldord_profile = &#39;ZNB&#39;.
                  ENDIF.
                  ls_headerdata-total_plord_qty = &lt;ft&gt; .&quot;订单数量
                  ls_headerdata-fixed_scrap_qty = &lt;ft&gt; * ( 1 - zblmll / 100 ).&quot;订单数量
                  ls_headerdata-fixed_scrap_qty = ceil( ls_headerdata-fixed_scrap_qty ).
</code></pre>
<ul>
<li><pre><code>                 ls_headerdata-pldord_profile = &#39;LA&#39;.
                ls_headerdata-plng_scenario_lt = &#39;000&#39;.
                ls_headerdata-material = &lt;fs_matnr&gt;.
                ls_headerdata-plan_plant = &lt;fs_werks&gt;.
                ls_headerdata-version = &lt;fs_verid&gt;.
                ls_headerdata-order_start_date = zdatum.
                ls_headerdata-conversion_ind = &#39;X&#39;.
                ls_headerdata-bom_exp_fix_ind = &#39;X&#39;.
                ls_headerdata-firming_ind = &#39;X&#39;.
                CALL FUNCTION &#39;BAPI_PLANNEDORDER_CREATE&#39;
                  EXPORTING
                    headerdata = ls_headerdata
                  IMPORTING
                    return     = return.
                IF return-type = &#39;E&#39;.
                  ASSIGN COMPONENT &#39;MSG&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                  IF sy-subrc = 0.
                    &lt;ft&gt; = return-message.
                  ENDIF.
                  ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                  IF sy-subrc = 0.
                    &lt;ft&gt; = icon_red_light.
                  ENDIF.
                  ROLLBACK WORK.
                  EXIT.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDDO.
</code></pre>
</li>
</ul>
<p>*&amp;—周一和周末<br>              zdatum &#x3D; zdatum + 1.<br>              zdatum_sunday &#x3D; zdatum + 6.<br>              DO 3 TIMES.<br>                CLEAR:ls_headerdata.<br>                zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.<br>                “删除该物料工厂生产版本下本周内的所有计划订单<br>                LOOP AT lt_plaf01 INTO ls_plaf WHERE matnr &#x3D; <fs_matnr><br>                                               AND pwwrk &#x3D; <fs_werks><br>                                               AND verid &#x3D; <fs_verid><br>                                               AND psttr &gt;&#x3D; zdatum<br>                                               AND psttr &lt;&#x3D; zdatum_sunday.<br>                  plannedorder &#x3D; ls_plaf-plnum.<br>                  CLEAR:return.<br>                  CALL FUNCTION ‘BAPI_PLANNEDORDER_DELETE’<br>                    EXPORTING<br>                      plannedorder &#x3D; plannedorder<br>                    IMPORTING<br>                      return       &#x3D; return.<br>                  IF return-type &#x3D; ‘E’.<br>                    ASSIGN COMPONENT ‘MSG’ OF STRUCTURE <fs_vb> TO <ft>.<br>                    IF sy-subrc &#x3D; 0.<br>                      <ft> &#x3D; return-message.<br>                    ENDIF.<br>                    ASSIGN COMPONENT ‘ICON’ OF STRUCTURE <fs_vb> TO <ft>.<br>                    IF sy-subrc &#x3D; 0.<br>                      <ft> &#x3D; icon_red_light.<br>                    ENDIF.<br>                    MODIFY <ft_vb> FROM <fs_vb>.<br>                    ROLLBACK WORK.<br>                    EXIT.<br>                  ENDIF.<br>                ENDLOOP.</p>
<pre><code>            ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
            IF sy-subrc = 0.
              IF &lt;ft&gt; = icon_red_light.
                &quot;删除有报错则整行不处理
                CONTINUE.
                &quot;删除成功则创建
              ELSE.
                CLEAR:return.
                ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                IF sy-subrc = 0.
                  IF &lt;ft&gt; = 0.
                    zdatum = zdatum + 7.
                    zdatum_sunday = zdatum + 6.
                    CONTINUE.
                  ENDIF.
                  CLEAR:lv_mdv01.
                  ls_headerdata-pldord_profile = &#39;LA&#39;.
                  SELECT SINGLE mdv01 INTO lv_mdv01 FROM mkal WHERE matnr = &lt;fs_matnr&gt; AND werks = &lt;fs_werks&gt; AND verid = &lt;fs_verid&gt;.
                  IF lv_mdv01 = &#39;11009999&#39;.
                    ls_headerdata-pldord_profile = &#39;ZNB&#39;.
                  ENDIF.
                  ls_headerdata-total_plord_qty = &lt;ft&gt;.
                  ls_headerdata-fixed_scrap_qty = &lt;ft&gt; * ( 1 - zblmll / 100 ).&quot;订单数量
                  ls_headerdata-fixed_scrap_qty = ceil( ls_headerdata-fixed_scrap_qty ).
</code></pre>
<ul>
<li><pre><code>                 ls_headerdata-pldord_profile = &#39;LA&#39;.
                ls_headerdata-plng_scenario_lt = &#39;000&#39;.
                ls_headerdata-material = &lt;fs_matnr&gt;.
                ls_headerdata-plan_plant = &lt;fs_werks&gt;.
                ls_headerdata-version = &lt;fs_verid&gt;.
                ls_headerdata-order_start_date = zdatum.
                ls_headerdata-conversion_ind = &#39;X&#39;.
                ls_headerdata-bom_exp_fix_ind = &#39;X&#39;.
                ls_headerdata-firming_ind = &#39;X&#39;.
                CALL FUNCTION &#39;BAPI_PLANNEDORDER_CREATE&#39;
                  EXPORTING
                    headerdata = ls_headerdata
                  IMPORTING
                    return     = return.
                IF return-type = &#39;E&#39;.
                  ASSIGN COMPONENT &#39;MSG&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                  IF sy-subrc = 0.
                    &lt;ft&gt; = return-message.
                  ENDIF.
                  ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
                  IF sy-subrc = 0.
                    &lt;ft&gt; = icon_red_light.
                  ENDIF.
                  ROLLBACK WORK.
                  EXIT.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
          zdatum = zdatum + 7.
          zdatum_sunday = zdatum + 6.
        ENDDO.

        ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
        IF sy-subrc = 0.
          IF &lt;ft&gt; &lt;&gt; icon_red_light.
            &lt;ft&gt; = icon_green_light.
            CALL FUNCTION &#39;BAPI_TRANSACTION_COMMIT&#39;
              EXPORTING
                wait = &#39;X&#39;.

            ASSIGN COMPONENT &#39;MSG&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
            IF sy-subrc = 0.
              &lt;ft&gt; = &#39;创建成功!&#39;.
            ENDIF.
          ENDIF.
          MODIFY &lt;ft_vb&gt; FROM &lt;fs_vb&gt;.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDIF.
</code></pre>
<p>  ENDIF.</p>
<p>ENDLOOP.</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_GET_DATA01<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_get_data01 .<br>  DATA:lt_zta_pp00401 TYPE TABLE OF zta_pp004.<br>  DATA:lt_zta_pp00402 TYPE TABLE OF zta_pp004.</p>
<p>  SELECT * FROM zta_pp004<br>    INTO TABLE @DATA(lt_zta_pp004)<br>    WHERE zzdrq IN @s_zzdrq<br>    AND   zzdr  IN @s_zuser.</p>
<p>  lt_zta_pp00402 &#x3D; lt_zta_pp004.<br>  “展示的条目<br>  SORT lt_zta_pp00402 BY zzdrq werks matnr verid mdv01 zzdr.<br>  DELETE ADJACENT DUPLICATES FROM lt_zta_pp00402 COMPARING zzdrq werks matnr verid mdv01 zzdr.</p>
<p>  IF lt_zta_pp00402 IS NOT INITIAL.<br>*&amp;—MRP控制者描述<br>    SELECT werks,<br>           dispo,</p>
<pre><code>       dsnam
  FROM t024d
  INTO TABLE @DATA(lt_t024d)
  FOR ALL ENTRIES IN @lt_zta_pp00402
  WHERE dispo = @lt_zta_pp00402-dispo
  AND werks = @lt_zta_pp00402-werks&quot;添加工厂的对应,Modify By Mr.GongRan--小站MRPMRP控制者描述取数问题
  &quot;AND   dispo IN @s_dispo.由于现在加了dispo权限及一些特殊需求,要用自建的全局变量gt_dispo来替换s_dispo
       AND   dispo IN @gt_dispo.
SORT:lt_t024d BY dispo werks.
</code></pre>
<p>  ENDIF.</p>
<p>  CLEAR:<ft_vb>.<br>  LOOP AT lt_zta_pp00402 INTO DATA(ls_zta_pp00402).<br>    CLEAR:<fs_vb>.<br>    MOVE-CORRESPONDING ls_zta_pp00402 TO <fs_vb>.<br>    LOOP AT lt_zta_pp004 INTO DATA(ls_zta_pp004) WHERE zzdrq &#x3D; ls_zta_pp00402-zzdrq<br>                                                   AND  werks &#x3D; ls_zta_pp00402-werks<br>                                                   AND  matnr &#x3D; ls_zta_pp00402-matnr<br>                                                   AND  verid &#x3D; ls_zta_pp00402-verid<br>                                                   AND  mdv01 &#x3D; ls_zta_pp00402-mdv01<br>                                                   AND  zzdr &#x3D; ls_zta_pp00402-zzdr.<br>      ASSIGN COMPONENT ls_zta_pp004-zdmc OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_zta_pp004-zsl .<br>      ENDIF.<br>    ENDLOOP.</p>
<pre><code>READ TABLE lt_t024d INTO DATA(ls_t024d) WITH KEY dispo = ls_zta_pp00402-dispo  werks = ls_zta_pp00402-werks BINARY SEARCH.
IF sy-subrc = 0.
</code></pre>
<p>*&amp;—MRP控制者描述<br>      ASSIGN COMPONENT ‘DSNAM’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; ls_t024d-dsnam.<br>      ENDIF.<br>    ENDIF.<br>    APPEND <fs_vb> TO <ft_vb>.<br>    CLEAR:zsumsl.<br>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_FIELDCAT01<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_fieldcat01 TABLES lt_tab STRUCTURE zta_pp004.</p>
<ul>
<li>CLEAR:gt_fieldcatalog1.</li>
<li>macro_add_fieldcat:</li>
<li>‘ICON’ ‘指示灯’ space space space 4 space ‘X’ space,</li>
<li>‘MSG’  ‘消息’ ‘BAPIRETURN1’ ‘MESSAGE’ space 10 space space space,</li>
<li>‘STLAL’ ‘备选’ ‘MKAL’ ‘STLAL’ ‘’ space 10 space ‘X’,</li>
<li>‘STLAN’ ‘用途’ ‘MKAL’ ‘STLAN’ ‘’ space 10 space ‘X’,</li>
<li>‘ZZDRQ’ ‘制单日期’ ‘ZTA_PP004’ ‘ZZDRQ’ ‘’ space space space space,</li>
<li>‘WERKS’ ‘工厂’ ‘MARC’ ‘WERKS’ space space space space space,</li>
<li>‘MATNR’ ‘物料编码’ ‘MARA’ ‘MATNR’ ‘’ space space space space,</li>
<li>‘MAKTX’ ‘物料描述’ ‘MAKT’ ‘MAKTX’ ‘’ space space space space,</li>
<li>‘VERID’ ‘生产版本’ ‘PLAF’ ‘VERID’ ‘’ space space space space,</li>
<li>‘TEXT1’ ‘生产版本描述’ ‘MKAL’ ‘TEXT1’ ‘’ space space space space,</li>
<li>‘MDV01’ ‘生产线’ ‘MKAL’ ‘MDV01’ ‘’ space space space space,</li>
<li>‘STKTX’ ‘BOM版本’ ‘STKO’ ‘STKTX’ ‘’ space space space space,</li>
<li>‘ZCBYXJ’ ‘成本优先级’ ‘ZTA_SD001’ ‘ZCBYXJ’ ‘’ space space space space,</li>
<li>‘ZSFKFH’ ‘是否可发货’ ‘ZTA_PP004’ ‘ZSFKFH’ ‘’ space space space space,</li>
<li>‘MTSTB’ ‘产品状态’ ‘T141T’ ‘MTSTB’ ‘’ space space space space,</li>
<li>‘ZJHBZ’ ‘计划备注’ ‘ZTA_PP004’ ‘ZJHBZ’ ‘’ space space space space,</li>
<li>‘ZJZDRYQSL’ ‘截止当日逾期数量’ ‘ZTA_PP004’ ‘ZJZDRYQSL’ ‘’ space space space space.</li>
<li>READ TABLE lt_tab[] INTO DATA(ls_tab) INDEX 1.</li>
<li>IF sy-subrc &#x3D; 0.</li>
<li>“获取开始日期</li>
<li>zdatum &#x3D; ls_tab-zrq.</li>
</ul>
<p>**&amp;—获取开始日期周的周日</p>
<ul>
<li>CLEAR:zdatum_sunday.</li>
<li>CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’</li>
<li><pre><code> EXPORTING
</code></pre>
</li>
<li><pre><code>   date   = zdatum
</code></pre>
</li>
<li><pre><code> IMPORTING
</code></pre>
</li>
<li><pre><code>   sunday = zdatum_sunday.
</code></pre>
</li>
<li>CLEAR:znum.</li>
<li>“没有保存今天，所以需要+1</li>
<li>znum &#x3D; zdatum_sunday - zdatum + 7 + 1.</li>
<li>ENDIF.</li>
<li></li>
<li>DO znum TIMES.</li>
<li>CLEAR:wotnr,zname.</li>
<li>“判断输入日期是周几</li>
<li>CALL FUNCTION ‘DAY_IN_WEEK’</li>
<li><pre><code> EXPORTING
</code></pre>
</li>
<li><pre><code>   datum = zdatum
</code></pre>
</li>
<li><pre><code> IMPORTING
</code></pre>
</li>
<li><pre><code>   wotnr = wotnr.
</code></pre>
</li>
<li></li>
<li>CASE wotnr.</li>
<li><pre><code> WHEN 1.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周一&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 2.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周二&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 3.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周三&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 4.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周四&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 5.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周五&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 6.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周六&#39;.
</code></pre>
</li>
<li><pre><code> WHEN 7.
</code></pre>
</li>
<li><pre><code>   zname = &#39;周日&#39;.
</code></pre>
</li>
<li><pre><code> WHEN OTHERS.
</code></pre>
</li>
<li>ENDCASE.</li>
<li></li>
<li>zname &#x3D; zname &amp;&amp; ‘-‘ &amp;&amp; zdatum.</li>
<li>zzdys &#x3D; ‘Z’ &amp;&amp; zdatum.</li>
<li>macro_add_fieldcat:</li>
<li>zzdys zname ‘ZTA_SD002’ ‘ZXQSL’ ‘’ space space ‘’ space.</li>
<li>zdatum &#x3D; zdatum + 1.</li>
<li>ENDDO.</li>
<li>zdatum &#x3D; zdatum - 7.”周一日期</li>
<li>DO 4 TIMES.<br>**&amp;—查看日期在当前年度第几周</li>
<li>CLEAR:zweek.</li>
<li>CALL FUNCTION ‘DATE_GET_WEEK’</li>
<li><pre><code> EXPORTING
</code></pre>
</li>
<li><pre><code>   date         = zdatum
</code></pre>
</li>
<li><pre><code> IMPORTING
</code></pre>
</li>
<li><pre><code>   week         = zweek
</code></pre>
</li>
<li><pre><code> EXCEPTIONS
</code></pre>
</li>
<li><pre><code>   date_invalid = 1
</code></pre>
</li>
<li><pre><code>   OTHERS       = 2.
</code></pre>
</li>
<li>IF sy-subrc &lt;&gt; 0.</li>
</ul>
<p>** IMPLEMENT SUITABLE ERROR HANDLING HERE</p>
<ul>
<li>ENDIF.</li>
<li></li>
<li>zname &#x3D; ‘W’ &amp;&amp; zweek+4(2) &amp;&amp; ‘-‘ &amp;&amp; zdatum.</li>
<li>zzdys &#x3D; ‘ZW’ &amp;&amp; zdatum.</li>
<li>macro_add_fieldcat:</li>
<li>zzdys zname ‘ZTA_SD002’ ‘ZXQSL’ ‘’ space space ‘’ space.</li>
<li>zdatum &#x3D; zdatum + 7.</li>
<li>ENDDO.</li>
<li>macro_add_fieldcat:</li>
<li>‘ZJHZL’ ‘计划总量’ ‘ZTA_SD002’ ‘ZXQSL’ ‘’ space space space space,</li>
<li>‘ZYFPL’ ‘已分配量’ ‘ZTA_SD002’ ‘ZXQSL’ ‘’ space space space space,</li>
<li>‘ZLJCY’ ‘累计差异’ ‘ZTA_SD002’ ‘ZXQSL’ ‘’ space space space space.</li>
<li>**&amp;—生成动态内表</li>
<li>CALL METHOD cl_alv_table_create&#x3D;&gt;create_dynamic_table</li>
<li>EXPORTING</li>
</ul>
<p>**     I_STYLE_TABLE             &#x3D;</p>
<ul>
<li><pre><code> it_fieldcatalog           = gt_fieldcatalog1   &quot;输入FIELDCATALOG 将返回一个动态内表
</code></pre>
</li>
</ul>
<p>**     I_LENGTH_IN_BYTE          &#x3D;</p>
<ul>
<li>IMPORTING</li>
<li><pre><code> ep_table                  = lt_new_table  &quot;获取返回的动态内表 (类)
</code></pre>
</li>
</ul>
<p>**     E_STYLE_FNAME             &#x3D;</p>
<ul>
<li>EXCEPTIONS</li>
<li><pre><code> generate_subpool_dir_full = 1
</code></pre>
</li>
<li><pre><code> OTHERS                    = 2.
</code></pre>
</li>
<li></li>
<li>IF sy-subrc &lt;&gt; 0.</li>
<li>EXIT.</li>
<li>ENDIF.</li>
<li></li>
<li>ASSIGN lt_new_table-&gt;* TO <ft_vb> .     “LT_NEW_TABLE 中的所有都被指向<FT_VB>（动态内表）</li>
<li>CREATE DATA ls_new_line LIKE LINE OF <ft_vb> .</li>
<li>ASSIGN ls_new_line-&gt;* TO <fs_vb> .      “LS_NEW_LINE 中的所有都被指向<FS_VB> （动态内表结构）<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ZSAVE<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_zsave USING zupdate.<br>*&amp;—抬头信息一致，因为日期不定，所以按照报表字段一个数据保存一行<br>  DATA:lt_zta_pp004        TYPE TABLE OF zta_pp004,<br>ls_zta_pp004_header TYPE zta_pp004,<br>ls_zta_pp004        TYPE zta_pp004.</li>
</ul>
<p>  LOOP AT <ft_vb> ASSIGNING FIELD-SYMBOL(<fs_vb>).<br>    MOVE-CORRESPONDING <fs_vb> TO ls_zta_pp004_header.<br>    ls_zta_pp004_header-zzdrq &#x3D; sy-datum.<br>    ls_zta_pp004_header-zzdr &#x3D; zoperator.</p>
<p>*&amp;—日期下的数量<br>    LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1 WHERE ( fieldname(1) &#x3D; ‘Z’ AND scrtext_s(1) &#x3D; ‘周’)<br>                                                      OR  ( fieldname(2) &#x3D; ‘ZW’ AND scrtext_s(1) &#x3D; ‘W’) .<br>      CLEAR:ls_zta_pp004.<br>      ls_zta_pp004 &#x3D; ls_zta_pp004_header.<br>      “抬头字段名称<br>      ls_zta_pp004-zdmc &#x3D; gs_fieldcatalog1-fieldname.<br>      ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE <fs_vb> TO FIELD-SYMBOL(<fs_vb01>).<br>      IF sy-subrc &#x3D; 0.<br>        “需求数量<br>        ls_zta_pp004-zsl &#x3D; <fs_vb01>.<br>      ENDIF.<br>      APPEND ls_zta_pp004 TO lt_zta_pp004.<br>    ENDLOOP.<br>  ENDLOOP.</p>
<p>  MODIFY zta_pp004 FROM TABLE lt_zta_pp004.<br>  IF sy-subrc &#x3D; 0.<br>    zupdate &#x3D; ‘X’.<br>  ELSE.<br>    CLEAR:zupdate.<br>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_DEL_YQJHDD<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; LT_PLAF<br><em>&amp;———————————————————————</em><br>FORM frm_del_yqjhdd  TABLES lt_plaf01 STRUCTURE plaf USING VALUE(zmatnr) VALUE(werks) VALUE(verid) VALUE(zblmll).<br>  DATA:return        TYPE bapireturn1,<br>       plannedorder  TYPE bapi_pldord-pldord_num,<br>       ls_headerdata TYPE bapiplaf_i1.<br>  “删除该物料工厂生产版本下这个小于等于当前时间的所有计划订单<br>  LOOP AT lt_plaf01 INTO DATA(ls_plaf01) WHERE matnr &#x3D; zmatnr<br>                                          AND pwwrk &#x3D; werks<br>                                          AND verid &#x3D; verid<br>                                          AND psttr &lt;&#x3D; sy-datum.<br>    plannedorder &#x3D; ls_plaf01-plnum.<br>    CLEAR:return.<br>    CALL FUNCTION ‘BAPI_PLANNEDORDER_DELETE’<br>      EXPORTING<br>        plannedorder &#x3D; plannedorder<br>      IMPORTING<br>        return       &#x3D; return.<br>    IF return-type &#x3D; ‘E’.<br>      ASSIGN COMPONENT ‘MSG’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; return-message.<br>      ENDIF.<br>      ASSIGN COMPONENT ‘ICON’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft> &#x3D; icon_red_light.<br>      ENDIF.<br>      MODIFY <ft_vb> FROM <fs_vb>.<br>      ROLLBACK WORK.<br>      EXIT.<br>    ENDIF.<br>  ENDLOOP.</p>
<p>  ASSIGN COMPONENT ‘ICON’ OF STRUCTURE <fs_vb> TO <ft>.<br>  IF sy-subrc &#x3D; 0.<br>    IF <ft> &#x3D; icon_red_light.<br>      EXIT.<br>    ELSE.<br>      ASSIGN COMPONENT ‘ZJZDRYQSL’ OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        IF <ft> &lt;&gt; 0.<br>          CLEAR:ls_headerdata,return.<br>          CLEAR:lv_mdv01.<br>          ls_headerdata-pldord_profile &#x3D; ‘LA’.<br>          SELECT SINGLE mdv01 INTO lv_mdv01 FROM mkal WHERE matnr &#x3D; zmatnr AND werks &#x3D; werks AND verid &#x3D; verid.<br>          IF lv_mdv01 &#x3D; ‘11009999’.<br>            ls_headerdata-pldord_profile &#x3D; ‘ZNB’.<br>          ENDIF.<br>          ls_headerdata-total_plord_qty &#x3D; <ft>.”订单数量<br>          ls_headerdata-fixed_scrap_qty &#x3D; <ft> * ( 1 - zblmll &#x2F; 100 ).”报废数量<br>          ls_headerdata-fixed_scrap_qty &#x3D; ceil( ls_headerdata-fixed_scrap_qty ).</p>
<ul>
<li><pre><code>     ls_headerdata-pldord_profile = &#39;LA&#39;.
    ls_headerdata-plng_scenario_lt = &#39;000&#39;.
    ls_headerdata-material = zmatnr.
    ls_headerdata-plan_plant = werks.
    ls_headerdata-version = verid.
    ls_headerdata-order_start_date = sy-datum.
    ls_headerdata-conversion_ind = &#39;X&#39;.
    ls_headerdata-bom_exp_fix_ind = &#39;X&#39;.
    CALL FUNCTION &#39;BAPI_PLANNEDORDER_CREATE&#39;
      EXPORTING
        headerdata = ls_headerdata
      IMPORTING
        return     = return.
    IF return-type = &#39;E&#39;.
      ASSIGN COMPONENT &#39;MSG&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
      IF sy-subrc = 0.
        &lt;ft&gt; = return-message.
      ENDIF.
      ASSIGN COMPONENT &#39;ICON&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
      IF sy-subrc = 0.
        &lt;ft&gt; = icon_red_light.
      ENDIF.
      MODIFY &lt;ft_vb&gt; FROM &lt;fs_vb&gt;.
      ROLLBACK WORK.
      EXIT.
    ENDIF.
  ENDIF.
ENDIF.
</code></pre>
  ENDIF.<br>ENDIF.</li>
</ul>
<p>ENDFORM.<br>FORM frm_fieldcat_hlb .<br>  CLEAR:gt_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘CELLCOLOR’.</p>
<ul>
<li>GS_FIELDCATALOG_01-SCRTEXT_S &#x3D; ‘工厂’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘ZCELLCOLOR’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘CELLCOLOR’.<br>  gs_fieldcatalog_01-no_out &#x3D; ‘X’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</li>
</ul>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘WERKS’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘工厂’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MARC’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘WERKS’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘MATNRHLB’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘组件物料’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘组件物料’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘MATNR’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘MAKTXHLB’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘组件物料描述’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘BISMT’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘BISMT’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘TEXT1’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘名称’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘名称’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MKAL’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘TEXT1’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘LABST’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘可用库存’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘可用库存’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘ZDJKC’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘收货冻结库存’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘收货冻结库存’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  gs_fieldcatalog_01-fieldname &#x3D; ‘ZJHWBL’.<br>  gs_fieldcatalog_01-scrtext_s &#x3D; ‘计划外补料’.<br>  gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_s.<br>  gs_fieldcatalog_01-coltext &#x3D; ‘计划外补料’.<br>  gs_fieldcatalog_01-edit &#x3D; ‘’.<br>  gs_fieldcatalog_01-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog_01-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.<br>  CLEAR:gs_fieldcatalog_01.</p>
<p>  LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1.<br>    “日期对应的数量全部需要三个字段<br>    IF ( gs_fieldcatalog1-fieldname(1) &#x3D; ‘Z’ AND gs_fieldcatalog1-scrtext_s(1) &#x3D; ‘周’ ).<br>      MOVE-CORRESPONDING gs_fieldcatalog1 TO gs_fieldcatalog_01.<br>      gs_fieldcatalog_01-fieldname &#x3D; gs_fieldcatalog1-fieldname &amp;&amp; ‘XQ’.<br>      gs_fieldcatalog_01-scrtext_m &#x3D; gs_fieldcatalog1-scrtext_m &amp;&amp; ‘-需求’.<br>      gs_fieldcatalog_01-scrtext_l &#x3D; gs_fieldcatalog_01-scrtext_m.<br>      gs_fieldcatalog_01-coltext &#x3D; gs_fieldcatalog_01-scrtext_m.<br>      CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.<br>      gs_fieldcatalog_01-ref_table &#x3D; ‘MAKT’.<br>      gs_fieldcatalog_01-ref_field &#x3D; ‘MAKTX’.</p>
<pre><code>  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.
  gs_fieldcatalog_01-fieldname = gs_fieldcatalog1-fieldname &amp;&amp; &#39;GG&#39;.
  gs_fieldcatalog_01-scrtext_m = gs_fieldcatalog1-scrtext_m &amp;&amp; &#39;-供给&#39;.
  gs_fieldcatalog_01-scrtext_l = gs_fieldcatalog_01-scrtext_m.
  gs_fieldcatalog_01-coltext = gs_fieldcatalog_01-scrtext_m.
  CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.
  gs_fieldcatalog_01-ref_table = &#39;MAKT&#39;.
  gs_fieldcatalog_01-ref_field = &#39;MAKTX&#39;.
  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.

  gs_fieldcatalog_01-fieldname = gs_fieldcatalog1-fieldname &amp;&amp; &#39;LJ&#39;.
  gs_fieldcatalog_01-scrtext_m = gs_fieldcatalog1-scrtext_m &amp;&amp; &#39;-累计差异&#39;.
  gs_fieldcatalog_01-scrtext_l = gs_fieldcatalog_01-scrtext_m.
  gs_fieldcatalog_01-coltext = gs_fieldcatalog_01-scrtext_m.
  CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.
  gs_fieldcatalog_01-ref_table = &#39;MAKT&#39;.
  gs_fieldcatalog_01-ref_field = &#39;MAKTX&#39;.
  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.
  CLEAR:gs_fieldcatalog_01.
ELSEIF gs_fieldcatalog1-fieldname(2) = &#39;ZW&#39; AND gs_fieldcatalog1-scrtext_s(1) = &#39;W&#39;.
  MOVE-CORRESPONDING gs_fieldcatalog1 TO gs_fieldcatalog_01.
  gs_fieldcatalog_01-fieldname = gs_fieldcatalog1-fieldname &amp;&amp; &#39;XQ&#39;.
  gs_fieldcatalog_01-scrtext_m = gs_fieldcatalog1-scrtext_m &amp;&amp; &#39;-需求&#39;.
  gs_fieldcatalog_01-scrtext_l = gs_fieldcatalog_01-scrtext_m.
  CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.
  gs_fieldcatalog_01-coltext = gs_fieldcatalog_01-scrtext_m.
  gs_fieldcatalog_01-ref_table = &#39;MAKT&#39;.
  gs_fieldcatalog_01-ref_field = &#39;MAKTX&#39;.

  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.
  gs_fieldcatalog_01-fieldname = gs_fieldcatalog1-fieldname &amp;&amp; &#39;GG&#39;.
  gs_fieldcatalog_01-scrtext_m = gs_fieldcatalog1-scrtext_m &amp;&amp; &#39;-供给&#39;.
  gs_fieldcatalog_01-scrtext_l = gs_fieldcatalog_01-scrtext_m.
  CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.
  gs_fieldcatalog_01-coltext = gs_fieldcatalog_01-scrtext_m.
  gs_fieldcatalog_01-ref_table = &#39;MAKT&#39;.
  gs_fieldcatalog_01-ref_field = &#39;MAKTX&#39;.
  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.

  gs_fieldcatalog_01-fieldname = gs_fieldcatalog1-fieldname &amp;&amp; &#39;LJ&#39;.
  gs_fieldcatalog_01-scrtext_m = gs_fieldcatalog1-scrtext_m &amp;&amp; &#39;-差异&#39;.
  gs_fieldcatalog_01-scrtext_l = gs_fieldcatalog_01-scrtext_m.
  CLEAR:gs_fieldcatalog_01-reptext,gs_fieldcatalog_01-scrtext_s.
  gs_fieldcatalog_01-coltext = gs_fieldcatalog_01-scrtext_m.
  gs_fieldcatalog_01-ref_table = &#39;MAKT&#39;.
  gs_fieldcatalog_01-ref_field = &#39;MAKTX&#39;.
  APPEND gs_fieldcatalog_01 TO gt_fieldcatalog_01.
  CLEAR:gs_fieldcatalog_01.
ENDIF.
</code></pre>
<p>  ENDLOOP.</p>
<p>  CLEAR:gs_fieldcatalog_01-edit.<br>  MODIFY gt_fieldcatalog_01 FROM gs_fieldcatalog_01 TRANSPORTING edit WHERE fieldname &lt;&gt; ‘ZJHWBL’.</p>
<p>*UNASSIGN :<FT_VB_HLB>,<FS_VB_HLB>.<br>*CLEAR :LT_NEW_TABLE_HLB,LS_NEW_LINE_HLB.<br>*&amp;—生成动态内表<br>  CALL METHOD cl_alv_table_create&#x3D;&gt;create_dynamic_table<br>    EXPORTING</p>
<ul>
<li><pre><code>I_STYLE_TABLE             =
it_fieldcatalog           = gt_fieldcatalog_01   &quot;输入FIELDCATALOG 将返回一个动态内表
</code></pre>
</li>
<li><pre><code>I_LENGTH_IN_BYTE          =
</code></pre>
<p>  IMPORTING<br>ep_table                  &#x3D; lt_new_table_hlb  “获取返回的动态内表 (类)</p>
</li>
<li><pre><code>E_STYLE_FNAME             =
</code></pre>
<p>  EXCEPTIONS<br>generate_subpool_dir_full &#x3D; 1<br>OTHERS                    &#x3D; 2.<br>IF sy-subrc &lt;&gt; 0.<br>  EXIT.<br>ENDIF.</p>
<p>ASSIGN lt_new_table_hlb-&gt;* TO <ft_vb_hlb> .     “LT_NEW_TABLE 中的所有都被指向<FT_VB>（动态内表）<br>CREATE DATA ls_new_line_hlb LIKE LINE OF <ft_vb_hlb> .<br>ASSIGN ls_new_line_hlb-&gt;* TO <fs_vb_hlb> .      “LS_NEW_LINE 中的所有都被指向<FS_VB> （动态内表结构）</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_GET_DATA_HLB<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_get_data_hlb .<br>  DATA:zenmng TYPE resb-enmng.<br>  DATA:zenmngsum TYPE resb-enmng.<br>  TYPES:BEGIN OF ty_resbcol,<br>          matnrhlb TYPE mara-matnr,<br>          werks    TYPE marc-werks,<br>          enmng    TYPE resb-enmng,<br>        END OF ty_resbcol.<br>  DATA:lt_resbcol TYPE TABLE OF ty_resbcol,<br>       ls_resbcol TYPE ty_resbcol.<br>  DATA:zggsum TYPE zta_sd002-zxqsl .<br>  TYPES:BEGIN OF ty_zta_pp001_headercol,<br>          zhhd   TYPE zta_pp001_header-zhhd,<br>          matnr  TYPE zta_pp001_item-matnr,<br>          zdatum TYPE zta_pp001_item-zdatum, “回货日期<br>          zsl2   TYPE zta_pp001_itemde-zsl2,<br>        END OF ty_zta_pp001_headercol.<br>  DATA:lt_zta_pp001_headercol TYPE TABLE OF ty_zta_pp001_headercol,<br>       ls_zta_pp001_headercol TYPE ty_zta_pp001_headercol.<br>  DATA: BEGIN OF xtab2 OCCURS 10,<br>          werks LIKE ekpo-werks,<br>          matnr LIKE ekpo-matnr,<br>          ebeln LIKE ekpo-ebeln,<br>          ebelp LIKE ekpo-ebelp,<br>          wesbs LIKE ekbe-wesbs,<br>          wesb2 LIKE ekbe-wesbs,        “ALRK014884 SW<br>          meinh LIKE ekpo-meins,        “ALRK014884 SW<br>        END OF xtab2.<br>  RANGES:xwerks FOR ekpo-werks.</p>
<p>  TYPES:BEGIN OF ty_mchb,<br>          matnr TYPE mchb-matnr,<br>          werks TYPE mchb-werks,<br>          clabs TYPE mchb-clabs,<br>        END OF ty_mchb.<br>  DATA:lt_mchbcol TYPE TABLE OF ty_mchb,<br>       ls_mchbcol TYPE ty_mchb.</p>
<p>  DATA:datuv TYPE stko-datuv.<br>  DATA:zljcy(16) TYPE p DECIMALS 3.<br>  DATA:zmatnr TYPE mara-matnr.<br>  DATA:zemeng TYPE stko-bmeng.<br>  DATA:zstlal TYPE mkal-stlal.<br>  DATA:zstlan TYPE mkal-stlan.<br>  DATA:zwerks TYPE marc-werks.</p>
<p>  TYPES:BEGIN OF ty_data,<br>          matnr TYPE mara-matnr,<br>          werks TYPE marc-werks,<br>          stlan TYPE mast-stlan,<br>          stlal TYPE mast-stlal,<br>        END OF ty_data.<br>  DATA:lt_data TYPE TABLE OF ty_data,<br>       ls_data TYPE ty_data.</p>
<p>*&amp;—获取当前日期周的周日<br>  CLEAR:zdatum_sunday,zdatum.<br>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING<br>      sunday &#x3D; zdatum_sunday.</p>
<p>  CLEAR:gt_stpox.<br>  LOOP AT <ft_vb> INTO <fs_vb>.<br>    “将排产数据传到核料表<br>    CLEAR:gs_hlb.<br>    ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      zmatnr &#x3D; <ft>.<br>    ENDIF.<br>    ASSIGN COMPONENT ‘STLAL’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      zstlal &#x3D; <ft>.<br>    ENDIF.<br>    ASSIGN COMPONENT ‘STLAN’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      zstlan &#x3D; <ft>.<br>    ENDIF.<br>    ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      zwerks &#x3D; <ft>.<br>    ENDIF.</p>
<p>*&amp;—展开成品BOM组件<br>    PERFORM frm_bom_expand USING zmatnr zstlal zstlan zwerks.</p>
<pre><code>CLEAR:znum.
znum = zdatum_sunday - sy-datum + 7.
zdatum = sy-datum.

DO znum TIMES.
  zdatum = zdatum + 1.
  zzdys = &#39;Z&#39; &amp;&amp; zdatum.
  ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
  IF sy-subrc = 0.
    zemeng = &lt;ft&gt;.
    PERFORM frm_bom USING zmatnr zstlal zstlan zwerks zemeng.
  ENDIF.
ENDDO.

zdatum = zdatum - 6.&quot;周一日期

DO 4 TIMES.
  zzdys = &#39;ZW&#39; &amp;&amp; zdatum.
  ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
  IF sy-subrc = 0.
    zemeng = &lt;ft&gt;.
    PERFORM frm_bom USING zmatnr zstlal zstlan zwerks zemeng.
  ENDIF.
  zdatum = zdatum + 7.
ENDDO.
</code></pre>
<p>  ENDLOOP.</p>
<p>*&amp;—按照主物料组件物料日期汇总数量<br>  CLEAR:gt_hlbcol,gs_hlbcol.<br>  LOOP AT gt_hlb INTO gs_hlb.<br>    MOVE-CORRESPONDING gs_hlb TO gs_hlbcol.<br>    COLLECT gs_hlbcol INTO gt_hlbcol.<br>  ENDLOOP.</p>
<p>  DELETE gt_hlb WHERE matnrhlb &#x3D; ‘’.<br>  SORT:gt_hlb BY  werks matnrhlb.<br>  DELETE ADJACENT DUPLICATES FROM gt_hlb COMPARING werks matnrhlb.</p>
<p>*&amp;—获取当前日期周的周日<br>  CLEAR:zdatum_sunday,zdatum.<br>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING<br>      sunday &#x3D; zdatum_sunday.</p>
<p>*&amp;—获取保存日期时间最大的回货单<br>  SELECT *<br>    FROM zta_pp001_header<br>    INTO TABLE @DATA(lt_zta_pp001_header_num).<br>  SORT:lt_zta_pp001_header_num DESCENDING BY zdatum zuzeit.</p>
<p>  READ TABLE lt_zta_pp001_header_num INTO DATA(ls_zta_pp001_header_num) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>    “查询组件物料的回货数量<br>    SELECT zta_pp001_header<del>zhhd,<br>           zta_pp001_item</del>zitem,<br>           zta_pp001_item<del>matnr,<br>           zta_pp001_itemde</del>zdatum,<br>           zta_pp001_itemde<del>zsl2<br>      FROM zta_pp001_header<br>      INNER JOIN zta_pp001_item ON zta_pp001_header</del>zhhd &#x3D; zta_pp001_item<del>zhhd<br>      INNER JOIN zta_pp001_itemde ON zta_pp001_item</del>zhhd &#x3D; zta_pp001_itemde<del>zhhd AND zta_pp001_item</del>zitem &#x3D; zta_pp001_itemde<del>zitem<br>      INTO TABLE @DATA(lt_zta_pp001_itemde)<br>      WHERE zta_pp001_item</del>zhhd &#x3D; @ls_zta_pp001_header_num-zhhd.<br>    SORT lt_zta_pp001_itemde BY matnr zdatum.<br>  ENDIF.</p>
<p>  “汇总同一回货单下不同行项目同一物料的的数量<br>  CLEAR:lt_zta_pp001_headercol,ls_zta_pp001_headercol.<br>  LOOP AT lt_zta_pp001_itemde INTO DATA(ls_zta_pp001_itemde01).<br>    MOVE-CORRESPONDING ls_zta_pp001_itemde01 TO ls_zta_pp001_headercol.<br>    COLLECT ls_zta_pp001_headercol INTO lt_zta_pp001_headercol.<br>  ENDLOOP.</p>
<p>  “回货单编号<br>  CLEAR:zhhdbh,tab_appl_tab2.<br>  READ TABLE lt_zta_pp001_itemde INTO DATA(ls_item) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>    zhhdbh &#x3D; ls_item-zhhd.<br>    tab_appl_tab2 &#x3D; ‘核料表’ &amp;&amp; ‘(‘ &amp;&amp; zhhdbh &amp;&amp; ‘)’.<br>  ELSE.<br>    CLEAR:zhhdbh.<br>    tab_appl_tab2 &#x3D; ‘核料表’ &amp;&amp; ‘(无)’.<br>  ENDIF.</p>
<p>  IF gt_hlb IS NOT INITIAL.</p>
<p>*&amp;—获取未清的生产订单数量放入计划外补料<br>    SELECT rsnum,<br>           rspos,<br>           rsart,</p>
<pre><code>       bdmng,
       enmng,
       matnr,
       werks
  FROM resb
  INTO TABLE @DATA(lt_resb)
  FOR ALL ENTRIES IN @gt_hlb
  WHERE matnr = @gt_hlb-matnrhlb
  AND   werks IN @s_werks
  AND   xloek &lt;&gt; &#39;X&#39;
  AND   xwaok =  &#39;X&#39;
  AND   kzear &lt;&gt; &#39;X&#39;
  AND   bdart = &#39;AR&#39;.
</code></pre>
<ul>
<li><pre><code> AND   bdter &lt;= @sy-datum.
</code></pre>
  “汇总组件物料的未清数量放入计划外补料<br>  CLEAR:lt_resbcol,ls_resbcol.<br>  LOOP AT lt_resb INTO DATA(ls_resb).<br>ls_resb-enmng &#x3D; ls_resb-bdmng - ls_resb-enmng.<br>MOVE-CORRESPONDING ls_resb TO ls_resbcol.<br>ls_resbcol-matnrhlb &#x3D; ls_resb-matnr.<br>COLLECT ls_resbcol INTO lt_resbcol.<br>  ENDLOOP.<br>  SORT:lt_resbcol BY matnrhlb werks.</li>
</ul>
<p>*&amp;—计划外补料-外协部分<br>    SELECT rsnum,<br>           rspos,<br>           rsart,</p>
<pre><code>       bdmng,
       matnr,
       werks,
       ebeln,
       ebelp
  FROM resb
  INTO TABLE @DATA(lt_resbwx)
  FOR ALL ENTRIES IN @gt_hlb
  WHERE matnr = @gt_hlb-matnrhlb
  AND   werks IN @s_werks
  AND   xloek &lt;&gt; &#39;X&#39;
  AND   kzear &lt;&gt; &#39;X&#39;
  AND   ebeln &lt;&gt; &#39;&#39;.
SORT:lt_resbwx BY matnr werks.

IF lt_resbwx IS NOT INITIAL.
  &quot;外协采购订单
  SELECT ekpo~ebeln,
         ekpo~ebelp
    FROM ekpo
    INNER JOIN ekko ON ekko~ebeln = ekpo~ebeln
    INTO TABLE @DATA(lt_ekpo)
    FOR ALL ENTRIES IN @lt_resbwx
    WHERE ekpo~ebeln = @lt_resbwx-ebeln
    AND   ekpo~ebelp = @lt_resbwx-ebelp
    AND   ekko~bsart IN (&#39;Z004&#39;,&#39;Z012&#39;,&#39;Z015&#39;).
  SORT:lt_ekpo BY ebeln ebelp.

  SELECT mblnr,
         mjahr,
         zeile,

         menge,
         matnr,
         werks,
         bwart,
         ebeln,
         ebelp
    FROM mseg
    INTO TABLE @DATA(lt_mseg)
    FOR ALL ENTRIES IN @lt_resbwx
    WHERE matnr = @lt_resbwx-matnr
    AND   werks = @lt_resbwx-werks
    AND   ebeln = @lt_resbwx-ebeln
    AND   ebelp = @lt_resbwx-ebelp
    AND   xauto &lt;&gt; &#39;X&#39;
    AND   bwart IN (&#39;541&#39;,&#39;542&#39;).
  SORT:lt_mseg BY matnr werks ebeln ebelp.
ENDIF.
</code></pre>
<p>*&amp;—旧物料号,描述<br>    SELECT mara<del>matnr,<br>           mara</del>bismt,<br>           mara<del>meins,<br>           makt</del>maktx<br>      FROM mara<br>      INNER JOIN makt ON mara<del>matnr &#x3D; makt</del>matnr AND makt<del>spras &#x3D; @sy-langu<br>      INTO TABLE @DATA(lt_mara)<br>      FOR ALL ENTRIES IN @gt_hlb<br>      WHERE mara</del>matnr &#x3D; @gt_hlb-matnrhlb.<br>    SORT:lt_mara BY matnr.</p>
<p>*&amp;—组件物料号描述<br>    SELECT makt<del>matnr,<br>           makt</del>maktx<br>      FROM makt<br>      INTO TABLE @DATA(lt_makt)<br>      FOR ALL ENTRIES IN @gt_hlb<br>      WHERE makt<del>matnr &#x3D; @gt_hlb-matnrhlb<br>      AND   makt</del>spras &#x3D; @sy-langu.<br>    SORT:lt_makt BY matnr.</p>
<p>*&amp;—可用库存<br>    SELECT mchb<del>matnr,<br>           mchb</del>werks,<br>           mchb<del>lgort,<br>           mchb</del>charg,<br>           mchb~clabs<br>      FROM mchb</p>
<ul>
<li><pre><code> INNER JOIN ZTAC_PP001 ON ZTAC_PP001~LGORT &lt;&gt; MCHB~LGORT
INTO TABLE @DATA(lt_mchb)
FOR ALL ENTRIES IN @gt_hlb
WHERE matnr = @gt_hlb-matnrhlb.
</code></pre>
<p>  SELECT * FROM ztac_pp001 INTO TABLE @DATA(lt_ztac_pp001) WHERE werks IN @s_werks AND pasch &#x3D; ‘PMC’ AND zactive &#x3D; ‘X’.</p>
<p>  LOOP AT lt_mchb INTO DATA(ls_mchb).<br>READ TABLE lt_ztac_pp001 INTO DATA(ls_ztac_pp001) WITH KEY lgort &#x3D; ls_mchb-lgort  werks &#x3D; ls_mchb-werks.<br>IF sy-subrc &#x3D; 0.<br>  CONTINUE.<br>ELSE.<br>  MOVE-CORRESPONDING ls_mchb TO ls_mchbcol.<br>  COLLECT ls_mchbcol INTO lt_mchbcol.<br>ENDIF.<br>  ENDLOOP.<br>ENDIF.</p>
<p>CLEAR:xwerks[].<br>xwerks-sign &#x3D; ‘I’.<br>xwerks-option &#x3D; ‘EQ’.<br>xwerks-low &#x3D; s_werks-low..<br>APPEND xwerks.</p>
<p>CLEAR:<ft_vb_hlb>.<br>LOOP AT gt_hlb INTO gs_hlb.<br>  CLEAR:<fs_vb_hlb>.<br>  READ TABLE lt_mara INTO DATA(ls_mara) WITH KEY matnr &#x3D; gs_hlb-matnrhlb BINARY SEARCH.<br>  IF sy-subrc &#x3D; 0.</p>
<pre><code>&quot;冻结库存
ASSIGN COMPONENT &#39;ZDJKC&#39; OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
IF sy-subrc = 0.
  CLEAR:xtab2[].
  CALL FUNCTION &#39;MB_SELECT_GR_BLOCKED_STOCK&#39;
    EXPORTING
      x_matnr = ls_mara-matnr
      x_meins = ls_mara-meins
    TABLES
      xtab2   = xtab2
      xwerks  = xwerks.
  LOOP AT xtab2.
    &lt;ft_hlb&gt; = &lt;ft_hlb&gt; + xtab2-wesbs.
  ENDLOOP.
ENDIF.

ASSIGN COMPONENT &#39;BISMT&#39; OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
IF sy-subrc = 0.
  &lt;ft_hlb&gt; = ls_mara-bismt.
ENDIF.
ASSIGN COMPONENT &#39;TEXT1&#39; OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
IF sy-subrc = 0.
  &lt;ft_hlb&gt; = ls_mara-maktx.
ENDIF.
</code></pre>
<p>  ENDIF.</p>
<p>  ASSIGN COMPONENT ‘MAKTXHLB’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>  IF sy-subrc &#x3D; 0.<br>READ TABLE lt_makt INTO DATA(ls_makt) WITH KEY matnr &#x3D; gs_hlb-matnrhlb.<br>IF sy-subrc &#x3D; 0.<br>  <ft_hlb> &#x3D; ls_makt-maktx.<br>ENDIF.<br>  ENDIF.</p>
<p>  ASSIGN COMPONENT ‘LABST’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>  IF sy-subrc &#x3D; 0.<br>READ TABLE lt_mchbcol INTO ls_mchbcol WITH KEY matnr &#x3D; gs_hlb-matnrhlb.<br>IF sy-subrc &#x3D; 0.<br>  <ft_hlb> &#x3D; ls_mchbcol-clabs.<br>  PERFORM frm_choose_dicimal CHANGING <ft_hlb> .”判断小数位是否显示<br>ENDIF.<br>  ENDIF.</p>
<p>  ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>  IF sy-subrc &#x3D; 0.<br><ft_hlb> &#x3D; gs_hlb-werks.<br>  ENDIF.<br>  ASSIGN COMPONENT ‘MATNRHLB’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>  IF sy-subrc &#x3D; 0.<br><ft_hlb> &#x3D; gs_hlb-matnrhlb.<br>  ENDIF.</p>
<p>  “计划外补料<br>  CLEAR:zenmngsum.<br>  ASSIGN COMPONENT ‘ZJHWBL’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>  IF sy-subrc &#x3D; 0.</p>
<pre><code>&quot;外协部分
LOOP AT lt_resbwx INTO DATA(ls_resbwx) WHERE matnr = gs_hlb-matnrhlb.
  READ TABLE lt_ekpo INTO DATA(ls_ekpo) WITH KEY ebeln = ls_resbwx-ebeln ebelp = ls_resbwx-ebelp BINARY SEARCH.
  IF sy-subrc = 0.
    &quot;汇总采购凭证行项目数量
    CLEAR:zenmng.
    LOOP AT lt_mseg INTO DATA(ls_mseg) WHERE matnr = ls_resbwx-matnr
                                         AND werks = ls_resbwx-werks
                                         AND ebeln = ls_resbwx-ebeln
                                         AND ebelp = ls_resbwx-ebelp.
      IF ls_mseg-bwart = &#39;542&#39;.
        zenmng = zenmng - ls_mseg-menge.
      ELSEIF ls_mseg-bwart = &#39;541&#39;.
        zenmng = zenmng + ls_mseg-menge.
      ENDIF.
    ENDLOOP.
    zenmng = ls_resbwx-bdmng - zenmng.
    IF zenmng &lt; 0.
    ELSE.
      zenmngsum = zenmngsum + zenmng.
    ENDIF.
  ENDIF.
ENDLOOP.

CLEAR:zenmng.
READ TABLE lt_resbcol INTO ls_resbcol WITH KEY matnrhlb = gs_hlb-matnrhlb werks = gs_hlb-werks BINARY SEARCH.
IF sy-subrc &lt;&gt; 0.
  CLEAR:ls_resbcol.
ELSE.
  zenmng = zenmng + ls_resbcol-enmng.
ENDIF.

&lt;ft_hlb&gt; = zenmngsum + zenmng.
PERFORM frm_choose_dicimal CHANGING &lt;ft_hlb&gt; .&quot;判断小数位是否显示
</code></pre>
<p>  ENDIF.</p>
<p>  CLEAR:znum.<br>  znum &#x3D; zdatum_sunday - sy-datum + 7.<br>  zdatum &#x3D; sy-datum.</p>
<p>  CLEAR:p_cellcolor,zggsum.<br>  DO znum TIMES.<br>zdatum &#x3D; zdatum + 1.<br>zname &#x3D; zname &amp;&amp; ‘-‘ &amp;&amp; zdatum.<br>zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘XQ’.<br>ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>IF sy-subrc &#x3D; 0.<br>  READ TABLE gt_hlbcol INTO gs_hlbcol WITH KEY werks &#x3D; gs_hlb-werks matnrhlb &#x3D; gs_hlb-matnrhlb zrq &#x3D; zdatum.<br>  IF sy-subrc &#x3D; 0.<br>    <ft_hlb> &#x3D; gs_hlbcol-zsl .<br>    PERFORM frm_choose_dicimal CHANGING <ft_hlb> .”判断小数位是否显示<br>    zljcy &#x3D; zljcy - <ft_hlb>.<br>  ENDIF.<br>ENDIF.<br><br>zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘GG’.<br>ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>IF sy-subrc &#x3D; 0.<br>  “回货物料有4天的质检期，所以需要匹配提前4天的组件物料<br>  READ TABLE lt_zta_pp001_headercol INTO ls_zta_pp001_headercol WITH KEY matnr &#x3D; gs_hlb-matnrhlb zdatum &#x3D; zdatum - s_advan-low BINARY SEARCH.<br>  IF sy-subrc &#x3D; 0.<br>    <ft_hlb> &#x3D; ls_zta_pp001_headercol-zsl2.<br>    PERFORM frm_choose_dicimal CHANGING <ft_hlb> .”判断小数位是否显示<br>    zljcy &#x3D; zljcy + <ft_hlb>.<br>    zggsum &#x3D; zggsum + <ft_hlb>.<br>  ENDIF.<br>ENDIF.<br><br>zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘LJ’.<br>ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>IF sy-subrc &#x3D; 0.<br>  <ft_hlb> &#x3D; zljcy.<br>  PERFORM frm_choose_dicimal CHANGING <ft_hlb> .”判断小数位是否显示<br>  IF <ft_hlb> &lt; 0.</p>
</li>
</ul>
<p>*&amp;—单元格颜色设置<br>          PERFORM fill_cellcolor USING zzdys01.<br>        ENDIF.<br>      ENDIF.<br>    ENDDO.<br>    CLEAR:zljcy.<br>    zdatum &#x3D; zdatum - 6.”周一日期</p>
<pre><code>DATA(znumweek) = 1.&quot;记录每行数据按周复制的次数
DATA(zweekend) = zdatum_sunday.&quot;每周周末日期
DO 4 TIMES.
  zzdys01 = &#39;ZW&#39; &amp;&amp; zdatum &amp;&amp; &#39;XQ&#39;.
  ASSIGN COMPONENT zzdys01 OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
  IF sy-subrc = 0.
    READ TABLE gt_hlbcol INTO gs_hlbcol WITH KEY werks = gs_hlb-werks matnrhlb = gs_hlb-matnrhlb zrq = zdatum.
    IF sy-subrc = 0.
      &lt;ft_hlb&gt; = gs_hlbcol-zsl .
      PERFORM frm_choose_dicimal CHANGING &lt;ft_hlb&gt; .&quot;判断小数位是否显示
    ENDIF.
  ENDIF.

  zzdys01 = &#39;ZW&#39; &amp;&amp; zdatum &amp;&amp; &#39;GG&#39;.
  ASSIGN COMPONENT zzdys01 OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
  IF sy-subrc = 0.

    IF znumweek = 1.&quot;前两周汇总列
      &lt;ft_hlb&gt; = zggsum.
    ELSEIF znumweek = 2.&quot;第一周需要加上向前推进天的回货量
      LOOP AT lt_zta_pp001_headercol INTO ls_zta_pp001_headercol WHERE matnr = gs_hlb-matnrhlb
                                                         AND zdatum &gt; zweekend - s_advan-low           &quot;上周末向前推4天
                                                         AND zdatum &lt;= zweekend + 7.         &quot;本周末
        &lt;ft_hlb&gt; = &lt;ft_hlb&gt; + ls_zta_pp001_headercol-zsl2.
      ENDLOOP.
    ELSE.&quot;后两周列
      LOOP AT lt_zta_pp001_headercol INTO ls_zta_pp001_headercol WHERE matnr = gs_hlb-matnrhlb
                                                                   AND zdatum &gt; zweekend               &quot;上周末
                                                                   AND zdatum &lt;= zweekend + 7.         &quot;本周末
        &lt;ft_hlb&gt; = &lt;ft_hlb&gt; + ls_zta_pp001_headercol-zsl2.
      ENDLOOP.
    ENDIF.
    PERFORM frm_choose_dicimal CHANGING &lt;ft_hlb&gt; .&quot;判断小数位是否显示
  ENDIF.

  zzdys01 = &#39;ZW&#39; &amp;&amp; zdatum &amp;&amp; &#39;LJ&#39;.
  ASSIGN COMPONENT zzdys01 OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
  IF sy-subrc = 0.
    &lt;ft_hlb&gt; = ls_zta_pp001_headercol-zsl2 - gs_hlbcol-zsl.
    PERFORM frm_choose_dicimal CHANGING &lt;ft_hlb&gt; .&quot;判断小数位是否显示
    IF &lt;ft_hlb&gt; &lt; 0.
</code></pre>
<p>*&amp;—单元格颜色设置<br>          PERFORM fill_cellcolor USING zzdys01.<br>        ENDIF.<br>      ENDIF.<br>      zdatum &#x3D; zdatum + 7.<br>      znumweek &#x3D; znumweek + 1.<br>      zweekend &#x3D; zweekend + 7.<br>    ENDDO.<br>    ASSIGN COMPONENT ‘CELLCOLOR’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>    IF sy-subrc &#x3D; 0.<br>      <ft_hlb> &#x3D; p_cellcolor.<br>    ENDIF.<br>    APPEND <fs_vb_hlb> TO <ft_vb_hlb>.<br>  ENDLOOP.<br>  CLEAR:gt_hlb.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_BOM<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; <FS><br>*&amp;      –&gt; ZDATUM<br><em>&amp;———————————————————————</em><br>FORM frm_bom USING zmatnr zstlal zstlan zwerks zemeng.<br>  CLEAR:gs_hlb.<br>  gs_hlb-matnr &#x3D; zmatnr.<br>  gs_hlb-werks &#x3D; zwerks.<br>  gs_hlb-zrq &#x3D; zdatum.<br>  LOOP AT stb INTO DATA(ls_stb) WHERE dumps &#x3D; ‘’ AND mschg &lt;&gt; ‘X’.”排除虚拟件，排除组装物料<br>    “替代物料需要按照比例计算数量<br>    IF ls_stb-alpos &#x3D; ‘X’.<br>      ls_stb-menge &#x3D; ls_stb-menge * ls_stb-ewahr &#x2F; 100.<br>    ENDIF.<br>    gs_hlb-zsl &#x3D; ls_stb-mnglg &#x2F; 10000 * zemeng.<br>    gs_hlb-matnrhlb &#x3D; ls_stb-idnrk.<br>    gs_hlb-maktxhlb &#x3D; ls_stb-ojtxp.<br>    APPEND  gs_hlb TO gt_hlb.<br>  ENDLOOP.<br>ENDFORM.<br>**&amp;———————————————————————*<br>**&amp; FORM FRM_PC_HLB_COPY<br>**&amp;———————————————————————*<br>**&amp; TEXT<br>**&amp;———————————————————————*<br>**&amp; –&gt;  P1        TEXT<br>**&amp; &lt;–  P2        TEXT<br>**&amp;———————————————————————*<br>*FORM FRM_PC_HLB_COPY .</p>
<ul>
<li>ASSIGN COMPONENT ‘STLAL’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-STLAL &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘STLAN’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-STLAN &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘ZZDRQ’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-ZZDRQ &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-WERKS &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-MATNR &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘MAKTX’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-MAKTX &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘VERID’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-VERID &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘TEXT1’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-TEXT1 &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘MDV01’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-MDV01 &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘STKTX’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-STKTX &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘ZCBYXJ’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-ZCBYXJ &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘ZSFKFH’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-ZSFKFH &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘MTSTB’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-MTSTB &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘ZJHBZ’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-ZJHBZ &#x3D; <FT>.</li>
<li>ENDIF.</li>
<li>ASSIGN COMPONENT ‘ZJZDRYQSL’ OF STRUCTURE <FS_VB> TO <FT>.</li>
<li>IF SY-SUBRC &#x3D; 0.</li>
<li>GS_HLB-ZJZDRYQSL &#x3D; <FT>.</li>
<li>ENDIF.<br>*ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM ZHLB_GET_DATA OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;<br><em>&amp;———————————————————————</em><br>FORM zhlb_get_data.<br>  PERFORM frm_get_data_hlb.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_DATA_CHANGED_FINISHEDHLB<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; E_MODIFIED</li>
</ul>
<p>*&amp;      –&gt; ET_GOOD_CELLS<br><em>&amp;———————————————————————</em><br>FORM frm_data_changed_finishedhlb  USING    e_modified TYPE char01<br>                                       et_good_cells TYPE lvc_t_modi.<br>  DATA: ls_lvc_s_modi TYPE lvc_s_modi,<br>        zsqsl         TYPE char25,<br>        zmatnr        TYPE mara-matnr.<br>  DATA wa_cellcolor TYPE lvc_s_scol . “ 单元格颜色结构<br>*&amp;—将计划外补料加入后一天的需求量中即可<br>**—数据发生更改的标识<br>  IF e_modified &#x3D; ‘X’.<br>*&amp;—获取当前日期周的周日<br>    CLEAR:zdatum_sunday,zdatum.<br>    CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>      EXPORTING<br>        date   &#x3D; sy-datum<br>      IMPORTING<br>        sunday &#x3D; zdatum_sunday.<br>    CLEAR:znum.<br>    znum &#x3D; zdatum_sunday - sy-datum + 7.<br>    zdatum &#x3D; sy-datum.</p>
<pre><code>READ TABLE et_good_cells INTO DATA(es_good_cells) INDEX 1.
IF sy-subrc = 0.
  &quot;修改的变量名称
  READ TABLE &lt;ft_vb_hlb&gt; INTO &lt;fs_vb_hlb&gt; INDEX es_good_cells-row_id.
  IF sy-subrc = 0.
</code></pre>
<p>*&amp;—日期对应的数量<br>        zdatum &#x3D; sy-datum.<br>        zdatum01 &#x3D; zdatum + 1.<br>        CLEAR:zljcy,p_cellcolor.<br>        ASSIGN COMPONENT ‘CELLCOLOR’ OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>        IF sy-subrc &#x3D; 0.<br>          p_cellcolor &#x3D; <ft_hlb>.<br>        ENDIF.<br>        DO znum TIMES.<br>          zdatum &#x3D; zdatum + 1.<br>          zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘XQ’.<br>          ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft>.<br>          IF sy-subrc &#x3D; 0.<br>            zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘GG’.<br>            ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_hlb>.<br>            IF sy-subrc &#x3D; 0.<br>              zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘LJ’.<br>              ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_ljcy>.<br>              IF sy-subrc &#x3D; 0.<br>                zzdys01 &#x3D; ‘ZJHWBL’.<br>                ASSIGN COMPONENT zzdys01 OF STRUCTURE <fs_vb_hlb> TO <ft_jhwbl>.<br>                IF sy-subrc &#x3D; 0.<br>                  “计划外补料加到下一天<br>                  IF zdatum01 &#x3D; zdatum.<br>                    “差异计算<br>                    <ft_ljcy> &#x3D; <ft_hlb> - <ft> - <ft_jhwbl>.<br>                  ELSE.<br>                    “差异计算<br>                    <ft_ljcy> &#x3D; <ft_hlb> - <ft>.<br>                  ENDIF.<br>                  “累计差异<br>                  zljcy &#x3D; zljcy + <ft_ljcy>.<br>                  <ft_ljcy> &#x3D; zljcy.<br>                  zzdys01 &#x3D; ‘Z’ &amp;&amp; zdatum &amp;&amp; ‘LJ’.<br>                  IF <ft_ljcy> &lt; 0.<br>*&amp;—单元格颜色设置<br>                    “字段名<br>                    wa_cellcolor-fname &#x3D; zzdys01.<br>                    “颜色代码<br>                    wa_cellcolor-color-col &#x3D; ‘6’.<br>                    wa_cellcolor-color-int &#x3D; ‘1’.<br>                    wa_cellcolor-color-inv &#x3D; ‘0’.<br>                    APPEND wa_cellcolor TO p_cellcolor.</p>
<pre><code>              ELSE.
                DELETE p_cellcolor WHERE fname = zzdys01.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDDO.
    ASSIGN COMPONENT &#39;CELLCOLOR&#39; OF STRUCTURE &lt;fs_vb_hlb&gt; TO &lt;ft_hlb&gt;.
    IF sy-subrc = 0.
      &lt;ft_hlb&gt; = p_cellcolor.
    ENDIF.
    p_cellcolor = &lt;ft_hlb&gt;.
    MODIFY &lt;ft_vb_hlb&gt; FROM &lt;fs_vb_hlb&gt; INDEX es_good_cells-row_id.
  ENDIF.
ENDIF.
</code></pre>
<p>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ALV_REFRESHHLB<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM frm_alv_refreshhlb .<br>*&amp;—LAYOUT刷新<br>  CALL METHOD gr_table2-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table2-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>*&amp;—稳定刷新<br>  DATA:stbll TYPE lvc_s_stbl.<br>  stbll-row &#x3D; ‘X’.<br>  stbll-col &#x3D; ‘X’.<br>  CALL METHOD gr_table2-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FILL_CELLCOLOR<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM fill_cellcolor USING zname01.<br>  DATA wa_cellcolor TYPE lvc_s_scol . “ 单元格颜色结构<br>  DEFINE set_color.<br>    “字段名<br>    wa_cellcolor-fname &#x3D; &amp;1.<br>    “颜色代码<br>    wa_cellcolor-color-col &#x3D; ‘6’.<br>    wa_cellcolor-color-int &#x3D; ‘1’.<br>    wa_cellcolor-color-inv &#x3D; ‘0’.<br>    APPEND wa_cellcolor TO p_cellcolor.<br>  END-OF-DEFINITION.<br>  set_color zname01.<br>ENDFORM.<br>*&amp;———————————————————————*<br>*&amp; FORM FRM_XN_MATNR<br>*&amp;———————————————————————*<br>*&amp; TEXT<br>*&amp;———————————————————————*<br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_xn_matnr USING VALUE(gs_hlb-zsl)<br>                        VALUE(zmatnr)<br>                        VALUE(ls_marc-matnr)<br>                        VALUE(zwerks)<br>                        VALUE(zstlan)<br>                        VALUE(zdatum).<br>**&amp;—展开虚拟物料</p>
<ul>
<li>LOOP AT LT_STAS INTO LS_STAS WHERE MATNR &#x3D; LS_MARC-MATNR AND WERKS &#x3D; ZWERKS AND STLAN &#x3D; ZSTLAN AND DATUV &lt;&#x3D; ZDATUM.</li>
<li>GS_HLB-MATNR &#x3D; ZMATNR.”主物料</li>
<li>GS_HLB-MATNRHLB &#x3D; LS_STAS-IDNRK.”组件物料</li>
</ul>
<p>**&amp;—匹配虚拟物料的基本数量</p>
<ul>
<li><p>READ TABLE LT_MAST INTO LS_MAST WITH KEY MATNR &#x3D; GS_HLB-MATNRHLB WERKS &#x3D; ZWERKS STLAN &#x3D; ZSTLAN BINARY SEARCH.</p>
</li>
<li><p>IF SY-SUBRC &#x3D; 0.</p>
</li>
<li><pre><code> IF LS_MAST-BMENG &lt;&gt; 0.
</code></pre>
</li>
<li><pre><code>   GS_HLB-ZSL = GS_HLB-ZSL * LS_STAS-MENGE / LS_MAST-BMENG.&quot;对应的组件数量
</code></pre>
</li>
<li><pre><code> ENDIF.
</code></pre>
</li>
<li><p>ENDIF.</p>
</li>
<li><p>**&amp;—判断组件物料是否为虚拟物料，为虚拟物料则继续展开</p>
</li>
<li><p>READ TABLE LT_MARC INTO LS_MARC WITH KEY MATNR &#x3D; GS_HLB-MATNRHLB BINARY SEARCH.</p>
</li>
<li><p>IF SY-SUBRC &#x3D; 0.</p>
</li>
<li><pre><code> &quot;继续处理虚拟物料
</code></pre>
</li>
<li><pre><code> PERFORM FRM_XN_MATNR USING GS_HLB-ZSL ZMATNR LS_MARC-MATNR ZWERKS ZSTLAN ZDATUM.
</code></pre>
</li>
<li><p>ELSE.</p>
</li>
<li><pre><code> GS_HLB-WERKS = ZWERKS.
</code></pre>
</li>
<li><pre><code> GS_HLB-ZRQ = ZDATUM.
</code></pre>
</li>
<li><pre><code> APPEND GS_HLB TO GT_HLB.
</code></pre>
</li>
<li><pre><code> CLEAR:GS_HLB.
</code></pre>
</li>
<li><p>ENDIF.</p>
</li>
<li><p>ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; MODULE DISPLAY_GRID3 OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;<br><em>&amp;———————————————————————</em><br>*MODULE display_grid3 OUTPUT.<br>FORM display_grid3.<br>  IF container3 IS NOT BOUND.<br> IF cl_salv_table&#x3D;&gt;is_offline( ) EQ if_salv_c_bool_sap&#x3D;&gt;false.<br>   CREATE OBJECT container3<br> EXPORTING<br>   container_name &#x3D; ‘CONTAINER3’.<br> ENDIF.</p>
<p> CREATE OBJECT gr_table3<br>   EXPORTING<br> i_parent &#x3D; container3.</p>
</li>
<li><p>LAYOUT VARIANT OF TABSTRIP 2<br>  DATA: ls_variant TYPE disvariant.<br>  ls_variant-report &#x3D; sy-repid.<br>  ls_variant-handle &#x3D; ‘003’.</p>
<p>  DATA: lv_event_receiver TYPE REF TO lcl_event_receiver.<br>  CREATE OBJECT lv_event_receiver.</p>
</li>
</ul>
<p>*&amp;—数据改变</p>
<ul>
<li>SET HANDLER LV_EVENT_RECEIVER-&gt;HANDLE_DATA_CHANGED_FINISHED FOR GR_TABLE3.</li>
</ul>
<pre><code>gs_layout03-cwidth_opt   = &#39;X&#39;.
gs_layout03-zebra   = &#39;X&#39;.
gs_layout03-sel_mode   = &#39;A&#39;.
CALL METHOD gr_table3-&gt;set_table_for_first_display
  EXPORTING
    is_layout       = gs_layout03
    is_variant      = ls_variant
    i_save          = &#39;A&#39;
  CHANGING
    it_fieldcatalog = gt_fieldcatalog3
    it_outtab       = &lt;ft_vb_bom&gt;.
</code></pre>
<ul>
<li>“回车事件</li>
<li>CALL METHOD GR_TABLE2-&gt;REGISTER_EDIT_EVENT</li>
<li><pre><code> EXPORTING
</code></pre>
</li>
<li><pre><code>   I_EVENT_ID = CL_GUI_ALV_GRID=&gt;MC_EVT_ENTER
</code></pre>
</li>
<li><pre><code> EXCEPTIONS
</code></pre>
</li>
<li><pre><code>   ERROR      = 1
</code></pre>
</li>
<li><pre><code>   OTHERS     = 2.
</code></pre>
</li>
</ul>
<p>**&amp;—失去焦点触发</p>
<ul>
<li>CALL METHOD GR_TABLE2-&gt;REGISTER_EDIT_EVENT</li>
<li><pre><code> EXPORTING
</code></pre>
</li>
<li><pre><code>   I_EVENT_ID = CL_GUI_ALV_GRID=&gt;MC_EVT_MODIFIED
</code></pre>
</li>
<li><pre><code> EXCEPTIONS
</code></pre>
</li>
<li><pre><code>   ERROR      = 1
</code></pre>
</li>
<li><pre><code>   OTHERS     = 2.
</code></pre>
</li>
<li>IF SY-SUBRC &lt;&gt; 0.</li>
<li><pre><code> MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
</code></pre>
</li>
<li><pre><code> WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
</code></pre>
</li>
<li>ENDIF.</li>
</ul>
<p>  ELSE.<br>    CALL METHOD gr_table3-&gt;refresh_table_display.</p>
<ul>
<li>PERFORM FRM_ALV_REFRESHHLB.”ALV刷新</li>
</ul>
<p>  ENDIF.<br>ENDFORM.<br>*ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp; FORM GET_DATA_BOM OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;<br><em>&amp;———————————————————————</em><br>FORM get_data_bom.<br>  DATA:stb    TYPE TABLE OF stpox,<br>       s_stb  TYPE stpox,<br>       zemeng TYPE stko-bmeng,<br>       zmatnr TYPE mara-matnr,<br>       zjhzl  TYPE stko-bmeng,<br>       zindex TYPE i,<br>       zverid TYPE plaf-verid,<br>       zwerks TYPE marc-werks.</p>
<p>  TYPES:BEGIN OF ty_index,<br>          matnr TYPE mara-matnr,<br>          verid TYPE plaf-verid,<br>          idnrk TYPE mara-matnr,<br>          index TYPE i,<br>          zljxq TYPE stko-bmeng,<br>        END OF ty_index.<br>  DATA:lt_index TYPE TABLE OF ty_index,<br>       ls_index TYPE ty_index.</p>
<p>  TYPES:BEGIN OF ty_stbcol,<br>          matnr TYPE mara-matnr,<br>          idnrk TYPE mara-matnr,<br>          ojtxp TYPE makt-maktx,<br>          matmk TYPE stpox-matmk,<br>          mnglg TYPE stko-bmeng,<br>        END OF ty_stbcol.<br>  DATA:lt_stbcol TYPE TABLE OF ty_stbcol,<br>       ls_stbcol TYPE ty_stbcol.</p>
<p>*&amp;—获取当前日期周的周日<br>  CLEAR:zdatum_sunday,zdatum,lt_index.<br>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING<br>      sunday &#x3D; zdatum_sunday.</p>
<p>*&amp;—组件旧物料号<br>  SELECT matnr,<br>         bismt<br>    FROM mara<br>    INTO TABLE @DATA(lt_mara).<br>  SORT:lt_mara BY matnr.</p>
<p>*&amp;—基本用量,旧物料号<br>*1、物料MATNR+工厂WERKS+生产版本VERID去表MKAL取出物料BOM的用途STLAN+备选STLAL；<br>*2、依据物料MATNR+用途STLAN+备选STLAL去表MAST中取出物料清单<br>*3、物料清单STLNR加备选STLAL获取STKO-BMENG<br>  SELECT mkal<del>matnr,<br>         mkal</del>werks,<br>         mkal<del>verid,<br>         mkal</del>mdv01,<br>         mkal<del>stlal,<br>         mkal</del>stlan,<br>         mast<del>stlnr,<br>         stko</del>zjwlh,<br>         stko<del>bmeng<br>    FROM mkal<br>    INNER JOIN mast ON mkal</del>matnr &#x3D; mast<del>matnr AND mkal</del>stlal &#x3D; mast<del>stlal AND mkal</del>stlan &#x3D; mast<del>stlan<br>    INNER JOIN stko ON mast</del>stlnr &#x3D; stko<del>stlnr AND mast</del>stlal &#x3D; stko<del>stlal<br>    INTO TABLE @DATA(lt_stko)<br>    WHERE mkal</del>werks IN @s_werks.<br>  SORT:lt_stko BY matnr werks verid.</p>
<p>  CLEAR:znum,zindex.<br>  znum &#x3D; zdatum_sunday - sy-datum + 7.<br>  CLEAR:zdatum_first.<br>  zdatum_first &#x3D; zdatum_sunday + 1.”下周一<br>  zdatum_sunday &#x3D; zdatum_sunday + 7.</p>
<p>*&amp;—排产表到BOM清单<br>  SORT:gt_stpox BY matnrcp werkscp zstlalcp zstlancp.<br>  CLEAR:<ft_vb_bom>.<br>  LOOP AT <ft_vb> INTO <fs_vb>.<br>    CLEAR:ls_index,zjhzl,<fs_vb_bom>.<br>    ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb> TO <ft>.<br>    IF sy-subrc &#x3D; 0.<br>      ASSIGN COMPONENT ‘WERKS’ OF STRUCTURE <fs_vb_bom> TO <ft_bom>.<br>      IF sy-subrc &#x3D; 0.<br>        <ft_bom> &#x3D;  <ft>.<br>        zwerks &#x3D; <ft_bom>.<br>      ENDIF.<br>    ENDIF.</p>
<pre><code>ASSIGN COMPONENT &#39;MATNR&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
IF sy-subrc = 0.
  ASSIGN COMPONENT &#39;MATNR&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
  IF sy-subrc = 0.
    &lt;ft_bom&gt; =  &lt;ft&gt;.
    zmatnr = &lt;ft_bom&gt;.
    ls_index-matnr = zmatnr.
  ENDIF.
ENDIF.

ASSIGN COMPONENT &#39;MAKTX&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
IF sy-subrc = 0.
  ASSIGN COMPONENT &#39;MAKTX&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
  IF sy-subrc = 0.
    &lt;ft_bom&gt; =  &lt;ft&gt;.
  ENDIF.
ENDIF.

ASSIGN COMPONENT &#39;VERID&#39; OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
IF sy-subrc = 0.
  ASSIGN COMPONENT &#39;VERID&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
  IF sy-subrc = 0.
    &lt;ft_bom&gt; =  &lt;ft&gt;.
    zverid = &lt;ft_bom&gt;.
  ENDIF.
ENDIF.

READ TABLE lt_stko INTO DATA(ls_stko) WITH KEY matnr = zmatnr werks = zwerks verid = zverid BINARY SEARCH.
IF sy-subrc = 0.
  &quot;基本用量
  ASSIGN COMPONENT &#39;BMENG&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
  IF sy-subrc = 0.
    &lt;ft_bom&gt; =  ls_stko-bmeng.
    PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
  ENDIF.
  &quot;旧物料号
  ASSIGN COMPONENT &#39;BISMT&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
  IF sy-subrc = 0.
    &lt;ft_bom&gt; =  ls_stko-zjwlh.
  ENDIF.
ENDIF.

&quot;保留主键信息
ASSIGN &lt;fs_vb_bom&gt; TO &lt;fs_bom_header&gt;.

CLEAR:stb.
</code></pre>
<p>*&amp;—获取BOM组件物料号<br>    READ TABLE gt_stpox INTO gs_stpox WITH KEY matnrcp &#x3D; zmatnr werkscp &#x3D; zwerks zstlalcp &#x3D; ls_stko-stlal zstlancp &#x3D; ls_stko-stlan BINARY SEARCH.<br>    “缓存中存在组件信息<br>    IF sy-subrc &#x3D; 0.<br>      “将缓存信息放入组件内表<br>      LOOP AT gt_stpox INTO gs_stpox WHERE matnrcp &#x3D; zmatnr<br>                                       AND werkscp &#x3D; zwerks<br>                                       AND zstlalcp &#x3D; ls_stko-stlal<br>                                       AND zstlancp &#x3D; ls_stko-stlan.<br>        MOVE-CORRESPONDING gs_stpox TO s_stb.<br>        APPEND s_stb TO stb.<br>      ENDLOOP.</p>
<pre><code>ELSE.&quot;缓存中不存在，则执行BOM展开函数

  CALL FUNCTION &#39;CS_BOM_EXPL_MAT_V2&#39;
    EXPORTING
      capid                 = &#39;PP01&#39;
      datuv                 = sy-datum
      emeng                 = 10000 &quot;为了获取包材的单位用量
      mktls                 = &#39;X&#39;
      mdmps                 = &#39;X&#39;
      mehrs                 = &#39;X&#39;
      mtnrv                 = zmatnr
      postp                 = &#39;L&#39;
      stlal                 = ls_stko-stlal
      stlan                 = ls_stko-stlan
      stpst                 = 0
      svwvo                 = &#39;X&#39;
      werks                 = zwerks
      vrsvo                 = &#39;X&#39;
    TABLES
      stb                   = stb
    EXCEPTIONS
      alt_not_found         = 1
      call_invalid          = 2
      material_not_found    = 3
      missing_authorization = 4
      no_bom_found          = 5
      no_plant_data         = 6
      no_suitable_bom_found = 7
      conversion_error      = 8
      OTHERS                = 9.
ENDIF.
</code></pre>
<p>*&amp;—合并相同的组件<br>    CLEAR:lt_stbcol,ls_stbcol.<br>    ls_stbcol-matnr &#x3D; zmatnr.<br>    LOOP AT stb INTO DATA(ls_stb) WHERE dumps &#x3D; ‘’ AND mschg &lt;&gt; ‘X’.”排除虚拟件，排除组装物料.<br>      IF ls_stb-alpos &#x3D; ‘X’.<br>        ls_stb-mnglg &#x3D; ls_stb-mnglg * ls_stb-ewahr &#x2F; 100.<br>      ENDIF.<br>      MOVE-CORRESPONDING ls_stb TO ls_stbcol.<br>      COLLECT ls_stbcol INTO lt_stbcol.<br>    ENDLOOP.</p>
<p>*&amp;—不同日期对应的组件数量<br>    zdatum &#x3D; sy-datum.<br>    DO znum TIMES.<br>      zdatum &#x3D; zdatum + 1.<br>      zzdys &#x3D; ‘Z’ &amp;&amp; zdatum.<br>      “成品物料排产数量<br>      ASSIGN COMPONENT zzdys OF STRUCTURE <fs_vb> TO <ft>.<br>      IF sy-subrc &#x3D; 0.<br>        zemeng &#x3D; <ft>.</p>
<pre><code>    LOOP AT lt_stbcol INTO ls_stbcol.
      ls_stbcol-mnglg = ls_stbcol-mnglg /  10000.&quot;单位用量
      &quot;单位用量
      ASSIGN COMPONENT &#39;ZDWYL&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
      IF sy-subrc = 0.
        &lt;ft_bom&gt; = ls_stbcol-mnglg.
      ENDIF.

      ls_stbcol-mnglg = ls_stbcol-mnglg * zemeng.&quot;需求数量*单位用量
      &quot;包材组件，需要向上取整
      IF ls_stbcol-matmk = &#39;101001&#39; OR
         ls_stbcol-matmk = &#39;101002&#39; OR
         ls_stbcol-matmk = &#39;101003&#39; OR
         ls_stbcol-matmk = &#39;101004&#39; OR
         ls_stbcol-matmk = &#39;101005&#39; OR
         ls_stbcol-matmk = &#39;101006&#39; OR
         ls_stbcol-matmk = &#39;400302&#39; OR
         ls_stbcol-matmk = &#39;400303&#39; OR
         ls_stbcol-matmk = &#39;400304&#39; OR
         ls_stbcol-matmk = &#39;400305&#39; OR
         ls_stbcol-matmk = &#39;400306&#39; OR
         ls_stbcol-matmk = &#39;400307&#39; OR
         ls_stbcol-matmk = &#39;400308&#39; OR
         ls_stbcol-matmk = &#39;400309&#39; OR
         ls_stbcol-matmk = &#39;400310&#39; OR
         ls_stbcol-matmk = &#39;400311&#39; OR
         ls_stbcol-matmk = &#39;400312&#39; OR
         ls_stbcol-matmk = &#39;400201&#39; OR
         ls_stbcol-matmk = &#39;400101&#39;.
        ls_stbcol-mnglg = ceil( ls_stbcol-mnglg ).
      ENDIF.

      &quot;若有新的组件则新增一行，否则更改不同日期的数量即可
      &quot;读取行号
      READ TABLE lt_index INTO ls_index WITH KEY matnr = zmatnr idnrk = ls_stbcol-idnrk verid = zverid.
      IF sy-subrc = 0.
        READ TABLE &lt;ft_vb_bom&gt; INTO &lt;fs_vb_bom&gt; INDEX ls_index-index.
        &quot;组件物料
        ASSIGN COMPONENT &#39;MATNRZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-idnrk.
          ls_index-idnrk = ls_stbcol-idnrk.
        ENDIF.

        &quot;组件旧物料
        ASSIGN COMPONENT &#39;BISMTZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          READ TABLE lt_mara INTO DATA(ls_mara) WITH KEY matnr = ls_stbcol-idnrk BINARY SEARCH.
          &lt;ft_bom&gt; =  ls_mara-bismt.
          CLEAR:ls_mara.
        ENDIF.

        &quot;组件物料描述
        ASSIGN COMPONENT &#39;MAKTXZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-ojtxp.
        ENDIF.

        &quot;组件数量
        zzdys = &#39;Z&#39; &amp;&amp; zdatum.
        ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; = ls_stbcol-mnglg.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.

        &quot;汇总下周7天的数量
        IF zdatum_first &lt;= zdatum AND zdatum &lt;= zdatum_sunday.
          zzdys = &#39;ZW&#39; &amp;&amp; zdatum.
          ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
          IF sy-subrc = 0.
            &lt;ft_bom&gt; = &lt;ft_bom&gt; + ls_stbcol-mnglg.
          ENDIF.
        ENDIF.

        &quot;更新累计组件数量
        ls_index-zljxq = ls_index-zljxq + ls_stbcol-mnglg.
        &quot;计划总量
        ASSIGN COMPONENT &#39;ZJHZL&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_index-zljxq.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.
        MODIFY lt_index FROM ls_index INDEX ls_index-index.
        &quot;更新ALV内表
        MODIFY &lt;ft_vb_bom&gt; FROM &lt;fs_vb_bom&gt; INDEX ls_index-index.
      ELSE.
        &quot;主键信息复制
        &lt;fs_vb_bom&gt; = &lt;fs_bom_header&gt;.
        &quot;组件物料
        ASSIGN COMPONENT &#39;MATNRZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-idnrk.
          ls_index-idnrk = ls_stbcol-idnrk.
        ENDIF.

        &quot;组件旧物料
        ASSIGN COMPONENT &#39;BISMTZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          READ TABLE lt_mara INTO ls_mara WITH KEY matnr = ls_stbcol-idnrk BINARY SEARCH.
          &lt;ft_bom&gt; =  ls_mara-bismt.
          CLEAR:ls_mara.
        ENDIF.

        &quot;组件物料描述
        ASSIGN COMPONENT &#39;MAKTXZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-ojtxp.
        ENDIF.

        &quot;组件数量
        zzdys = &#39;Z&#39; &amp;&amp; zdatum.
        ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; = ls_stbcol-mnglg.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.

        &quot;汇总下周7天的数量
        IF zdatum_first &lt;= zdatum AND zdatum &lt;= zdatum_sunday.
          zzdys = &#39;ZW&#39; &amp;&amp; zdatum.
          ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
          IF sy-subrc = 0.
            &lt;ft_bom&gt; = &lt;ft_bom&gt; + ls_stbcol-mnglg.
          ENDIF.
        ENDIF.

        &quot;组件累计需求
        ls_index-zljxq = ls_stbcol-mnglg.
        &quot;计划总量
        ASSIGN COMPONENT &#39;ZJHZL&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_index-zljxq.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.
        &quot;将新组件物料备份
        &quot;记录内表中成品物料加组件物料的行号，便于MODIFY时读取行号
        zindex = zindex + 1.
        ls_index-index = zindex.
        ls_index-verid = zverid.
        APPEND ls_index TO lt_index.
        APPEND &lt;fs_vb_bom&gt; TO &lt;ft_vb_bom&gt;.
      ENDIF.
    ENDLOOP.
  ENDIF.
ENDDO.

zdatum = zdatum + 1.


DO 3 TIMES.
  zzdys = &#39;ZW&#39; &amp;&amp; zdatum.
  ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb&gt; TO &lt;ft&gt;.
  IF sy-subrc = 0.
    zemeng = &lt;ft&gt;.

    &quot;若有新的组件则新增一行，否则更改不同日期的数量即可
    LOOP AT lt_stbcol INTO ls_stbcol .
      ls_stbcol-mnglg = ls_stbcol-mnglg /  10000.&quot;单位用量
      ls_stbcol-mnglg = ls_stbcol-mnglg * zemeng.&quot;需求数量*单位用量
      &quot;包材组件，需要向上取整
      IF ls_stbcol-matmk = &#39;101001&#39; OR
         ls_stbcol-matmk = &#39;101002&#39; OR
         ls_stbcol-matmk = &#39;101003&#39; OR
         ls_stbcol-matmk = &#39;101004&#39; OR
         ls_stbcol-matmk = &#39;101005&#39; OR
         ls_stbcol-matmk = &#39;101006&#39; OR
         ls_stbcol-matmk = &#39;400302&#39; OR
         ls_stbcol-matmk = &#39;400303&#39; OR
         ls_stbcol-matmk = &#39;400304&#39; OR
         ls_stbcol-matmk = &#39;400305&#39; OR
         ls_stbcol-matmk = &#39;400306&#39; OR
         ls_stbcol-matmk = &#39;400307&#39; OR
         ls_stbcol-matmk = &#39;400308&#39; OR
         ls_stbcol-matmk = &#39;400309&#39; OR
         ls_stbcol-matmk = &#39;400310&#39; OR
         ls_stbcol-matmk = &#39;400311&#39; OR
         ls_stbcol-matmk = &#39;400312&#39; OR
         ls_stbcol-matmk = &#39;400201&#39; OR
         ls_stbcol-matmk = &#39;400101&#39;.
        ls_stbcol-mnglg = ceil( ls_stbcol-mnglg ).
      ENDIF.

      &quot;读取行号
      READ TABLE lt_index INTO ls_index WITH KEY matnr = zmatnr idnrk = ls_stbcol-idnrk verid = zverid.
      IF sy-subrc = 0.
        READ TABLE &lt;ft_vb_bom&gt; INTO &lt;fs_vb_bom&gt; INDEX ls_index-index.
        &quot;组件物料
        ASSIGN COMPONENT &#39;MATNRZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-idnrk.
          ls_index-idnrk = ls_stbcol-idnrk.
        ENDIF.

        &quot;组件旧物料
        ASSIGN COMPONENT &#39;BISMTZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          READ TABLE lt_mara INTO ls_mara WITH KEY matnr = ls_stbcol-idnrk BINARY SEARCH.
          &lt;ft_bom&gt; =  ls_mara-bismt.
          CLEAR:ls_mara.
        ENDIF.

        &quot;组件物料描述
        ASSIGN COMPONENT &#39;MAKTXZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-ojtxp.
        ENDIF.

        &quot;组件数量
        ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; = ls_stbcol-mnglg.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.
        &quot;更新累计组件数量
        ls_index-zljxq = ls_index-zljxq + ls_stbcol-mnglg.
        &quot;计划总量
        ASSIGN COMPONENT &#39;ZJHZL&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_index-zljxq.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.
        MODIFY lt_index FROM ls_index INDEX ls_index-index.
        &quot;更新ALV内表
        MODIFY &lt;ft_vb_bom&gt; FROM &lt;fs_vb_bom&gt; INDEX ls_index-index.
</code></pre>
<p>*&amp;—新增行<br>          ELSE.<br>            “主键信息复制<br>            <fs_vb_bom> &#x3D; <fs_bom_header>.<br>            “组件物料<br>            ASSIGN COMPONENT ‘MATNRZJ’ OF STRUCTURE <fs_vb_bom> TO <ft_bom>.<br>            IF sy-subrc &#x3D; 0.<br>              <ft_bom> &#x3D;  ls_stbcol-idnrk.<br>              ls_index-idnrk &#x3D; ls_stbcol-idnrk.<br>            ENDIF.</p>
<pre><code>        &quot;组件旧物料
        ASSIGN COMPONENT &#39;BISMTZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          READ TABLE lt_mara INTO ls_mara WITH KEY matnr = ls_stbcol-idnrk BINARY SEARCH.
          &lt;ft_bom&gt; =  ls_mara-bismt.
          CLEAR:ls_mara.
        ENDIF.

        &quot;组件物料描述
        ASSIGN COMPONENT &#39;MAKTXZJ&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_stbcol-ojtxp.
        ENDIF.

        &quot;组件数量
        ASSIGN COMPONENT zzdys OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; = ls_stbcol-mnglg.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.

        &quot;组件累计需求
        ls_index-zljxq = ls_stbcol-mnglg.
        &quot;计划总量
        ASSIGN COMPONENT &#39;ZJHZL&#39; OF STRUCTURE &lt;fs_vb_bom&gt; TO &lt;ft_bom&gt;.
        IF sy-subrc = 0.
          &lt;ft_bom&gt; =  ls_index-zljxq.
          PERFORM frm_choose_dicimal CHANGING &lt;ft_bom&gt; .&quot;判断小数位是否显示
        ENDIF.
        &quot;将新组件物料备份
        &quot;记录内表中成品物料加组件物料的行号，便于MODIFY时读取行号
        zindex = zindex + 1.
        ls_index-index = zindex.
        APPEND ls_index TO lt_index.
        APPEND &lt;fs_vb_bom&gt; TO &lt;ft_vb_bom&gt;.
      ENDIF.
    ENDLOOP.

  ENDIF.
  zdatum = zdatum + 7.
ENDDO.
</code></pre>
<p>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_FIELDCAT_BOM<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_fieldcat_bom .<br>  CLEAR:gt_fieldcatalog3,gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘WERKS’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘工厂’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘工厂’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MARC’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘WERKS’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘MATNR’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘模块代码’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘模块代码’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MATNR’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘BISMT’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘BISMT’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘MAKTX’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘物料名称’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘物料名称’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘MATNRZJ’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘物料代码’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘物料代码’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MATNR’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘BISMTZJ’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘旧物料号’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MARA’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘BISMT’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘MAKTXZJ’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘名称’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘名称’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘VERID’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘生产版本’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘生产版本’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘PLAF’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘VERID’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘BMENG’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘基本用量’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘基本用量’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘ZDWYL’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘单位用量’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘单位用量’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘ZTA_PP002’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘LFIMG’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>  LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1.<br>    “日期对应的数量全部需要三个字段<br>    IF ( gs_fieldcatalog1-fieldname(1) &#x3D; ‘Z’ AND gs_fieldcatalog1-scrtext_s(1) &#x3D; ‘周’ ).<br>      MOVE-CORRESPONDING gs_fieldcatalog1 TO gs_fieldcatalog3.<br>      gs_fieldcatalog3-coltext &#x3D; gs_fieldcatalog3-scrtext_l.<br>      CLEAR:gs_fieldcatalog3-edit.<br>      APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.<br>      CLEAR:gs_fieldcatalog3.<br>    ELSEIF gs_fieldcatalog1-fieldname(2) &#x3D; ‘ZW’ AND gs_fieldcatalog1-scrtext_s(1) &#x3D; ‘W’.<br>      MOVE-CORRESPONDING gs_fieldcatalog1 TO gs_fieldcatalog3.<br>      gs_fieldcatalog3-coltext &#x3D; gs_fieldcatalog3-scrtext_l.<br>      CLEAR:gs_fieldcatalog3-edit.<br>      APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.<br>      CLEAR:gs_fieldcatalog3.<br>    ENDIF.<br>  ENDLOOP.</p>
<p>  CLEAR:gs_fieldcatalog3.<br>  gs_fieldcatalog3-fieldname &#x3D; ‘ZJHZL’.<br>  gs_fieldcatalog3-scrtext_s &#x3D; ‘计划总量’.<br>  gs_fieldcatalog3-scrtext_l &#x3D; gs_fieldcatalog3-scrtext_s.<br>  gs_fieldcatalog3-coltext &#x3D; ‘计划总量’.<br>  gs_fieldcatalog3-ref_table &#x3D; ‘MAKT’.<br>  gs_fieldcatalog3-ref_field &#x3D; ‘MAKTX’.<br>  APPEND gs_fieldcatalog3 TO gt_fieldcatalog3.</p>
<p>*&amp;—生成动态内表<br>  CALL METHOD cl_alv_table_create&#x3D;&gt;create_dynamic_table<br>    EXPORTING</p>
<ul>
<li><pre><code>I_STYLE_TABLE             =
it_fieldcatalog           = gt_fieldcatalog3   &quot;输入FIELDCATALOG 将返回一个动态内表
</code></pre>
</li>
<li><pre><code>I_LENGTH_IN_BYTE          =
</code></pre>
<p>  IMPORTING<br>ep_table                  &#x3D; lt_new_table_bom  “获取返回的动态内表 (类)</p>
</li>
<li><pre><code>E_STYLE_FNAME             =
</code></pre>
<p>  EXCEPTIONS<br>generate_subpool_dir_full &#x3D; 1<br>OTHERS                    &#x3D; 2.<br>IF sy-subrc &lt;&gt; 0.<br>  EXIT.<br>ENDIF.</p>
<p>ASSIGN lt_new_table_bom-&gt;* TO <ft_vb_bom> .     “LT_NEW_TABLE 中的所有都被指向<FT_VB>（动态内表）<br>CREATE DATA lt_new_table_bom LIKE LINE OF <ft_vb_bom> .<br>ASSIGN lt_new_table_bom-&gt;* TO <fs_vb_bom> .      “LS_NEW_LINE 中的所有都被指向<FS_VB> （动态内表结构）</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_CHOOSE_DICIMAL<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_choose_dicimal CHANGING zsl.<br>  DATA:string01 TYPE string,<br>       string02 TYPE string.<br>  CLEAR:string01,string02.</p>
<p>  SPLIT zsl AT ‘.’ INTO string01 string02.<br>  IF string01 &#x3D; 0 AND string02 &#x3D; 0.”数据为0<br>    CLEAR:zsl.<br>  ELSE.<br>    DATA(zlength) &#x3D; strlen( zsl ) - 1.<br>    “负数先去掉负号，再判断<br>    IF zsl+zlength(1) &#x3D; ‘-‘.<br>      zsl &#x3D; zsl+(zlength).<br>      DATA(zflag) &#x3D; ‘-‘.<br>    ELSE.<br>      CLEAR:zflag.<br>    ENDIF.</p>
<pre><code>SPLIT zsl AT &#39;.&#39; INTO string01 string02.
IF string02 = 0.
  zsl = string01 &amp;&amp; zflag.
ELSE.
  IF strlen( string02 ) = 3.
    IF string02+2(1) = 0.
      zsl = string01 &amp;&amp; &#39;.&#39; &amp;&amp; string02(2) &amp;&amp; zflag.
    ELSEIF string02+1(1) = 0 AND string02+2(1) = 0.
      zsl = string01 &amp;&amp; &#39;.&#39; &amp;&amp; string02(1) &amp;&amp; zflag.
    ENDIF.
  ELSEIF strlen( string02 ) = 2.
    IF string02+1(1) = 0.
      zsl = string01 &amp;&amp; &#39;.&#39; &amp;&amp; string02(1) &amp;&amp; zflag.
    ENDIF.
  ENDIF.

ENDIF.
CONDENSE zsl NO-GAPS.
</code></pre>
<p>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ZDOWNLOAD<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_zdownload .</p>
<ul>
<li><p>用户选择保存路径<br>PERFORM frm_get_fullpath CHANGING p_pv_fullpath pv_path pv_name.</p>
</li>
<li><p>路径为空则退出<br>IF p_pv_fullpath IS INITIAL.<br>  MESSAGE ‘用户取消操作’ TYPE ‘S’.<br>  RETURN.<br>ENDIF.</p>
</li>
<li><p>下载模版文件<br>PERFORM frm_download_excel_from_server USING p_pv_fullpath.</p>
</li>
<li><p>打开EXCEL<br>PERFORM frm_open_excel USING p_pv_fullpath.</p>
</li>
</ul>
<p>*SHEET页复制</p>
<ul>
<li>PERFORM FRM_SHEET_COPY.</li>
</ul>
<p>*&amp;—EXCEL列字母和数字的映射表<br>  PERFORM frm_tab_col.</p>
<ul>
<li><p>向每一个SHEET页填充数据<br>PERFORM frm_fill_sheet .</p>
</li>
<li><p>保存文件<br>CALL METHOD OF myworkbook ‘SAVE’.</p>
</li>
<li><p>关闭文件<br>CALL METHOD OF myworkbook ‘CLOSE’.</p>
</li>
<li><p>退出EXCEL<br>CALL METHOD OF myexcel ‘QUIT’.</p>
</li>
<li><p>释放对象<br>FREE OBJECT mysheet.<br>FREE OBJECT myworkbook.<br>FREE OBJECT myexcel.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_ZUPLOAD<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_zupload .<br>DATA:rc  TYPE i.<br>DATA:p_path TYPE rlgrap-filename.</p>
</li>
</ul>
<p>*&amp;—获取文件路径<br>  PERFORM frm_get_file_path USING rc CHANGING p_path.</p>
<ul>
<li>路径为空则退出<br>IF p_path IS INITIAL.<br>  MESSAGE ‘用户取消操作’ TYPE ‘S’.<br>  RETURN.<br>ENDIF.</li>
</ul>
<p>*&amp;—获取数据<br>  PERFORM frm_get_excel_data USING p_path.</p>
<p>*&amp;—LAYOUT刷新<br>  CALL METHOD gr_table1-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  CALL METHOD gr_table2-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table2-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  CALL METHOD gr_table3-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table3-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  DATA:stbll TYPE lvc_s_stbl.<br>  stbll-row &#x3D; ‘X’.<br>  stbll-col &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>  CALL METHOD gr_table2-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>  CALL METHOD gr_table3-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.</p>
<p>  MESSAGE ‘数据上载完毕!’ TYPE ‘S’.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  FRM_GET_FULLPATH<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> &lt;--P_PV_FULLPATH  TEXT
</code></pre>
</li>
<li><pre><code> &lt;--P_PV_PATH  TEXT
</code></pre>
</li>
<li><pre><code> &lt;--P_PV_NAME  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM frm_get_fullpath  CHANGING p_pv_fullpath<br>                                p_pv_path<br>                                p_pv_name.<br>  DATA: pv_init_path  TYPE string,<br>        pv_init_fname TYPE string,<br>        pv_path       TYPE string,<br>        pv_filename   TYPE string,<br>        pv_fullpath   TYPE string.</p>
<ul>
<li><p>初始名称(输出的文件名称)<br>CONCATENATE ‘齐套检查表-‘ sy-datum ‘.XLSX’ INTO pv_init_fname.</p>
</li>
<li><p>获取桌面路径<br>CALL METHOD cl_gui_frontend_services&#x3D;&gt;get_desktop_directory<br>  CHANGING<br>desktop_directory    &#x3D; pv_init_path<br>  EXCEPTIONS<br>cntl_error           &#x3D; 1<br>error_no_gui         &#x3D; 2<br>not_supported_by_gui &#x3D; 3<br>OTHERS               &#x3D; 4.<br>IF sy-subrc &lt;&gt; 0.<br>  EXIT.<br>ENDIF.</p>
</li>
<li><p>用户选择名称、路径<br>CALL METHOD cl_gui_frontend_services&#x3D;&gt;file_save_dialog<br>  EXPORTING<br>default_file_name    &#x3D; pv_init_fname<br>file_filter          &#x3D; cl_gui_frontend_services&#x3D;&gt;filetype_excel<br>initial_directory    &#x3D; pv_init_path<br>prompt_on_overwrite  &#x3D; ‘X’<br>  CHANGING<br>filename             &#x3D; pv_filename<br>path                 &#x3D; pv_path<br>fullpath             &#x3D; pv_fullpath<br>  EXCEPTIONS<br>cntl_error           &#x3D; 1<br>error_no_gui         &#x3D; 2<br>not_supported_by_gui &#x3D; 3<br>OTHERS               &#x3D; 4.<br>IF sy-subrc &#x3D; 0.<br>  p_pv_fullpath &#x3D; pv_fullpath.<br>  p_pv_path     &#x3D; pv_path.<br>ENDIF.<br>ENDFORM.                    “ FRM_GET_FULLPATH<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  FRM_DOWNLOAD_EXCEL_FROM_SERVER</p>
</li>
</ul>
<p><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> --&gt;P_P_PV_FULLPATH  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM frm_download_excel_from_server USING pv_fullpath.<br>  DATA: lv_objdata     LIKE wwwdatatab,<br>        lv_mime        LIKE w3mime,<br>        lv_destination LIKE rlgrap-filename,<br>        lv_objnam      TYPE string,<br>        lv_rc          LIKE sy-subrc,<br>        lv_errtxt      TYPE string.</p>
<p>  DATA: lv_filename TYPE string,<br>        lv_result,<br>        lv_subrc    TYPE sy-subrc.</p>
<p>  DATA: lv_objid       TYPE wwwdatatab-objid .</p>
<p>  lv_objid &#x3D; ‘ZPP005’.  “上传的模版名称</p>
<p>  “查找文件是否存在。<br>  SELECT SINGLE relid objid<br>    FROM wwwdata<br>    INTO CORRESPONDING FIELDS OF lv_objdata<br>    WHERE srtf2    &#x3D; 0<br>    AND   relid    &#x3D; ‘MI’<br>    AND   objid    &#x3D; lv_objid.</p>
<p>  “判断模版不存在则报错<br>  IF sy-subrc NE 0 OR lv_objdata-objid EQ space.<br>    CONCATENATE ‘模板文件：’ lv_objid ‘不存在，请用TCODE：SMW0进行加载’<br>    INTO lv_errtxt.<br>    MESSAGE e000(su) WITH lv_errtxt.<br>  ENDIF.</p>
<p>  lv_filename &#x3D; pv_fullpath.</p>
<p>  “判断本地地址是否已经存在此文件。<br>  CALL METHOD cl_gui_frontend_services&#x3D;&gt;file_exist<br>    EXPORTING<br>      file                 &#x3D; lv_filename<br>    RECEIVING<br>      result               &#x3D; lv_result<br>    EXCEPTIONS<br>      cntl_error           &#x3D; 1<br>      error_no_gui         &#x3D; 2<br>      wrong_parameter      &#x3D; 3<br>      not_supported_by_gui &#x3D; 4<br>      OTHERS               &#x3D; 5.<br>  IF lv_result EQ ‘X’.  “如果存在则删除原始文件，重新覆盖<br>    CALL METHOD cl_gui_frontend_services&#x3D;&gt;file_delete<br>      EXPORTING<br>        filename             &#x3D; lv_filename<br>      CHANGING<br>        rc                   &#x3D; lv_subrc<br>      EXCEPTIONS<br>        file_delete_failed   &#x3D; 1<br>        cntl_error           &#x3D; 2<br>        error_no_gui         &#x3D; 3<br>        file_not_found       &#x3D; 4<br>        access_denied        &#x3D; 5<br>        unknown_error        &#x3D; 6<br>        not_supported_by_gui &#x3D; 7<br>        wrong_parameter      &#x3D; 8<br>        OTHERS               &#x3D; 9.<br>    IF lv_subrc &lt;&gt; 0. “如果删除失败，则报错。<br>      CONCATENATE ‘同名EXCEL文件已打开’ ‘请关闭该EXCEL后重试。’<br>      INTO lv_errtxt.<br>      MESSAGE e000(su) WITH lv_errtxt.<br>    ENDIF.<br>  ENDIF.</p>
<p>  lv_destination   &#x3D; pv_fullpath.</p>
<p>  “下载模版。<br>  CALL FUNCTION ‘DOWNLOAD_WEB_OBJECT’<br>    EXPORTING<br>      key         &#x3D; lv_objdata<br>      destination &#x3D; lv_destination<br>    IMPORTING<br>      rc          &#x3D; lv_rc.<br>  IF lv_rc NE 0.<br>    CONCATENATE ‘模板文件’ ‘下载失败’ INTO lv_errtxt.<br>    MESSAGE e000(su) WITH lv_errtxt.<br>  ENDIF.</p>
<p>ENDFORM.                    “ FRM_DOWNLOAD_EXCEL_FROM_SERVER<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  FRM_OPEN_EXCEL<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> --&gt;P_P_PV_FULLPATH  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM frm_open_excel  USING    p_pv_fullpath.<br>  “打开EXCEL应用<br>  CREATE OBJECT myexcel ‘EXCEL.APPLICATION’.<br>  SET PROPERTY OF myexcel ‘VISIBLE’ &#x3D; 0 .”0代表后台运行，1代表前台运行</p>
<p>  “获取工作簿。<br>  CALL METHOD OF myexcel ‘WORKBOOKS’ &#x3D; myworkbook.</p>
<p>  “打开工作簿<br>  CALL METHOD OF myworkbook ‘OPEN’<br>    EXPORTING<br>      #1 &#x3D; p_pv_fullpath.</p>
<p>  “设置活动的工作簿。<br>  GET PROPERTY OF myexcel ‘ACTIVEWORKBOOK’ &#x3D; myworkbook.<br>ENDFORM.                    “ FRM_OPEN_EXCEL<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_SHEET_COPY<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_sheet_copy .<br>  DATA: lv_line  TYPE i,<br>        lv_line1 TYPE i.</p>
<p>  DO 5 TIMES.<br>    CALL METHOD OF myexcel ‘SHEETS’ &#x3D; mysheet.<br>    CALL METHOD OF mysheet ‘ADD’ .”新增一个SHEET页</p>
<pre><code>CALL METHOD OF myexcel &#39;SHEETS&#39; = mysheet
  EXPORTING
  #1 = &#39;123&#39;.&quot;下载模板的第一个SHEET名称为‘订单1’
CALL METHOD OF mysheet &#39;ACTIVATE&#39;.&quot;转到‘订单1’这个SHEET页
CALL METHOD OF mysheet &#39;CELLS&#39; = mycell.
</code></pre>
<p>  ENDDO.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_FILL_SHEET<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_fill_sheet .<br>  DATA: lv_line  TYPE i,<br>        lv_line1 TYPE i,<br>        lv_line3 TYPE c,<br>        lv_insr  TYPE i.<br>  DATA:lv_sheetname(20) TYPE c.<br>  lv_line1 &#x3D; lv_line1 + 1.</p>
<p>*&amp;—记录三个表的行数和列数<br>  PERFORM frm_paste_tab.</p>
<p>*&amp;—生产排产表页签数据填充<br>  PERFORM frm_ole_scpcb.</p>
<p>*&amp;—BOM清单页签数据填充<br>  PERFORM frm_ole_bomqd.</p>
<p>*&amp;—核料表页签数据填充<br>  PERFORM frm_ole_hlb.</p>
<p>*&amp;—设置打开EXCEL展示第一个页签<br>  CALL METHOD OF myexcel ‘WORKSHEETS’ &#x3D; mysheet<br>    EXPORTING<br>    #1 &#x3D; zproduction_schedule.”‘生产排产表’.<br>  CALL METHOD OF mysheet ‘ACTIVATE’.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_OLE_SCPCB<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_ole_scpcb .<br>  “设置活动的生产排产表页<br>  CALL METHOD OF myexcel ‘WORKSHEETS’ &#x3D; mysheet<br>    EXPORTING<br>    #1 &#x3D; zproduction_schedule.”‘生产排产表’.<br>  CALL METHOD OF mysheet ‘ACTIVATE’.</p>
<ul>
<li>SET PROPERTY OF MYSHEET ‘NAME’ &#x3D; ‘MY’.         “重命名SHEET页签</li>
</ul>
<p>  “将报表表头字段输出到EXCEL<br>  PERFORM frm_ole_header TABLES gt_fieldcatalog1.</p>
<p>  “数据填充<br>  PERFORM frm_ole_scpcb_data.</p>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_OLE_HEADER<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br><em>&amp;———————————————————————</em><br>FORM frm_ole_header TABLES ztab STRUCTURE lvc_s_fcat.<br>  DATA:zcol TYPE i.</p>
<p>  “将表头输出到EXCEL第一行<br>  CLEAR:zcol.<br>  LOOP AT ztab INTO DATA(wa_table) .<br>    IF wa_table-fieldname &#x3D; ‘ICON’ OR wa_table-fieldname &#x3D; ‘MSG’ OR wa_table-fieldname &#x3D; ‘ZSTYLE’ OR wa_table-fieldname &#x3D; ‘CELLCOLOR’.<br>      CONTINUE.<br>    ENDIF.<br>    zcol &#x3D; zcol + 1.<br>    PERFORM f_fill_cell USING 1 zcol 1 11 0 2 1 0 0 wa_table-scrtext_l.<br>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp;      FORM  F_FILL_CELL<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  TEXT
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em></p>
<ul>
<li><pre><code> --&gt;P_ROW
</code></pre>
</li>
<li><pre><code> --&gt;P_COL
</code></pre>
</li>
<li><pre><code> --&gt;P_BOLD
</code></pre>
</li>
<li><pre><code> --&gt;P_SIZE
</code></pre>
</li>
<li><pre><code> --&gt;P_POSITION
</code></pre>
</li>
<li><pre><code> --&gt;P_COLOR
</code></pre>
</li>
<li><pre><code> --&gt;P_BORDER
</code></pre>
</li>
<li><pre><code> --&gt;P_FORMAT
</code></pre>
</li>
<li><pre><code> --&gt;P_ITALIC
</code></pre>
</li>
<li><pre><code> --&gt;P_VALUE
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>FORM f_fill_cell USING  p_row<br>                        p_col<br>                        p_bold<br>                        p_size<br>                        p_position<br>                        p_color<br>                        p_border<br>                        p_format<br>                        p_italic<br>                        p_value.<br>  DATA: lv_number TYPE char100.</p>
<p>  “定位到单元格<br>  CALL METHOD OF myexcel ‘CELLS’ &#x3D; mycell<br>    EXPORTING<br>    #1 &#x3D; p_row<br>    #2 &#x3D; p_col.</p>
<p>  IF p_format &#x3D; 0.<br>    SET PROPERTY OF mycell ‘VALUE’ &#x3D; p_value.</p>
<ul>
<li>SET PROPERTY OF mycell ‘STYLE’ &#x3D; ‘常规’.</li>
</ul>
<p>  ELSE.<br>    CLEAR lv_number.<br>    WRITE p_value TO lv_number.<br>    CONDENSE lv_number.    “去掉空格<br>    SET PROPERTY OF mycell ‘VALUE’ &#x3D; lv_number.<br>  ENDIF.</p>
<p>  GET PROPERTY OF mycell ‘FONT’ &#x3D; myfont.               “设置字体属性<br>  SET PROPERTY OF myfont ‘NAME’ &#x3D; ‘宋体’.               “字体（如要要设置字体格式需首先设置此参数，否则对后续单元格可能会不生效）<br>  SET PROPERTY OF myfont ‘UNDERLINE’ &#x3D; 1.               “1无下划线，2有下划线<br>  SET PROPERTY OF myfont ‘BOLD’ &#x3D; 0.                    “0不加粗，1加粗<br>  SET PROPERTY OF myfont ‘ITALIC’ &#x3D; 0.                  “0正常，1斜体<br>  SET PROPERTY OF myfont ‘SIZE’ &#x3D; p_size.               “字体大小</p>
<p>  SET PROPERTY OF myfont ‘COLORINDEX’ &#x3D; 1.             “字体颜色(可选范围1~56，1黑色 2白色 3红色 4绿色 5蓝色 6黄色 7品红色  8青绿色)<br>  FREE OBJECT myfont.</p>
<ul>
<li>SET PROPERTY OF mycell ‘NUMBERFORMAT’ &#x3D; ‘@’.          “有时输入数据如111111111111111111，会显示为1E+17,设置此参数可让数据正常显示<br>  SET PROPERTY OF mycell ‘HORIZONTALALIGNMENT’ &#x3D; -4131. “设置单元格的水平对齐属性（-4108居中，-4152右对齐，-4131左对齐 或者 2左对齐，3居中，4右对齐同样生效）<br>  SET PROPERTY OF mycell ‘VERTICALALIGNMENT’ &#x3D; 2.       “设置单元格的垂直对齐属性（1靠上，2居中，3靠下）<br>  SET PROPERTY OF mycell ‘WRAPTEXT’ &#x3D; 0.                “设置单元格是否自动换行</li>
</ul>
<p>  GET PROPERTY OF mycell ‘INTERIOR’ &#x3D; myinterior.       “设置单元格内部属性<br>  SET PROPERTY OF myinterior ‘COLORINDEX’  &#x3D; p_color.   “单元格背景颜色(可选范围1~56，1黑色 2白色 3红色 4绿色 5蓝色 6黄色 7品红色  8青绿色)</p>
<ul>
<li>GET PROPERTY OF MYCELL ‘ROWS’ &#x3D; MYROWS.</li>
<li>SET PROPERTY OF MYROWS ‘ROWHEIGHT’ &#x3D; 12.              “设置行高</li>
<li>GET PROPERTY OF MYCELL ‘COLUMNS’ &#x3D; MYCOLUMNS.</li>
<li>SET PROPERTY OF MYCOLUMNS ‘COLUMNWIDTH’ &#x3D; 12.         “设置列宽</li>
</ul>
<p>  CALL METHOD OF mycell ‘BORDERAROUND’ “给当前单元格加边框<br>    EXPORTING<br>      #1 &#x3D; p_border “1与7－细实、2－细虚、4－点虚、9－双细实线<br>      #2 &#x3D; 1. “边框厚度</p>
<p>  CALL METHOD OF mycell ‘COLUMNS’ &#x3D; mycolumns.<br>  CALL METHOD OF mycolumns ‘AUTOFIT’.<br>  FREE OBJECT mycolumns.<br>ENDFORM.                    “ F_FILL_CELL<br><em>&amp;———————————————————————</em><br>*&amp; FORM FRM_OLE_SCPCB_DATA<br><em>&amp;———————————————————————</em><br>*&amp; TEXT<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  P1        TEXT<br>*&amp; &lt;–  P2        TEXT<br>*&amp;———————————————————————*<br>FORM frm_ole_scpcb_data .<br>  DATA:zrow         TYPE i,<br>       zcol         TYPE i,<br>       zmatnrview   TYPE c,<br>       zformula     TYPE string,<br>       zformulacy   TYPE string,<br>       zformulaljcy TYPE string,<br>       zcell        TYPE string,<br>       zmatnr01     TYPE mara-matnr,<br>       zmatnr02     TYPE mara-matnr.<br>  FIELD-SYMBOLS:<ft_scpcb> TYPE any.</p>
<p>*&amp;—先将数据整体复制粘贴，再进行修改<br>  “将生产排产表内表数据复制到剪切板<br>  DATA(length) &#x3D; 0.<br>  CALL METHOD cl_gui_frontend_services&#x3D;&gt;clipboard_export<br>    IMPORTING<br>      data                 &#x3D; excel_tab01<br>    CHANGING<br>      rc                   &#x3D; length<br>    EXCEPTIONS<br>      cntl_error           &#x3D; 1<br>      error_no_gui         &#x3D; 2<br>      not_supported_by_gui &#x3D; 3<br>      OTHERS               &#x3D; 4.</p>
<p>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; znum01col.<br>  DATA(znum01rowpaste) &#x3D; znum01row + 1.”第一行为抬头文本<br>  DATA(zrange) &#x3D; ‘A2:’ &amp;&amp; gs_col-col &amp;&amp; znum01rowpaste.<br>  CALL METHOD OF  mysheet ‘RANGE’ &#x3D; myrange<br>    EXPORTING<br>      #1      &#x3D; zrange. “也可以是用户自定义的单元格名称</p>
<p>  “粘贴<br>  CALL METHOD OF myrange ‘PasteSpecial’.</p>
<p>*&amp;—第一行重新赋值公式<br>  READ TABLE <ft_vb> ASSIGNING FIELD-SYMBOL(<fs_pc>) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>    “循环FIELDCAT,日期下的数量重新赋值<br>    zcol &#x3D; 16.”前面两列信号等，信息不管<br>    LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1 FROM 19 WHERE fieldname &lt;&gt; ‘ZSTYLE’ AND fieldname &lt;&gt; ‘CELLCOLOR’ AND fieldname &lt;&gt; ‘ZLJCY’.<br>      zcol &#x3D; zcol + 1.</p>
<pre><code>  &quot;只有前两周的汇总列包含&#39;、&#39;
  FIND &#39;、&#39; IN gs_fieldcatalog1-coltext.
  IF sy-subrc = 0.
    DATA(ztweek) = &#39;X&#39;.
  ENDIF.

  &quot;从数据列开始计算公式,跳过两周汇总列,到计划总量不再计算
  IF zcol &gt;= 17 AND ztweek NE &#39;X&#39; AND gs_fieldcatalog1-fieldname &lt;&gt; &#39;ZJHZL&#39; AND gs_fieldcatalog1-fieldname &lt;&gt; &#39;ZYFPL&#39;.
    &quot;拼接前两周汇总列的公式，以及分配量的公式
    READ TABLE gt_col INTO gs_col WITH KEY number = zcol.
    IF zformula IS INITIAL.
      zformula = gs_col-col &amp;&amp; &#39;2&#39;.
    ELSE.
      zformula = zformula &amp;&amp; &#39;+&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;2&#39;.
    ENDIF.
  ENDIF.

  ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE &lt;fs_pc&gt; TO &lt;ft_scpcb&gt;.
  IF sy-subrc = 0.
    &quot;前两周汇总列公式
    IF ztweek = &#39;X&#39;.
      &quot;利用公式计算
      zcell = &#39;=SUM(&#39; &amp;&amp; zformula &amp;&amp; &#39;)&#39;.
      PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zcell.
</code></pre>
<p>*&amp;—将已分配量赋值到这一列的单元格中<br>          DATA(znum01row01) &#x3D; znum01row + 1.”抬头有一行</p>
<pre><code>      DATA(zcol_copy_begin) = zcol.
      DATA(zrow_copy_begin) = 2.
      DATA(zcol_copy_end) = zcol.
      DATA(zrow_copy_end) = 2.
      DATA(zcol_psate_begin) = zcol.
      DATA(zrow_psate_begin) = 3.
      DATA(zcol_psate_end) = zcol.
      DATA(zrow_psate_end) = znum01row01.
      PERFORM frm_copy_paste USING zcol_copy_begin&quot;复制开始的列
                                   zrow_copy_begin&quot;复制开始的行
                                   zcol_copy_end&quot;复制结束的列
                                   zrow_copy_end&quot;复制结束的行
                                   zcol_psate_begin&quot;粘贴开始的列
                                   zrow_psate_begin&quot;粘贴开始的行
                                   zcol_psate_end&quot;粘贴结束的列
                                   zrow_psate_end.&quot;粘贴结束的行
    ELSEIF gs_fieldcatalog1-fieldname = &#39;ZYFPL&#39;.&quot;已分配量公式
      &quot;利用公式计算
      zcell = &#39;=SUM(&#39; &amp;&amp; zformula &amp;&amp; &#39;)&#39;.
      PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zcell.
</code></pre>
<p>*&amp;—将已分配量赋值到这一列的单元格中<br>          znum01row01 &#x3D; znum01row + 1.”抬头有一行</p>
<pre><code>      zcol_copy_begin = zcol.
      zrow_copy_begin = 2.
      zcol_copy_end = zcol.
      zrow_copy_end = 2.
      zcol_psate_begin = zcol.
      zrow_psate_begin = 3.
      zcol_psate_end = zcol.
      zrow_psate_end = znum01row01.
      PERFORM frm_copy_paste USING zcol_copy_begin&quot;复制开始的列
                                   zrow_copy_begin&quot;复制开始的行
                                   zcol_copy_end&quot;复制结束的列
                                   zrow_copy_end&quot;复制结束的行
                                   zcol_psate_begin&quot;粘贴开始的列
                                   zrow_psate_begin&quot;粘贴开始的行
                                   zcol_psate_end&quot;粘贴结束的列
                                   zrow_psate_end.&quot;粘贴结束的行
    ELSE.
      zcell =  &lt;ft_scpcb&gt;.
      PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zcell.
    ENDIF.
    CLEAR:zcell.
  ENDIF.
  CLEAR:ztweek.
</code></pre>
<p>*&amp;—-单行差异公式<br>      “已分配量<br>      IF gs_fieldcatalog1-fieldname &#x3D; ‘ZYFPL’.<br>        READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; zcol.<br>        DATA(zformula01) &#x3D; gs_col-col &amp;&amp; ‘2’.<br>      ENDIF.<br>      “计划总量<br>      IF gs_fieldcatalog1-fieldname &#x3D; ‘ZJHZL’.<br>        READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; zcol.<br>        DATA(zformula02) &#x3D; gs_col-col &amp;&amp; ‘2’.<br>      ENDIF.</p>
<ul>
<li><pre><code> &quot;差异 = 已分配量- 计划总量
</code></pre>
</li>
<li><pre><code> IF gs_fieldcatalog1-fieldname = &#39;ZLJCY&#39;.
</code></pre>
</li>
<li><pre><code>   zformulacy = &#39;=SUM(&#39; &amp;&amp; zformula01 &amp;&amp; &#39;-&#39; &amp;&amp; zformula02 &amp;&amp; &#39;)&#39;.
</code></pre>
</li>
<li><pre><code>   PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zformulacy.
</code></pre>
</li>
<li>**&amp;—将已分配量赋值到这一列的单元格中</li>
<li><pre><code>   znum01row01 = znum01row + 1.&quot;抬头有一行
</code></pre>
</li>
<li></li>
<li><pre><code>   zcol_copy_begin = zcol.
</code></pre>
</li>
<li><pre><code>   zrow_copy_begin = 2.
</code></pre>
</li>
<li><pre><code>   zcol_copy_end = zcol.
</code></pre>
</li>
<li><pre><code>   zrow_copy_end = 2.
</code></pre>
</li>
<li><pre><code>   zcol_psate_begin = zcol.
</code></pre>
</li>
<li><pre><code>   zrow_psate_begin = 3.
</code></pre>
</li>
<li><pre><code>   zcol_psate_end = zcol.
</code></pre>
</li>
<li><pre><code>   zrow_psate_end = znum01row01.
</code></pre>
</li>
<li><pre><code>   PERFORM frm_copy_paste USING zcol_copy_begin&quot;复制开始的列
</code></pre>
</li>
<li><pre><code>                                zrow_copy_begin&quot;复制开始的行
</code></pre>
</li>
<li><pre><code>                                zcol_copy_end&quot;复制结束的列
</code></pre>
</li>
<li><pre><code>                                zrow_copy_end&quot;复制结束的行
</code></pre>
</li>
<li><pre><code>                                zcol_psate_begin&quot;粘贴开始的列
</code></pre>
</li>
<li><pre><code>                                zrow_psate_begin&quot;粘贴开始的行
</code></pre>
</li>
<li><pre><code>                                zcol_psate_end&quot;粘贴结束的列
</code></pre>
</li>
<li><pre><code>                                zrow_psate_end.&quot;粘贴结束的行
</code></pre>
</li>
<li><pre><code> ENDIF.
</code></pre>
  ENDLOOP.<br>ENDIF.</li>
</ul>
<p>*&amp;—重写累计差异<br>  CLEAR:zrow.<br>  zrow &#x3D; 1.”跳过表头行<br>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; znum01col.<br>  DATA(zcol_ljcy) &#x3D; gs_col-col.<br>  zcol &#x3D; zcol + 1.”累计差异列<br>  LOOP AT <ft_vb> ASSIGNING <fs_pc>.<br>    zrow &#x3D; zrow + 1.<br>    CLEAR:zformula.</p>
<p>*&amp;—本行物料与上行物料是否一致<br>    ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_pc> TO <ft_scpcb>.<br>    zmatnr02 &#x3D; <ft_scpcb>.<br>    IF zmatnr01 &#x3D; zmatnr02.<br>      CLEAR:zmatnrview.<br>    ELSE.<br>      zmatnrview &#x3D; ‘X’.”物料不相同标识<br>      zmatnr01 &#x3D; zmatnr02.<br>      CLEAR:zformulaljcy.”清空累计差异公式<br>    ENDIF.</p>
<p>*&amp;—累计差异，相同物料差异累计<br>    IF zmatnrview &#x3D; ‘X’.”不同的物料<br>      DATA(zrowup) &#x3D; zrow - 1.<br>      IF zrowup &lt;&gt; 1.<br>        zformulaljcy &#x3D; zcol_ljcy &amp;&amp; zrowup.<br>      ENDIF.</p>
<pre><code>  DATA(zcolbefor) = zcol - 1.&quot;已分配量
  READ TABLE gt_col INTO gs_col WITH KEY number = zcolbefor.
  DATA(zyfpl) = gs_col-col &amp;&amp; zrow.

  zcolbefor = zcolbefor - 1.&quot;计划量
  READ TABLE gt_col INTO gs_col WITH KEY number = zcolbefor.
  DATA(zjhl) = gs_col-col &amp;&amp; zrow.

  zcell = &#39;=SUM(&#39; &amp;&amp; zyfpl &amp;&amp; &#39;-&#39; &amp;&amp; zjhl &amp;&amp; &#39;)&#39;.
  PERFORM f_fill_cell USING zrow zcol 1 11 0 2 1 0 0 zcell.
ELSE.&quot;相同的物料差异累计
  zrowup = zrow - 1.
  IF zrowup &lt;&gt; 1.
    zformulaljcy = zcol_ljcy &amp;&amp; zrowup.
  ENDIF.

  zcolbefor = zcol - 1.&quot;已分配量
  READ TABLE gt_col INTO gs_col WITH KEY number = zcolbefor.
  zyfpl = gs_col-col &amp;&amp; zrow.

  zcolbefor = zcolbefor - 1.&quot;计划量
  READ TABLE gt_col INTO gs_col WITH KEY number = zcolbefor.
  zjhl = gs_col-col &amp;&amp; zrow.

  zcell = &#39;=SUM(&#39; &amp;&amp; zyfpl &amp;&amp; &#39;-&#39; &amp;&amp; zjhl &amp;&amp; &#39;+&#39; &amp;&amp; zformulaljcy &amp;&amp; &#39;)&#39;.
  PERFORM f_fill_cell USING zrow zcol 1 11 0 2 1 0 0 zcell.
ENDIF.
</code></pre>
<p>*&amp;—END—<br>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_tab_col<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_tab_col .<br>  DATA:col TYPE c VALUE ‘A’,<br>       rn  TYPE i.<br>  FIELD-SYMBOLS:<n> TYPE x.<br>  FIELD-SYMBOLS:<c> TYPE c.</p>
<p>  CLEAR:gt_col,gs_col.<br>  DO 26 TIMES.”预留出99列,可更改<br>    gs_col-number &#x3D; gs_col-number + 1.<br>    gs_col-col &#x3D; col.<br>    APPEND gs_col TO gt_col.</p>
<p>*&amp;—下一个字母<br>    ASSIGN col TO <n> CASTING.”将字母转换为ASCII码<br>    MOVE <n> TO rn.<br>    rn &#x3D; rn + 256.”加256即为下一个字母<br>    MOVE rn TO <n>.<br>    ASSIGN <n> TO <c> CASTING TYPE c.”将ASCII转换为字母<br>    MOVE <c> TO col.<br>  ENDDO.</p>
<p>  gs_col-col &#x3D; ‘AA’.<br>  col &#x3D; ‘A’.<br>  DO 26 TIMES.”预留出99列,可更改<br>    gs_col-number &#x3D; gs_col-number + 1.<br>    APPEND gs_col TO gt_col.</p>
<p>*&amp;—下一个字母<br>    ASSIGN col TO <n> CASTING.”将字母转换为ASCII码<br>    MOVE <n> TO rn.<br>    rn &#x3D; rn + 256.”加256即为下一个字母<br>    MOVE rn TO <n>.<br>    ASSIGN <n> TO <c> CASTING TYPE c.”将ASCII转换为字母<br>    MOVE <c> TO col.<br>    gs_col-col &#x3D; ‘A’ &amp;&amp; col.<br>  ENDDO.</p>
<p>  gs_col-col &#x3D; ‘BA’.<br>  col &#x3D; ‘A’.<br>  DO 26 TIMES.”预留出99列,可更改<br>    gs_col-number &#x3D; gs_col-number + 1.<br>    APPEND gs_col TO gt_col.</p>
<p>*&amp;—下一个字母<br>    ASSIGN col TO <n> CASTING.”将字母转换为ASCII码<br>    MOVE <n> TO rn.<br>    rn &#x3D; rn + 256.”加256即为下一个字母<br>    MOVE rn TO <n>.<br>    ASSIGN <n> TO <c> CASTING TYPE c.”将ASCII转换为字母<br>    MOVE <c> TO col.<br>    gs_col-col &#x3D; ‘B’ &amp;&amp; col.<br>  ENDDO.</p>
<p>  gs_col-col &#x3D; ‘CA’.<br>  col &#x3D; ‘A’.<br>  DO 26 TIMES.”预留出99列,可更改<br>    gs_col-number &#x3D; gs_col-number + 1.<br>    APPEND gs_col TO gt_col.</p>
<p>*&amp;—下一个字母<br>    ASSIGN col TO <n> CASTING.”将字母转换为ASCII码<br>    MOVE <n> TO rn.<br>    rn &#x3D; rn + 256.”加256即为下一个字母<br>    MOVE rn TO <n>.<br>    ASSIGN <n> TO <c> CASTING TYPE c.”将ASCII转换为字母<br>    MOVE <c> TO col.<br>    gs_col-col &#x3D; ‘C’ &amp;&amp; col.<br>  ENDDO.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_ole_bomqd<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_ole_bomqd .<br>  “设置活动的生产排产表页<br>  CALL METHOD OF myexcel ‘WORKSHEETS’ &#x3D; mysheet<br>    EXPORTING<br>    #1 &#x3D; zbom_list_table.”‘BOM清单’.<br>  CALL METHOD OF mysheet ‘ACTIVATE’.</p>
<ul>
<li>SET PROPERTY OF MYSHEET ‘NAME’ &#x3D; ‘MY’.         “重命名SHEET页签</li>
</ul>
<p>  “将报表表头字段输出到EXCEL<br>  PERFORM frm_ole_header TABLES gt_fieldcatalog3.</p>
<p>  “数据填充<br>  PERFORM frm_ole_bomqd_data.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_ole_bomqd_data<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_ole_bomqd_data .<br>  DATA:zrow         TYPE i,<br>       zcol         TYPE i,<br>       zmatnrview   TYPE c,<br>       zformula     TYPE string,<br>       zformulajhzl TYPE string,<br>       zbomqdsl     TYPE string,<br>       zcell        TYPE string,<br>       zmatnr01     TYPE mara-matnr,<br>       zmatnr02     TYPE mara-matnr.</p>
<p>*&amp;—先将数据整体复制粘贴，再进行修改<br>  “将生产排产表内表数据复制到剪切板<br>  DATA(length) &#x3D; 0.<br>  CALL METHOD cl_gui_frontend_services&#x3D;&gt;clipboard_export<br>    IMPORTING<br>      data                 &#x3D; excel_tab02<br>    CHANGING<br>      rc                   &#x3D; length<br>    EXCEPTIONS<br>      cntl_error           &#x3D; 1<br>      error_no_gui         &#x3D; 2<br>      not_supported_by_gui &#x3D; 3<br>      OTHERS               &#x3D; 4.</p>
<p>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; znum02col.<br>  DATA(znum02rowpaste) &#x3D; znum02row + 1.”第一行为抬头文本<br>  DATA(zrange) &#x3D; ‘A2:’ &amp;&amp; gs_col-col &amp;&amp; znum02rowpaste.<br>  CALL METHOD OF  mysheet ‘RANGE’ &#x3D; myrange<br>    EXPORTING<br>      #1      &#x3D; zrange. “也可以是用户自定义的单元格名称</p>
<p>  “粘贴<br>  CALL METHOD OF myrange ‘PasteSpecial’.</p>
<p>*&amp;—第一行重新赋值公式<br>  READ TABLE <ft_vb_bom> ASSIGNING FIELD-SYMBOL(<fs_bomqd>) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>    “循环FIELDCAT,日期下的数量重新赋值<br>    zcol &#x3D; 10.”前面信息不管<br>    LOOP AT gt_fieldcatalog3 INTO gs_fieldcatalog3 FROM 11 WHERE fieldname &lt;&gt; ‘ZSTYLE’ AND fieldname &lt;&gt; ‘CELLCOLOR’.<br>      zcol &#x3D; zcol + 1.</p>
<pre><code>  &quot;只有前两周的汇总列包含&#39;、&#39;
  FIND &#39;、&#39; IN gs_fieldcatalog3-coltext.
  IF sy-subrc = 0.
    DATA(ztweek) = &#39;X&#39;.
  ENDIF.

  &quot;从数据列开始计算公式,跳过两周汇总列,到计划总量不再计算
  IF zcol &gt;= 11 AND ztweek NE &#39;X&#39; AND gs_fieldcatalog3-fieldname &lt;&gt; &#39;ZJHZL&#39;.
</code></pre>
<p><em>&amp;—BOM清单日期下的数量 &#x3D; 排产数量</em>单位用量<br>        DATA(zcol_pc) &#x3D; zcol + 7.<br>        READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; zcol_pc.<br>        zbomqdsl &#x3D; ‘&#x3D;SUMIFS(生产排产表!’ &amp;&amp; gs_col-col &amp;&amp; ‘:’ &amp;&amp; gs_col-col &amp;&amp; ‘,生产排产表!E:E,B:B,生产排产表!I:I,H:H)*J2’.</p>
<pre><code>    &quot;第一天排产的组件数量需要加上截止逾期数量的组件
    IF zcol = 11.
      READ TABLE gt_col INTO gs_col WITH KEY number = zcol_pc - 1.&quot;逾期数量
      zbomqdsl = zbomqdsl &amp;&amp; &#39;+SUMIFS(生产排产表!&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;:&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;,生产排产表!E:E,B:B,生产排产表!I:I,H:H)*J2&#39;.
    ENDIF.
    PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zbomqdsl.

    &quot;拼接前两周汇总列的公式，以及分配量的公式
    READ TABLE gt_col INTO gs_col WITH KEY number = zcol.
    IF zformula IS INITIAL.
      zformula = gs_col-col &amp;&amp; &#39;2&#39;.
    ELSE.
      zformula = zformula &amp;&amp; &#39;+&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;2&#39;.
    ENDIF.
  ENDIF.

  &quot;前两周汇总列公式/计划总量
  IF ztweek = &#39;X&#39; OR gs_fieldcatalog3-fieldname = &#39;ZJHZL&#39;.&quot;.
    &quot;利用公式计算
    zcell = &#39;=SUM(&#39; &amp;&amp; zformula &amp;&amp; &#39;)&#39;.
    PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zcell.
  ENDIF.
  CLEAR:zcell.
  CLEAR:ztweek.
ENDLOOP.
</code></pre>
<p>*&amp;—将第一行的公式复制到下面行<br>    DATA(znum02row01) &#x3D; znum02row + 1.”抬头有一行</p>
<pre><code>DATA(zcol_copy_begin) = 11.
DATA(zrow_copy_begin) = 2.
DATA(zcol_copy_end) = znum02col.
DATA(zrow_copy_end) = 2.
DATA(zcol_psate_begin) = 11.
DATA(zrow_psate_begin) = 3.
DATA(zcol_psate_end) = znum02col.
DATA(zrow_psate_end) = znum02row01.
PERFORM frm_copy_paste USING zcol_copy_begin&quot;复制开始的列
                             zrow_copy_begin&quot;复制开始的行
                             zcol_copy_end&quot;复制结束的列
                             zrow_copy_end&quot;复制结束的行
                             zcol_psate_begin&quot;粘贴开始的列
                             zrow_psate_begin&quot;粘贴开始的行
                             zcol_psate_end&quot;粘贴结束的列
                             zrow_psate_end.&quot;粘贴结束的行
</code></pre>
<p>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_ole_hlb<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_ole_hlb .<br>  “设置活动的生产排产表页<br>  CALL METHOD OF myexcel ‘WORKSHEETS’ &#x3D; mysheet<br>    EXPORTING<br>    #1 &#x3D; znuclear_material_list.”‘核料表’.<br>  CALL METHOD OF mysheet ‘ACTIVATE’.</p>
<p>  SET PROPERTY OF mysheet ‘NAME’ &#x3D;  tab_appl_tab2.         “重命名SHEET页签</p>
<p>  “将报表表头字段输出到EXCEL<br>  PERFORM frm_ole_header TABLES gt_fieldcatalog_01.</p>
<p>  “数据填充<br>  PERFORM frm_ole_hlb_data.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_ole_hlb_data<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_ole_hlb_data .<br>  DATA:zrow         TYPE i,<br>       zcol         TYPE i,<br>       zmatnrview   TYPE c,<br>       zformula     TYPE string,<br>       zformulaljcy TYPE string,<br>       zcell        TYPE string.<br>  DATA(znum03row01) &#x3D; znum03row + 1.”抬头有一行<br>*&amp;—先将数据整体复制粘贴，再进行修改<br>  “将生产排产表内表数据复制到剪切板<br>  DATA(length) &#x3D; 0.<br>  CALL METHOD cl_gui_frontend_services&#x3D;&gt;clipboard_export<br>    IMPORTING<br>      data                 &#x3D; excel_tab03<br>    CHANGING<br>      rc                   &#x3D; length<br>    EXCEPTIONS<br>      cntl_error           &#x3D; 1<br>      error_no_gui         &#x3D; 2<br>      not_supported_by_gui &#x3D; 3<br>      OTHERS               &#x3D; 4.</p>
<p>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; znum03col.<br>  DATA(znum03rowpaste) &#x3D; znum03row + 1.”第一行为抬头文本<br>  DATA(zrange) &#x3D; ‘A2:’ &amp;&amp; gs_col-col &amp;&amp; znum03rowpaste.<br>  CALL METHOD OF  mysheet ‘RANGE’ &#x3D; myrange<br>    EXPORTING<br>      #1      &#x3D; zrange. “也可以是用户自定义的单元格名称</p>
<p>  “粘贴<br>  CALL METHOD OF myrange ‘PasteSpecial’.<br>*&amp;—获取下周一日期<br>  DATA zdatum_week_next TYPE d.<br>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING<br>      monday &#x3D; zdatum_week_next.</p>
<p>  CALL FUNCTION ‘GET_WEEK_INFO_BASED_ON_DATE’<br>    EXPORTING<br>      date   &#x3D; sy-datum<br>    IMPORTING<br>      sunday &#x3D; zdatum_sunday.</p>
<p>  zdatum_week_next &#x3D; zdatum_week_next + 7.<br>  DATA(zfieldcat_name) &#x3D; ‘ZW’ &amp;&amp; zdatum_week_next &amp;&amp; ‘LJ’.<br>*&amp;—第一行重新赋值公式<br>  READ TABLE <ft_vb_hlb> ASSIGNING FIELD-SYMBOL(<fs_vshlb>) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>    “循环FIELDCAT,日期下的数量重新赋值<br>    zcol &#x3D; 8.”前面信息不管<br>    DATA(zcolbomqd01) &#x3D; 11.”第一列数据对应bom清单第11列,初始列<br>    DATA(zviewfirst) &#x3D; 1.”判断是否为第一列差异<br>    LOOP AT gt_fieldcatalog_01 INTO gs_fieldcatalog_01 FROM 10 WHERE fieldname &lt;&gt; ‘ZSTYLE’ AND fieldname &lt;&gt; ‘CELLCOLOR’.<br>      zcol &#x3D; zcol + 1.”核料表列</p>
<pre><code>  &quot;需求数量字段
  FIND &#39;XQ&#39; IN gs_fieldcatalog_01-fieldname.
  IF sy-subrc = 0.
    DATA(zadd) = ( zcol - 9 ) / 3.
    DATA(zcolbomqd) = zcolbomqd01 + zadd.&quot;BOM清单列
    READ TABLE gt_col INTO gs_col WITH KEY number = zcolbomqd.
    DATA(zbomqdsl) = &#39;=SUMIFS(BOM清单!&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;:&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;,BOM清单!E:E,B:B)&#39;.
    PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zbomqdsl.
</code></pre>
<p>*&amp;—将第一行的公式复制到下面行<br>        DATA(zcol_copy_begin) &#x3D; zcol.<br>        DATA(zrow_copy_begin) &#x3D; 2.<br>        DATA(zcol_copy_end) &#x3D; zcol.<br>        DATA(zrow_copy_end) &#x3D; 2.<br>        DATA(zcol_psate_begin) &#x3D; zcol.<br>        DATA(zrow_psate_begin) &#x3D; 2.<br>        DATA(zcol_psate_end) &#x3D; zcol.<br>        DATA(zrow_psate_end) &#x3D; znum03row01.<br>        PERFORM frm_copy_paste USING zcol_copy_begin”复制开始的列<br>                                     zrow_copy_begin”复制开始的行<br>                                     zcol_copy_end”复制结束的列<br>                                     zrow_copy_end”复制结束的行<br>                                     zcol_psate_begin”粘贴开始的列<br>                                     zrow_psate_begin”粘贴开始的行<br>                                     zcol_psate_end”粘贴结束的列<br>                                     zrow_psate_end.”粘贴结束的行<br>      ELSE.<br>        “差异字段&#x3D;供给-需求<br>        FIND ‘LJ’ IN gs_fieldcatalog_01-fieldname.<br>        IF sy-subrc &#x3D; 0.<br>          “本日期的供给列<br>          DATA(zcolbom01) &#x3D; zcol - 1.<br>          READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; zcolbom01.</p>
<pre><code>      &quot;本日期的需求列
      zcolbom01 = zcolbom01 - 1.
      READ TABLE gt_col INTO DATA(gs_col01) WITH KEY number = zcolbom01.

      &quot;前两周汇总列的差异列和第一列差异需要减去库存加计划外补料
      IF gs_fieldcatalog_01-fieldname = zfieldcat_name OR zviewfirst = 1.
        DATA(zweek_sum_ljcy) = gs_col-col &amp;&amp; &#39;2&#39; &amp;&amp; &#39;-&#39; &amp;&amp; gs_col01-col &amp;&amp; &#39;2&#39;.
        DATA(zformulahlb) = &#39;=SUM(&#39; &amp;&amp; zweek_sum_ljcy &amp;&amp; &#39;-H2+F2&#39; &amp;&amp; &#39;)&#39;.
      ELSE.
        IF zformulaljcy IS INITIAL.
          zformulaljcy = gs_col-col &amp;&amp; &#39;2&#39; &amp;&amp; &#39;-&#39; &amp;&amp; gs_col01-col &amp;&amp; &#39;2&#39;.
        ELSE.
          zformulaljcy = zformulaljcy &amp;&amp; &#39;+&#39; &amp;&amp; gs_col-col &amp;&amp; &#39;2&#39; &amp;&amp; &#39;-&#39; &amp;&amp; gs_col01-col &amp;&amp; &#39;2&#39;.
        ENDIF.
        zformulahlb = &#39;=SUM(K2+&#39; &amp;&amp; zformulaljcy &amp;&amp; &#39;)&#39;.&quot;加第一列的累计差异
      ENDIF.

      PERFORM f_fill_cell USING 2 zcol 1 11 0 2 1 0 0 zformulahlb.
</code></pre>
<p>*&amp;—将第一行的公式复制到下面行<br>          zcol_copy_begin &#x3D; zcol.<br>          zrow_copy_begin &#x3D; 2.<br>          zcol_copy_end &#x3D; zcol.<br>          zrow_copy_end &#x3D; 2.<br>          zcol_psate_begin &#x3D; zcol.<br>          zrow_psate_begin &#x3D; 2.<br>          zcol_psate_end &#x3D; zcol.<br>          zrow_psate_end &#x3D; znum03row01.<br>          PERFORM frm_copy_paste USING zcol_copy_begin”复制开始的列<br>                                       zrow_copy_begin”复制开始的行<br>                                       zcol_copy_end”复制结束的列<br>                                       zrow_copy_end”复制结束的行<br>                                       zcol_psate_begin”粘贴开始的列<br>                                       zrow_psate_begin”粘贴开始的行<br>                                       zcol_psate_end”粘贴结束的列<br>                                       zrow_psate_end.”粘贴结束的行<br>          zviewfirst &#x3D; zviewfirst + 1.<br>        ENDIF.<br>      ENDIF.<br>    ENDLOOP.</p>
<p>**&amp;—将第一行的公式复制到下面行</p>
<ul>
<li>DATA(znum03row01) &#x3D; znum03row + 1.”抬头有一行</li>
<li></li>
<li>DATA(zcol_copy_begin) &#x3D; 9.</li>
<li>DATA(zrow_copy_begin) &#x3D; 2.</li>
<li>DATA(zcol_copy_end) &#x3D; znum03col.</li>
<li>DATA(zrow_copy_end) &#x3D; 2.</li>
<li>DATA(zcol_psate_begin) &#x3D; 9.</li>
<li>DATA(zrow_psate_begin) &#x3D; 3.</li>
<li>DATA(zcol_psate_end) &#x3D; znum03col.</li>
<li>DATA(zrow_psate_end) &#x3D; znum03row01.</li>
<li>PERFORM frm_copy_paste USING zcol_copy_begin”复制开始的列</li>
<li><pre><code>                            zrow_copy_begin&quot;复制开始的行
</code></pre>
</li>
<li><pre><code>                            zcol_copy_end&quot;复制结束的列
</code></pre>
</li>
<li><pre><code>                            zrow_copy_end&quot;复制结束的行
</code></pre>
</li>
<li><pre><code>                            zcol_psate_begin&quot;粘贴开始的列
</code></pre>
</li>
<li><pre><code>                            zrow_psate_begin&quot;粘贴开始的行
</code></pre>
</li>
<li><pre><code>                            zcol_psate_end&quot;粘贴结束的列
</code></pre>
</li>
<li><pre><code>                            zrow_psate_end.&quot;粘贴结束的行
</code></pre>
ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_scpcb_tab<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_paste_tab.<br>DATA:zstring TYPE char50.<br>CLEAR:znum01col,znum02col,znum03col,znum01row,znum02row,znum03row,excel_tab01.<br>“获取分隔符<br>CLASS cl_abap_char_utilities DEFINITION LOAD.<br>ld_separator &#x3D; cl_abap_char_utilities&#x3D;&gt;horizontal_tab.</li>
</ul>
<p>*&amp;—将生产排产表内容放入可复制的内表中<br>  LOOP AT <ft_vb> INTO <fs_vb>.<br>    CLEAR:tem_data.<br>    LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1 WHERE fieldname &lt;&gt; ‘ICON’<br>                                                     AND fieldname &lt;&gt; ‘MSG’<br>                                                     AND fieldname &lt;&gt; ‘ZSTYLE’<br>                                                     AND fieldname &lt;&gt; ‘CELLCOLOR’.<br>      ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE <fs_vb> TO FIELD-SYMBOL(<fs_scpcb>).<br>      zstring &#x3D; <fs_scpcb>.<br>      “将内表中一行数据用分隔符拼接到一个字段中,方便后续复制<br>      IF tem_data-lines IS INITIAL.<br>        tem_data-lines &#x3D; zstring.<br>      ELSE.<br>        CONCATENATE tem_data-lines zstring INTO tem_data-lines SEPARATED BY ld_separator.<br>      ENDIF.<br>    ENDLOOP.<br>    APPEND tem_data TO excel_tab01.<br>  ENDLOOP.</p>
<p>  DATA(lt_fieldcatalog1) &#x3D; gt_fieldcatalog1.<br>  DELETE lt_fieldcatalog1 WHERE fieldname &#x3D; ‘ICON’ OR fieldname &#x3D; ‘MSG’ OR fieldname &#x3D; ‘ZSTYLE’ OR fieldname &#x3D; ‘CELLCOLOR’.<br>  DESCRIBE TABLE lt_fieldcatalog1 LINES znum01col.”记录共有多少列<br>  DESCRIBE TABLE <ft_vb> LINES znum01row.”记录共有多少行</p>
<p>*&amp;—将BOM清单内容放入可复制的内表中<br>  CLEAR:excel_tab02.<br>  LOOP AT <ft_vb_bom> INTO <fs_vb_bom>.<br>    CLEAR:tem_data.<br>    LOOP AT gt_fieldcatalog3 INTO gs_fieldcatalog3 WHERE fieldname &lt;&gt; ‘ICON’<br>                                                     AND fieldname &lt;&gt; ‘MSG’<br>                                                     AND fieldname &lt;&gt; ‘ZSTYLE’<br>                                                     AND fieldname &lt;&gt; ‘CELLCOLOR’.<br>      ASSIGN COMPONENT gs_fieldcatalog3-fieldname OF STRUCTURE <fs_vb_bom> TO FIELD-SYMBOL(<fs_bomqd>).<br>      zstring &#x3D; <fs_bomqd>.<br>      “将内表中一行数据用分隔符拼接到一个字段中,方便后续复制<br>      IF tem_data-lines IS INITIAL.<br>        tem_data-lines &#x3D; zstring.<br>      ELSE.<br>        CONCATENATE tem_data-lines zstring INTO tem_data-lines SEPARATED BY ld_separator.<br>      ENDIF.<br>    ENDLOOP.<br>    APPEND tem_data TO excel_tab02.<br>  ENDLOOP.<br>  DATA(lt_fieldcatalog3) &#x3D; gt_fieldcatalog3.<br>  DELETE lt_fieldcatalog3 WHERE fieldname &#x3D; ‘ICON’ OR fieldname &#x3D; ‘MSG’ OR fieldname &#x3D; ‘ZSTYLE’ OR fieldname &#x3D; ‘CELLCOLOR’.<br>  DESCRIBE TABLE lt_fieldcatalog3 LINES znum02col.”记录共有多少列<br>  DESCRIBE TABLE <ft_vb_bom> LINES znum02row.”记录共有多少行</p>
<p>*&amp;—将核料表内容放入可复制的内表中<br>  CLEAR:excel_tab03.<br>  LOOP AT <ft_vb_hlb> INTO <fs_vb_hlb>.<br>    CLEAR:tem_data.<br>    LOOP AT gt_fieldcatalog_01 INTO gs_fieldcatalog_01 WHERE fieldname &lt;&gt; ‘ICON’<br>                                                         AND fieldname &lt;&gt; ‘MSG’<br>                                                         AND fieldname &lt;&gt; ‘ZSTYLE’<br>                                                         AND fieldname &lt;&gt; ‘CELLCOLOR’.<br>      ASSIGN COMPONENT gs_fieldcatalog_01-fieldname OF STRUCTURE <fs_vb_hlb> TO FIELD-SYMBOL(<fs_hlb01>).<br>      zstring &#x3D; <fs_hlb01>.<br>      “将内表中一行数据用分隔符拼接到一个字段中,方便后续复制<br>      IF tem_data-lines IS INITIAL.<br>        tem_data-lines &#x3D; zstring.<br>      ELSE.<br>        CONCATENATE tem_data-lines zstring INTO tem_data-lines SEPARATED BY ld_separator.<br>      ENDIF.<br>    ENDLOOP.<br>    APPEND tem_data TO excel_tab03.<br>  ENDLOOP.<br>  DATA(lt_fieldcatalog_01) &#x3D; gt_fieldcatalog_01.<br>  DELETE lt_fieldcatalog_01 WHERE fieldname &#x3D; ‘ICON’ OR fieldname &#x3D; ‘MSG’ OR fieldname &#x3D; ‘ZSTYLE’ OR fieldname &#x3D; ‘CELLCOLOR’.<br>  DESCRIBE TABLE lt_fieldcatalog_01 LINES znum03col.”记录共有多少列<br>  DESCRIBE TABLE <ft_vb_hlb> LINES znum03row.”记录共有多少行<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_copy_paste<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; ZCOL_COPY_BEGIN<br>*&amp;      –&gt; ZROW_COPY_BEGIN<br>*&amp;      –&gt; ZCOL_COPY_END<br>*&amp;      –&gt; ZROW_COPY_END<br>*&amp;      –&gt; ZCOL_PSATE_BEGIN<br>*&amp;      –&gt; ZROW_PSATE_BEGIN<br>*&amp;      –&gt; ZCOL_PSATE_END<br>*&amp;      –&gt; ZROW_PSATE_END<br><em>&amp;———————————————————————</em><br>FORM frm_copy_paste  USING    p_zcol_copy_begin<br>                              p_zrow_copy_begin<br>                              p_zcol_copy_end<br>                              p_zrow_copy_end<br>                              p_zcol_psate_begin<br>                              p_zrow_psate_begin<br>                              p_zcol_psate_end<br>                              p_zrow_psate_end.<br>*&amp;—选中复制区域<br>  “开始的行，列<br>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; p_zcol_copy_begin.<br>  DATA(zformula_yfpl) &#x3D; gs_col-col &amp;&amp; p_zrow_copy_begin.</p>
<p>  “结束的行列<br>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; p_zcol_copy_end.<br>  zformula_yfpl &#x3D; zformula_yfpl &amp;&amp; ‘:’ &amp;&amp; gs_col-col &amp;&amp; p_zrow_copy_end.</p>
<p>  “选中区域<br>  CALL METHOD OF<br>      mysheet<br>      ‘RANGE’ &#x3D; myrange<br>    EXPORTING<br>      #1      &#x3D; zformula_yfpl. “也可以是用户自定义的单元格名称</p>
<p>  “复制<br>  CALL METHOD OF<br>    myrange<br>    ‘COPY’.</p>
<p>*&amp;—选中粘贴区域<br>  “开始的行，列<br>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; p_zcol_psate_begin.<br>  zformula_yfpl &#x3D; gs_col-col &amp;&amp; p_zrow_psate_begin.</p>
<p>  “结束的行列<br>  READ TABLE gt_col INTO gs_col WITH KEY number &#x3D; p_zcol_psate_end.<br>  zformula_yfpl &#x3D; zformula_yfpl &amp;&amp; ‘:’ &amp;&amp; gs_col-col &amp;&amp; p_zrow_psate_end.</p>
<p>  “选中区域<br>  CALL METHOD OF<br>    mysheet<br>    ‘RANGE’ &#x3D; myrange<br>  EXPORTING<br>     #1      &#x3D; zformula_yfpl. “也可以是用户自定义的单元格名称</p>
<p>  “粘贴<br>  CALL METHOD OF<br>    myrange<br>    ‘PasteSpecial’.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_file_path<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_get_file_path USING rc CHANGING p_path.<br>  DATA:file_table TYPE filetable.<br>  CALL METHOD cl_gui_frontend_services&#x3D;&gt;file_open_dialog<br>    EXPORTING<br>      window_title            &#x3D; ‘选择文件’ “标题</p>
<ul>
<li><pre><code>default_extension       = &#39;&#39;
default_filename        = &#39;&#39; &quot;默认的文件名
file_filter             = cl_gui_frontend_services=&gt;filetype_excel &quot;指定文件类型
</code></pre>
</li>
<li><pre><code>with_encoding           =
</code></pre>
</li>
<li><pre><code>initial_directory       =
</code></pre>
</li>
<li><pre><code>multiselection          =
</code></pre>
  CHANGING<br>file_table              &#x3D; file_table<br>rc                      &#x3D; rc</li>
<li><pre><code>user_action             = user_action
</code></pre>
</li>
<li><pre><code>file_encodi ng           = file_encoding
</code></pre>
  EXCEPTIONS<br>file_open_dialog_failed &#x3D; 1<br>cntl_error              &#x3D; 2<br>error_no_gui            &#x3D; 3<br>not_supported_by_gui    &#x3D; 4<br>OTHERS                  &#x3D; 5.<br>IF sy-subrc &lt;&gt; 0.<br>  MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno<br>      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.<br>ELSE.<br>  READ TABLE file_table INTO DATA(s_file_table) INDEX 1.<br>  IF sy-subrc &#x3D; 0.<br>p_path &#x3D; s_file_table.<br>  ENDIF.<br>ENDIF.<br>**&amp;—所有文件类型<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_ALL<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_TEXT<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_XML<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_HTML<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_EXCEL<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_RTF<br>*cl_gui_frontend_services&#x3D;&gt;FILETYPE_WORD</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_excel_data<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; P_PATH<br><em>&amp;———————————————————————</em><br>FORM frm_get_excel_data  USING  p_p_path.</p>
<p>*&amp;—生产排产表数据获取<br>  PERFORM frm_get_scpcb01 USING p_p_path.</p>
<p>*&amp;—BOM清单数据获取<br>  PERFORM frm_get_bomqd02 USING p_p_path .</p>
<p>*&amp;—核料表数据获取<br>  PERFORM frm_get_hlb03 USING p_p_path.</p>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_scpcb01<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; P_P_PATH<br><em>&amp;———————————————————————</em><br>FORM frm_get_scpcb01  USING  p_p_p_path.<br>  DATA:t_intern TYPE TABLE OF zalsmex_tabline.<br>  CLEAR:t_intern.<br>  CALL FUNCTION ‘ZCALSM_EXCEL_TO_INTERNAL_TABLE’<br>    EXPORTING<br>      filename                &#x3D; p_p_p_path<br>      i_begin_col             &#x3D; 1<br>      i_begin_row             &#x3D; 2<br>      i_end_col               &#x3D; 99<br>      i_end_row               &#x3D; 9999<br>      sheet_name              &#x3D; ‘生产排产表’<br>    TABLES<br>      intern                  &#x3D; t_intern<br>    EXCEPTIONS<br>      inconsistent_parameters &#x3D; 1<br>      upload_ole              &#x3D; 2<br>      OTHERS                  &#x3D; 3.<br>  IF sy-subrc &lt;&gt; 0.</p>
<ul>
<li>Implement suitable error handling here<br>ENDIF.</li>
</ul>
<p>*&amp;—创建一个与EXCEL相同结构的结构,将EXCEL数据传入生产排产表<br>  CLEAR:<fs_vb>.<br>  PERFORM frm_creat_structure TABLES gt_fieldcatalog1<br>                                     <ft_vb><br>                                     t_intern<br>                              USING  <fs_vb>.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_BOMQD02<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; P_P_PATH<br><em>&amp;———————————————————————</em><br>FORM frm_get_bomqd02  USING    p_p_p_path.<br>  DATA:t_intern TYPE TABLE OF zalsmex_tabline.<br>  CLEAR:t_intern.<br>  CALL FUNCTION ‘ZCALSM_EXCEL_TO_INTERNAL_TABLE’<br>    EXPORTING<br>      filename                &#x3D; p_p_p_path<br>      i_begin_col             &#x3D; 1<br>      i_begin_row             &#x3D; 2<br>      i_end_col               &#x3D; 99<br>      i_end_row               &#x3D; 9999<br>      sheet_name              &#x3D; ‘BOM清单’<br>    TABLES<br>      intern                  &#x3D; t_intern<br>    EXCEPTIONS<br>      inconsistent_parameters &#x3D; 1<br>      upload_ole              &#x3D; 2<br>      OTHERS                  &#x3D; 3.<br>  IF sy-subrc &lt;&gt; 0.</p>
<ul>
<li>Implement suitable error handling here<br>ENDIF.</li>
</ul>
<p>*&amp;—创建一个与EXCEL相同结构的结构,将EXCEL数据传入生产排产表<br>  PERFORM frm_creat_structure TABLES gt_fieldcatalog3<br>                                     <ft_vb_bom><br>                                     t_intern<br>                              USING  <fs_vb_bom>.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_HLB03<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; P_P_PATH<br><em>&amp;———————————————————————</em><br>FORM frm_get_hlb03  USING    p_p_p_path.<br>  DATA:t_intern TYPE TABLE OF zalsmex_tabline.<br>  CLEAR:t_intern.<br>  CALL FUNCTION ‘ZCALSM_EXCEL_TO_INTERNAL_TABLE’<br>    EXPORTING<br>      filename                &#x3D; p_p_p_path<br>      i_begin_col             &#x3D; 1<br>      i_begin_row             &#x3D; 2<br>      i_end_col               &#x3D; 99<br>      i_end_row               &#x3D; 9999<br>      sheet_name              &#x3D; tab_appl_tab2<br>    TABLES<br>      intern                  &#x3D; t_intern<br>    EXCEPTIONS<br>      inconsistent_parameters &#x3D; 1<br>      upload_ole              &#x3D; 2<br>      OTHERS                  &#x3D; 3.<br>  IF sy-subrc &lt;&gt; 0.</p>
<ul>
<li>Implement suitable error handling here<br>ENDIF.</li>
</ul>
<p>*&amp;—创建一个与EXCEL相同结构的结构,将EXCEL数据传入生产排产表<br>  PERFORM frm_creat_structure TABLES gt_fieldcatalog_01<br>                                     <ft_vb_hlb><br>                                     t_intern<br>                              USING  <fs_vb_hlb>.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_creat_structure<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_creat_structure TABLES gt_fieldcat STRUCTURE lvc_s_fcat<br>                                lt_excel_tab TYPE STANDARD TABLE<br>                                lt_intern STRUCTURE zalsmex_tabline<br>                          USING ls_tab05.<br>  FIELD-SYMBOLS:<ft_vb_excel> TYPE STANDARD TABLE,<br>                <fs>          TYPE any.<br>  DATA(lt_fieldcat01) &#x3D; gt_fieldcat[].<br>  DELETE lt_fieldcat01 WHERE fieldname &#x3D; ‘ICON’ OR fieldname &#x3D; ‘MSG’ OR fieldname &#x3D; ‘ZSTYLE’ OR fieldname &#x3D; ‘CELLCOLOR’.</p>
<p>*&amp;—生成动态内表<br>  CALL METHOD cl_alv_table_create&#x3D;&gt;create_dynamic_table<br>    EXPORTING<br>      it_fieldcatalog           &#x3D; lt_fieldcat01   “输入FIELDCATALOG 将返回一个动态内表<br>    IMPORTING<br>      ep_table                  &#x3D; lt_new_table  “获取返回的动态内表 (类)<br>    EXCEPTIONS<br>      generate_subpool_dir_full &#x3D; 1<br>      OTHERS                    &#x3D; 2.<br>  IF sy-subrc &lt;&gt; 0.<br>    EXIT.<br>  ENDIF.</p>
<p>  ASSIGN lt_new_table-&gt;* TO <ft_vb_excel> .     “LT_NEW_TABLE 中的所有都被指向<ft_vb_excel>（动态内表）<br>  CREATE DATA ls_new_line LIKE LINE OF <ft_vb_excel> .<br>  ASSIGN ls_new_line-&gt;* TO <fs_vb_excel> .      “LS_NEW_LINE 中的所有都被指向<FS_VB> （动态内表结构）</p>
<p>*&amp;—将上载的EXCEL数据插入内表<br>  CLEAR:lt_excel_tab[].<br>  LOOP AT lt_intern.<br>    ASSIGN COMPONENT lt_intern-col OF STRUCTURE <fs_vb_excel> TO <fs>.<br>    <fs> &#x3D; lt_intern-value.<br>    AT END OF row.<br>      “备选补0<br>      ASSIGN COMPONENT ‘STLAL’ OF STRUCTURE <fs_vb_excel> TO <fs>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs> &#x3D; |{ <fs> ALPHA &#x3D; IN }|.<br>      ENDIF.<br>      “物料号补0<br>      ASSIGN COMPONENT ‘MATNR’ OF STRUCTURE <fs_vb_excel> TO <fs>.<br>      IF sy-subrc &#x3D; 0.<br>        CALL FUNCTION ‘CONVERSION_EXIT_MATN1_INPUT’<br>          EXPORTING<br>            input        &#x3D; <fs><br>          IMPORTING<br>            output       &#x3D; <fs><br>          EXCEPTIONS<br>            length_error &#x3D; 1<br>            OTHERS       &#x3D; 2.<br>      ENDIF.<br>      “生产版本补0<br>      ASSIGN COMPONENT ‘VERID’ OF STRUCTURE <fs_vb_excel> TO <fs>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs> &#x3D; |{ <fs> ALPHA &#x3D; IN }|.<br>      ENDIF.</p>
<pre><code>  &quot;旧物料号补0
  ASSIGN COMPONENT &#39;BISMT&#39; OF STRUCTURE &lt;fs_vb_excel&gt; TO &lt;fs&gt;.
  IF sy-subrc = 0.
    CALL FUNCTION &#39;CONVERSION_EXIT_MATN1_INPUT&#39;
      EXPORTING
        input        = &lt;fs&gt;
      IMPORTING
        output       = &lt;fs&gt;
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.
  ENDIF.

  &quot;物料代码补0
  ASSIGN COMPONENT &#39;MATNRZJ&#39; OF STRUCTURE &lt;fs_vb_excel&gt; TO &lt;fs&gt;.
  IF sy-subrc = 0.
    CALL FUNCTION &#39;CONVERSION_EXIT_MATN1_INPUT&#39;
      EXPORTING
        input        = &lt;fs&gt;
      IMPORTING
        output       = &lt;fs&gt;
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.
  ENDIF.

  &quot;旧物料号补0
  ASSIGN COMPONENT &#39;BISMTZJ&#39; OF STRUCTURE &lt;fs_vb_excel&gt; TO &lt;fs&gt;.
  IF sy-subrc = 0.
    CALL FUNCTION &#39;CONVERSION_EXIT_MATN1_INPUT&#39;
      EXPORTING
        input        = &lt;fs&gt;
      IMPORTING
        output       = &lt;fs&gt;
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.
  ENDIF.

  &quot;组件物料补0
  ASSIGN COMPONENT &#39;MATNRHLB&#39; OF STRUCTURE &lt;fs_vb_excel&gt; TO &lt;fs&gt;.
  IF sy-subrc = 0.
    CALL FUNCTION &#39;CONVERSION_EXIT_MATN1_INPUT&#39;
      EXPORTING
        input        = &lt;fs&gt;
      IMPORTING
        output       = &lt;fs&gt;
      EXCEPTIONS
        length_error = 1
        OTHERS       = 2.
  ENDIF.

  MOVE-CORRESPONDING &lt;fs_vb_excel&gt; TO ls_tab05.
  APPEND ls_tab05 TO lt_excel_tab.
  CLEAR:&lt;fs_vb_excel&gt;,ls_tab05.
ENDAT.
</code></pre>
<p>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_zbom<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_zbom .<br>*&amp;—重新运行核料表，BOM清单的取数逻辑<br>  “获取核料表数据<br>  PERFORM zhlb_get_data.<br>*&amp;—获取bom清单数据<br>  PERFORM get_data_bom.</p>
<p>*&amp;—LAYOUT刷新<br>  CALL METHOD gr_table1-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  CALL METHOD gr_table2-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table2-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  CALL METHOD gr_table3-&gt;get_frontend_layout<br>    IMPORTING<br>      es_layout &#x3D; gs_layout.<br>  gs_layout-cwidth_opt &#x3D; ‘X’.<br>  CALL METHOD gr_table3-&gt;set_frontend_layout<br>    EXPORTING<br>      is_layout &#x3D; gs_layout.</p>
<p>  DATA:stbll TYPE lvc_s_stbl.<br>  stbll-row &#x3D; ‘X’.<br>  stbll-col &#x3D; ‘X’.<br>  CALL METHOD gr_table1-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>  CALL METHOD gr_table2-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.<br>  CALL METHOD gr_table3-&gt;refresh_table_display<br>    EXPORTING<br>      is_stable &#x3D; stbll.</p>
<p>  CALL METHOD gr_table1-&gt;refresh_table_display.<br>  CALL METHOD gr_table2-&gt;refresh_table_display.<br>  CALL METHOD gr_table3-&gt;refresh_table_display.</p>
<p>  MESSAGE ‘BOM已重新展开!’ TYPE ‘S’.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_zsave01<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_zsave01 .<br>  DATA:zupdate TYPE c.”更新标识</p>
<p>*&amp;—根据保存日期，保存人，删除当天的所有数据后，再去保存<br>  PERFORM frm_del_data.</p>
<p>*&amp;—保存生产排产表<br>  PERFORM frm_zsave USING zupdate.</p>
<p>  IF zupdate &#x3D; ‘X’.<br>*&amp;—保存BOM清单表<br>    PERFORM frm_save_bom_list USING zupdate.</p>
<pre><code>IF zupdate = &#39;X&#39;.
</code></pre>
<p>*&amp;—保存核料表<br>      PERFORM frm_save_hlb USING zupdate.</p>
<pre><code>  IF zupdate = &#39;X&#39;.
    COMMIT WORK AND WAIT .
    MESSAGE &#39;保存成功!&#39; TYPE &#39;S&#39;.
  ELSE.
    ROLLBACK WORK.
    MESSAGE &#39;数据保存失败，请稍后再试，或者联系SAP管理员!&#39; TYPE &#39;E&#39;.
  ENDIF.
ENDIF.
</code></pre>
<p>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_save_bom_list<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_save_bom_list USING zupdate.<br>*&amp;—抬头信息一致，因为日期不定，所以按照报表字段一个数据保存一行<br>  DATA:lt_zta_pp006        TYPE TABLE OF zta_pp006,<br>       ls_zta_pp006_header TYPE zta_pp006,<br>       ls_zta_pp006        TYPE zta_pp006.</p>
<p>  LOOP AT <ft_vb_bom> ASSIGNING FIELD-SYMBOL(<fs_bom_history>).<br>    MOVE-CORRESPONDING <fs_bom_history> TO ls_zta_pp006_header.<br>    ls_zta_pp006_header-zdate &#x3D; sy-datum.<br>    ls_zta_pp006_header-zuser &#x3D; zoperator.<br>    ls_zta_pp006_header-zuzeit &#x3D; sy-uzeit.</p>
<p>*&amp;—日期下的数量<br>    LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1 WHERE ( fieldname(1) &#x3D; ‘Z’ AND scrtext_s(1) &#x3D; ‘周’)<br>                                                      OR  ( fieldname(2) &#x3D; ‘ZW’ AND scrtext_s(1) &#x3D; ‘W’) .<br>      CLEAR:ls_zta_pp006.<br>      ls_zta_pp006 &#x3D; ls_zta_pp006_header.<br>      “抬头字段名称<br>      ls_zta_pp006-zdmc &#x3D; gs_fieldcatalog1-fieldname.<br>      ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE <fs_bom_history> TO FIELD-SYMBOL(<ft_bom>).<br>      IF sy-subrc &#x3D; 0.<br>        “需求数量<br>        ls_zta_pp006-zxqsl &#x3D; <ft_bom>.<br>      ENDIF.<br>      APPEND ls_zta_pp006 TO lt_zta_pp006.<br>    ENDLOOP.<br>  ENDLOOP.</p>
<p>  MODIFY zta_pp006 FROM TABLE lt_zta_pp006.<br>  IF sy-subrc &#x3D; 0.<br>    zupdate &#x3D; ‘X’.<br>  ELSE.<br>    CLEAR:zupdate.<br>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_save_hlb<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_save_hlb USING zupdate.<br>*&amp;—抬头信息一致，因为日期不定，所以按照报表字段一个数据保存一行<br>  DATA:lt_zta_pp007        TYPE TABLE OF zta_pp007,<br>       ls_zta_pp007_header TYPE zta_pp007,<br>       ls_zta_pp007        TYPE zta_pp007.</p>
<p>  LOOP AT <ft_vb_hlb> ASSIGNING FIELD-SYMBOL(<fs_hlb>).<br>    MOVE-CORRESPONDING <fs_hlb> TO ls_zta_pp007_header.<br>    ls_zta_pp007_header-zdate &#x3D; sy-datum.<br>    ls_zta_pp007_header-zuser &#x3D; zoperator.<br>    ls_zta_pp007_header-zuzeit &#x3D; sy-uzeit.<br>    ls_zta_pp007_header-ztitle &#x3D; tab_appl_tab2.</p>
<p>*&amp;—日期下的数量<br>    LOOP AT gt_fieldcatalog1 INTO gs_fieldcatalog1 WHERE ( fieldname(1) &#x3D; ‘Z’ AND scrtext_s(1) &#x3D; ‘周’)<br>                                                      OR  ( fieldname(2) &#x3D; ‘ZW’ AND scrtext_s(1) &#x3D; ‘W’) .<br>      CLEAR:ls_zta_pp007.<br>      ls_zta_pp007 &#x3D; ls_zta_pp007_header.<br>      “需求行<br>      ls_zta_pp007-zdmc &#x3D; gs_fieldcatalog1-fieldname &amp;&amp; ‘XQ’.<br>      ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE <fs_hlb> TO FIELD-SYMBOL(<ft_hlb>).<br>      IF sy-subrc &#x3D; 0.<br>        ls_zta_pp007-zsl &#x3D; <ft_hlb>.<br>      ENDIF.<br>      APPEND ls_zta_pp007 TO lt_zta_pp007.</p>
<pre><code>  CLEAR:ls_zta_pp007.
  ls_zta_pp007 = ls_zta_pp007_header.
  &quot;供给行
  ls_zta_pp007-zdmc = gs_fieldcatalog1-fieldname &amp;&amp; &#39;GG&#39;.
  ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE &lt;fs_hlb&gt; TO &lt;ft_hlb&gt;.
  IF sy-subrc = 0.
    ls_zta_pp007-zsl = &lt;ft_hlb&gt;.
  ENDIF.
  APPEND ls_zta_pp007 TO lt_zta_pp007.

  CLEAR:ls_zta_pp007.
  ls_zta_pp007 = ls_zta_pp007_header.
  &quot;累计差异行
  ls_zta_pp007-zdmc = gs_fieldcatalog1-fieldname &amp;&amp; &#39;LJ&#39;.
  ASSIGN COMPONENT gs_fieldcatalog1-fieldname OF STRUCTURE &lt;fs_hlb&gt; TO &lt;ft_hlb&gt;.
  IF sy-subrc = 0.
    ls_zta_pp007-zsl = &lt;ft_hlb&gt;.
  ENDIF.
  APPEND ls_zta_pp007 TO lt_zta_pp007.
ENDLOOP.
</code></pre>
<p>  ENDLOOP.<br>  MODIFY zta_pp007 FROM TABLE lt_zta_pp007.<br>  IF sy-subrc &#x3D; 0.<br>    zupdate &#x3D; ‘X’.<br>  ELSE.<br>    CLEAR:zupdate.<br>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_bom_list_history<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_get_bom_list_history.<br>  SELECT *<br>    FROM zta_pp006<br>    INTO TABLE @DATA(lt_zta_pp006)<br>    WHERE zdate IN @s_zzdrq<br>    AND   zuser IN @s_zuser.</p>
<p>  “去重得到抬头<br>  DATA(lt_zta_pp006_copy) &#x3D; lt_zta_pp006.<br>  SORT:lt_zta_pp006_copy BY werks matnr matnrzj verid zuser zdate.<br>  DELETE ADJACENT DUPLICATES FROM lt_zta_pp006_copy COMPARING werks matnr matnrzj verid zuser zdate.</p>
<p>  IF lt_zta_pp006_copy IS NOT INITIAL.<br>*&amp;—查询模块代码名称，物料代码名称<br>    SELECT matnr,<br>           maktx<br>      FROM makt<br>      INTO TABLE @DATA(lt_makt)<br>      FOR ALL ENTRIES IN @lt_zta_pp006_copy<br>      WHERE spras &#x3D; @sy-langu<br>      AND   ( matnr &#x3D; @lt_zta_pp006_copy-matnr<br>      OR    matnr &#x3D; @lt_zta_pp006_copy-matnrzj ).<br>    SORT:lt_makt BY matnr.<br>  ENDIF.</p>
<p>  LOOP AT lt_zta_pp006_copy INTO DATA(ls_zta_pp006_copy).<br>    CLEAR:<fs_vb_bom>.<br>    MOVE-CORRESPONDING ls_zta_pp006_copy TO <fs_vb_bom>.</p>
<pre><code>LOOP AT lt_zta_pp006 INTO DATA(ls_zta_pp006) WHERE werks = ls_zta_pp006_copy-werks
                                               AND  matnr = ls_zta_pp006_copy-matnr
                                               AND  matnrzj = ls_zta_pp006_copy-matnrzj
                                               AND  verid = ls_zta_pp006_copy-verid
                                               AND  zuser = ls_zta_pp006_copy-zuser
                                               AND  zdate = ls_zta_pp006_copy-zdate.
  ASSIGN COMPONENT ls_zta_pp006-zdmc OF STRUCTURE &lt;fs_vb_bom&gt; TO FIELD-SYMBOL(&lt;fs_bom&gt;).
  IF sy-subrc = 0.
    &lt;fs_bom&gt; = ls_zta_pp006-zxqsl.
  ENDIF.
ENDLOOP.
</code></pre>
<p>*&amp;—模块代码名称<br>    READ TABLE lt_makt INTO DATA(ls_makt) WITH KEY matnr &#x3D; ls_zta_pp006_copy-matnr BINARY SEARCH.<br>    IF sy-subrc  &#x3D; 0.<br>      ASSIGN COMPONENT ‘MAKTX’ OF STRUCTURE <fs_vb_bom> TO <fs_bom>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs_bom> &#x3D; ls_makt-maktx.<br>      ENDIF.<br>    ENDIF.<br>*&amp;—物料代码名称<br>    READ TABLE lt_makt INTO ls_makt WITH KEY matnr &#x3D; ls_zta_pp006_copy-matnrzj BINARY SEARCH.<br>    IF sy-subrc  &#x3D; 0.<br>      ASSIGN COMPONENT ‘MAKTXZJ’ OF STRUCTURE <fs_vb_bom> TO <fs_bom>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs_bom> &#x3D; ls_makt-maktx.<br>      ENDIF.<br>    ENDIF.</p>
<pre><code>APPEND &lt;fs_vb_bom&gt; TO &lt;ft_vb_bom&gt;.
</code></pre>
<p>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_get_hlb_history<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_get_hlb_history .<br>  SELECT *<br>    FROM zta_pp007<br>    INTO TABLE @DATA(lt_zta_pp007)<br>    WHERE zdate IN @s_zzdrq<br>    AND   zuser IN @s_zuser.</p>
<p>  “去重得到抬头<br>  DATA(lt_zta_pp007_copy) &#x3D; lt_zta_pp007.<br>  SORT:lt_zta_pp007_copy BY zdate zuser werks matnrhlb.<br>  DELETE ADJACENT DUPLICATES FROM lt_zta_pp007_copy COMPARING zdate zuser werks matnrhlb.</p>
<p>  IF lt_zta_pp007_copy IS NOT INITIAL.<br>*&amp;—查询组件物料名称，旧物料代码名称<br>    SELECT matnr,<br>           maktx<br>      FROM makt<br>      INTO TABLE @DATA(lt_makt)<br>      FOR ALL ENTRIES IN @lt_zta_pp007_copy<br>      WHERE spras &#x3D; @sy-langu<br>      AND   ( matnr &#x3D; @lt_zta_pp007_copy-matnrhlb<br>      OR    matnr &#x3D; @lt_zta_pp007_copy-bismt ).<br>    SORT:lt_makt BY matnr.<br>  ENDIF.</p>
<p>  LOOP AT lt_zta_pp007_copy INTO DATA(ls_zta_pp007_copy).<br>    CLEAR:<fs_vb_bom>.<br>    MOVE-CORRESPONDING ls_zta_pp007_copy TO <fs_vb_hlb>.<br>    “页签标题<br>    tab_appl_tab2 &#x3D; ls_zta_pp007_copy-ztitle.</p>
<pre><code>LOOP AT lt_zta_pp007 INTO DATA(ls_zta_pp007) WHERE werks = ls_zta_pp007_copy-werks
                                               AND  matnrhlb = ls_zta_pp007_copy-matnrhlb
                                               AND  zdate = ls_zta_pp007_copy-zdate
                                               AND  zuser = ls_zta_pp007_copy-zuser.
  ASSIGN COMPONENT ls_zta_pp007_copy-zdmc OF STRUCTURE &lt;fs_vb_hlb&gt; TO FIELD-SYMBOL(&lt;fs_hlb&gt;).
  IF sy-subrc = 0.
    &lt;fs_hlb&gt; = ls_zta_pp007_copy-zsl.
  ENDIF.
ENDLOOP.
</code></pre>
<p>*&amp;—组件物料名称<br>    READ TABLE lt_makt INTO DATA(ls_makt) WITH KEY matnr &#x3D; ls_zta_pp007_copy-matnrhlb BINARY SEARCH.<br>    IF sy-subrc  &#x3D; 0.<br>      ASSIGN COMPONENT ‘MAKTXHLB’ OF STRUCTURE <fs_vb_hlb> TO <fs_hlb>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs_hlb> &#x3D; ls_makt-maktx.<br>      ENDIF.<br>    ENDIF.<br>*&amp;—旧物料代码名称<br>    READ TABLE lt_makt INTO ls_makt WITH KEY matnr &#x3D; ls_zta_pp007_copy-bismt BINARY SEARCH.<br>    IF sy-subrc  &#x3D; 0.<br>      ASSIGN COMPONENT ‘TEXT1’ OF STRUCTURE <fs_vb_hlb> TO <fs_hlb>.<br>      IF sy-subrc &#x3D; 0.<br>        <fs_hlb> &#x3D; ls_makt-maktx.<br>      ENDIF.<br>    ENDIF.</p>
<pre><code>APPEND &lt;fs_vb_hlb&gt; TO &lt;ft_vb_hlb&gt;.
</code></pre>
<p>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Module STATUS_9004 OUTPUT<br><em>&amp;———————————————————————</em><br>*&amp;<br><em>&amp;———————————————————————</em><br>MODULE status_9004 OUTPUT.<br>  SET PF-STATUS ‘ZGUI_9004’.</p>
<ul>
<li>SET TITLEBAR ‘xxx’.<br>ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp;      Module  USER_COMMAND_9004  INPUT</li>
</ul>
<p><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  text
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE user_command_9004 INPUT.<br>  DATA:save_ok TYPE sy-ucomm.<br>  CLEAR save_ok.<br>  save_ok &#x3D; ok_code.<br>  CASE save_ok.<br>    WHEN ‘YES’.<br>      PERFORM frm_zsave01.<br>      LEAVE TO SCREEN 0.<br>  ENDCASE.</p>
<p>ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp; Form FRM_SEL_SCREEN_PBO<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_sel_screen_pbo .<br>  LOOP AT SCREEN.<br>    IF p_zlsjl &#x3D; ‘X’.<br>      CASE screen-group1.<br>        WHEN ‘CMY’.<br>          screen-active &#x3D; ‘1’.<br>        WHEN ‘SLM’.<br>          screen-active &#x3D; ‘0’.<br>      ENDCASE.<br>    ELSE.<br>      CASE screen-group1.<br>        WHEN ‘CMY’.<br>          screen-active &#x3D; ‘0’.<br>        WHEN ‘SLM’.<br>          screen-active &#x3D; ‘1’.<br>      ENDCASE.<br>    ENDIF.<br>    MODIFY SCREEN.<br>  ENDLOOP.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp;      Module  USER_COMMAND_9004_EXIT  INPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  text
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE user_command_9004_exit INPUT.<br>  CLEAR save_ok.<br>  save_ok &#x3D; ok_code.<br>  CASE save_ok.<br>    WHEN ‘NO’.<br>      MESSAGE ‘操作取消!’ TYPE ‘S’ DISPLAY LIKE ‘W’.”操作取消！<br>      LEAVE TO SCREEN 0.<br>  ENDCASE.<br>ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_del_data<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br><em>&amp;———————————————————————</em><br>FORM frm_del_data .<br>  DELETE FROM zta_pp004 WHERE zzdrq &#x3D; sy-datum AND zzdr &#x3D; zoperator.<br>  DELETE FROM zta_pp006 WHERE zdate &#x3D; sy-datum AND zuser &#x3D; zoperator.<br>  DELETE FROM zta_pp007 WHERE zdate &#x3D; sy-datum AND zuser &#x3D; zoperator.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp;      Module  F4_FOR_ZOPERATOR_LIST  INPUT<br><em>&amp;———————————————————————</em></p>
<ul>
<li><pre><code>  text
</code></pre>
</li>
</ul>
<p><em>———————————————————————-</em><br>MODULE f4_for_zoperator_list INPUT.<br>  DATA:id       TYPE vrm_id,<br>       t_values TYPE vrm_values,<br>       s_values TYPE vrm_value.</p>
<p>  CLEAR:id,t_values,s_values.<br>*&amp;—下拉框添加的字段名称<br>  id &#x3D; ‘ZOPERATOR’.</p>
<p>  SELECT *<br>    FROM zta_pp008<br>    INTO TABLE @DATA(lt_zta_pp008)<br>    WHERE ztcode &#x3D; @sy-tcode.</p>
<p>*&amp;—下拉框展示的值<br>  LOOP AT lt_zta_pp008 INTO DATA(ls_zta_pp008).<br>    s_values-key &#x3D; ls_zta_pp008-zuser.<br>    APPEND s_values TO t_values.<br>  ENDLOOP.</p>
<p>*&amp;—下拉框函数<br>  CALL FUNCTION ‘VRM_SET_VALUES’<br>    EXPORTING<br>      id              &#x3D; id<br>      values          &#x3D; t_values<br>    EXCEPTIONS<br>      id_illegal_name &#x3D; 1<br>      OTHERS          &#x3D; 2.<br>  IF sy-subrc &lt;&gt; 0.<br>    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno<br>        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.<br>  ENDIF.<br>ENDMODULE.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_bapi1<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM authotity_check .<br>  SELECT *  FROM zta_pp009 INTO TABLE @DATA(lt_zta_pp009) WHERE uname &#x3D; @sy-uname AND pasch &#x3D; ‘PMC’.<br>  IF lt_zta_pp009 IS INITIAL.<br>    MESSAGE ‘您不具有PMC 的计划分组，请联系IT在ZTA_PP009中维护计划分组’ TYPE ‘E’.<br>  ENDIF.<br>ENDFORM.<br>*&amp;———————————————————————*<br>*&amp; Form frm_bom_expand<br>*&amp;———————————————————————*<br>*&amp; text<br>*&amp;———————————————————————*<br>*&amp;      –&gt; ZMATNR<br>*&amp;      –&gt; ZSTLAL<br>*&amp;      –&gt; ZSTLAN<br>*&amp;      –&gt; ZWERKS<br><em>&amp;———————————————————————</em><br>FORM frm_bom_expand  USING zmatnr zstlal zstlan zwerks.<br>  DATA:s_stb TYPE stpox.<br>  CLEAR:stb.<br>*&amp;—查询是否存在已展开的记录<br>  READ TABLE gt_stpox INTO gs_stpox WITH KEY matnrcp &#x3D; zmatnr<br>                                             werkscp &#x3D; zwerks<br>                                             zstlancp &#x3D; zstlan<br>                                             zstlalcp &#x3D; zstlal.<br>  IF sy-subrc &#x3D; 0.<br>    LOOP AT gt_stpox INTO gs_stpox WHERE matnrcp &#x3D; zmatnr<br>                                     AND werkscp &#x3D; zwerks<br>                                     AND zstlancp &#x3D; zstlan<br>                                     AND zstlalcp &#x3D; zstlal..<br>      MOVE-CORRESPONDING gs_stpox TO s_stb.<br>      APPEND s_stb TO stb.<br>    ENDLOOP.</p>
<p>  ELSE.</p>
<p>*&amp;—查询物料此版本展开的BOM<br>    CALL FUNCTION ‘CS_BOM_EXPL_MAT_V2’<br>      EXPORTING<br>        capid                 &#x3D; ‘PP01’<br>        datuv                 &#x3D; sy-datum<br>        emeng                 &#x3D; 10000<br>        mktls                 &#x3D; ‘X’<br>        mdmps                 &#x3D; ‘X’<br>        mehrs                 &#x3D; ‘X’<br>        mtnrv                 &#x3D; zmatnr<br>        postp                 &#x3D; ‘L’<br>        stlal                 &#x3D; zstlal<br>        stlan                 &#x3D; zstlan<br>        stpst                 &#x3D; 0<br>        svwvo                 &#x3D; ‘X’<br>        werks                 &#x3D; zwerks<br>        vrsvo                 &#x3D; ‘X’<br>      TABLES<br>        stb                   &#x3D; stb<br>      EXCEPTIONS<br>        alt_not_found         &#x3D; 1<br>        call_invalid          &#x3D; 2<br>        material_not_found    &#x3D; 3<br>        missing_authorization &#x3D; 4<br>        no_bom_found          &#x3D; 5<br>        no_plant_data         &#x3D; 6<br>        no_suitable_bom_found &#x3D; 7<br>        conversion_error      &#x3D; 8<br>        OTHERS                &#x3D; 9.</p>
<p>*&amp;—将BOM结果存到内表中，便于BOM清单展开组件使用<br>    LOOP  AT stb INTO s_stb WHERE dumps &#x3D; ‘’ AND mschg &lt;&gt; ‘X’.”排除组装物料<br>      MOVE-CORRESPONDING s_stb TO gs_stpox.<br>      gs_stpox-matnrcp  &#x3D; zmatnr.<br>      gs_stpox-zstlalcp &#x3D; zstlal.<br>      gs_stpox-zstlancp &#x3D; zstlan.<br>      gs_stpox-werkscp  &#x3D; zwerks.<br>      APPEND gs_stpox TO gt_stpox.<br>    ENDLOOP.<br>  ENDIF.<br>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_request_f4_dispo<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp;      –&gt; P_<br><em>&amp;———————————————————————</em><br>FORM frm_request_f4_dispo  USING    pv_field TYPE help_info-dynprofld.</p>
<p>  DATA: BEGIN OF ls_value_tab,<br>          werks TYPE t024d-werks,<br>          dispo TYPE t024d-dispo,<br>          dsnam TYPE t024d-dsnam,<br>        END OF ls_value_tab.<br>  DATA: lt_value_tab LIKE TABLE OF ls_value_tab,<br>        lv_werks     TYPE t024d-werks.<br>  DATA dynpfields TYPE TABLE OF dynpread WITH HEADER LINE.</p>
<p>  dynpfields-fieldname &#x3D; ‘S_WERKS-LOW’.</p>
<p>  APPEND dynpfields.<br>  CLEAR lv_werks.<br>  CALL FUNCTION ‘DYNP_VALUES_READ’<br>    EXPORTING<br>      dyname               &#x3D; sy-cprog<br>      dynumb               &#x3D; sy-dynnr</p>
<ul>
<li><pre><code>TRANSLATE_TO_UPPER   = &#39; &#39;
</code></pre>
</li>
<li><pre><code>REQUEST              = &#39; &#39;
</code></pre>
</li>
<li><pre><code>PERFORM_CONVERSION_EXITS             = &#39; &#39;
</code></pre>
</li>
<li><pre><code>PERFORM_INPUT_CONVERSION             = &#39; &#39;
</code></pre>
</li>
<li><pre><code>DETERMINE_LOOP_INDEX = &#39; &#39;
</code></pre>
</li>
<li><pre><code>START_SEARCH_IN_CURRENT_SCREEN       = &#39; &#39;
</code></pre>
</li>
<li><pre><code>START_SEARCH_IN_MAIN_SCREEN          = &#39; &#39;
</code></pre>
</li>
<li><pre><code>START_SEARCH_IN_STACKED_SCREEN       = &#39; &#39;
</code></pre>
</li>
<li><pre><code>START_SEARCH_ON_SCR_STACKPOS         = &#39; &#39;
</code></pre>
</li>
<li><pre><code>SEARCH_OWN_SUBSCREENS_FIRST          = &#39; &#39;
</code></pre>
</li>
<li><pre><code>SEARCHPATH_OF_SUBSCREEN_AREAS        = &#39; &#39;
</code></pre>
<p>  TABLES<br>dynpfields           &#x3D; dynpfields<br>  EXCEPTIONS<br>invalid_abapworkarea &#x3D; 1<br>invalid_dynprofield  &#x3D; 2<br>invalid_dynproname   &#x3D; 3<br>invalid_dynpronummer &#x3D; 4<br>invalid_request      &#x3D; 5<br>no_fielddescription  &#x3D; 6<br>invalid_parameter    &#x3D; 7<br>undefind_error       &#x3D; 8<br>double_conversion    &#x3D; 9<br>stepl_not_found      &#x3D; 10<br>OTHERS               &#x3D; 11.<br>IF sy-subrc EQ 0.<br>  READ TABLE dynpfields WITH KEY ‘S_WERKS-LOW’.<br>  IF sy-subrc &#x3D; 0.<br>lv_werks  &#x3D; dynpfields-fieldvalue.<br>  ENDIF.<br>ELSE.</p>
</li>
<li><p>Implement suitable error handling here<br>ENDIF.</p>
<p>IF lv_werks IS INITIAL.<br>  MESSAGE ‘请填写工厂的选择条件!’ TYPE ‘E’.<br>ENDIF.<br>CLEAR : lt_value_tab[].<br>SELECT DISTINCT t024d<del>werks,t024d</del>dispo,t024d~dsnam FROM t024d WHERE werks &#x3D; @lv_werks INTO CORRESPONDING FIELDS OF TABLE @lt_value_tab.</p>
<p>LOOP AT lt_value_tab INTO ls_value_tab.<br>  AUTHORITY-CHECK OBJECT ‘ZPP_DISPO’<br>  ID ‘WERKS’ FIELD ls_value_tab-werks<br>  ID ‘DISPO’ FIELD ls_value_tab-dispo.<br>  IF sy-subrc &lt;&gt; 0.<br>DELETE lt_value_tab.<br>  ENDIF.<br>ENDLOOP.</p>
<p>CALL FUNCTION ‘F4IF_INT_TABLE_VALUE_REQUEST’<br>  EXPORTING</p>
</li>
<li><pre><code>DDIC_STRUCTURE  = &#39; &#39;
retfield        = &#39;DISPO&#39;
</code></pre>
</li>
<li><pre><code>PVALKEY         = &#39; &#39;
dynpprog        = sy-repid
dynpnr          = sy-dynnr
dynprofield     = pv_field
</code></pre>
</li>
<li><pre><code>STEPL           = 0
</code></pre>
</li>
<li><pre><code>WINDOW_TITLE    =
</code></pre>
</li>
<li><pre><code>VALUE           = &#39; &#39;
value_org       = &#39;S&#39;
</code></pre>
</li>
<li><pre><code>MULTIPLE_CHOICE = &#39; &#39;
</code></pre>
</li>
<li><pre><code>DISPLAY         = &#39; &#39;
</code></pre>
</li>
<li><pre><code>CALLBACK_PROGRAM       = &#39; &#39;
</code></pre>
</li>
<li><pre><code>CALLBACK_FORM   = &#39; &#39;
</code></pre>
</li>
<li><pre><code>CALLBACK_METHOD =
</code></pre>
</li>
<li><pre><code>MARK_TAB        =
</code></pre>
</li>
<li><p>IMPORTING</p>
</li>
<li><pre><code>USER_RESET      =
</code></pre>
<p>  TABLES<br>value_tab       &#x3D; lt_value_tab[]</p>
</li>
<li><pre><code>FIELD_TAB       =
</code></pre>
</li>
<li><pre><code>RETURN_TAB      =
</code></pre>
</li>
<li><pre><code>DYNPFLD_MAPPING =
</code></pre>
<p>  EXCEPTIONS<br>parameter_error &#x3D; 1<br>no_values_found &#x3D; 2<br>OTHERS          &#x3D; 3.<br>IF sy-subrc &lt;&gt; 0.</p>
</li>
<li><p>Implement suitable error handling here<br>ENDIF.</p>
</li>
</ul>
<p>ENDFORM.<br><em>&amp;———————————————————————</em><br>*&amp; Form frm_check<br><em>&amp;———————————————————————</em><br>*&amp; text<br><em>&amp;———————————————————————</em><br>*&amp; –&gt;  p1        text<br>*&amp; &lt;–  p2        text<br>*&amp;———————————————————————*<br>FORM frm_check .<br>  “从t024d 中 找出 所有满足现在s_dispo的数据<br>  DATA: BEGIN OF ty_dispo,<br>          werks TYPE t024d-werks,<br>          dispo TYPE t024d-dispo,<br>        END OF ty_dispo.<br>  DATA: lt_dispo LIKE TABLE OF ty_dispo.<br>  CLEAR: lt_dispo[],gt_dispo[].<br>  SELECT werks,dispo FROM t024d WHERE werks IN @s_werks AND dispo IN @s_dispo INTO CORRESPONDING FIELDS OF TABLE @lt_dispo.<br>  “将满足s_dispo但是不符合zpp_dispo权限的数据从内表中删除<br>  LOOP AT lt_dispo INTO DATA(ls_dispo).<br>    AUTHORITY-CHECK OBJECT ‘ZPP_DISPO’<br>    ID ‘WERKS’ FIELD ls_dispo-werks<br>    ID ‘DISPO’ FIELD ls_dispo-dispo.<br>    IF sy-subrc &lt;&gt; 0.<br>      DELETE lt_dispo.<br>    ENDIF.<br>  ENDLOOP.<br>  “将现在的内表数据赋值给gt_dispo  此时 gt_dispo的所有数据满足要求<br>  LOOP AT lt_dispo INTO ls_dispo.<br>    CLEAR lw_dispo.<br>    lw_dispo-sign &#x3D; ‘I’.<br>    lw_dispo-option &#x3D; ‘EQ’.<br>    lw_dispo-low &#x3D; ls_dispo-dispo.<br>    APPEND lw_dispo TO gt_dispo.<br>  ENDLOOP.</p>
<p>ENDFORM.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/02/13/my-first-blog/">http://example.com/2023/02/13/my-first-blog/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/02/11/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Hello World</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/13/my-first-blog/" title="my-first-blog">my-first-blog</a><time datetime="2023-02-13T05:58:08.000Z" title="Created 2023-02-13 13:58:08">2023-02-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/11/hello-world/" title="Hello World">Hello World</a><time datetime="2023-02-11T08:03:56.684Z" title="Created 2023-02-11 16:03:56">2023-02-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>